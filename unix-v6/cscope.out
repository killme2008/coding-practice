cscope 15 $HOME/programming/c/unix-v6               0000148770
	@buf.h

21 
	sbuf


23 
	mb_Êags
;

24 
buf
 *
	mb_f‹w
;

25 
buf
 *
	mb_back
;

26 
buf
 *
	mav_f‹w
;

27 
buf
 *
	mav_back
;

28 
	mb_dev
;

29 
	mb_wcou¡
;

30 *
	mb_addr
;

31 *
	mb_xmem
;

32 *
	mb_blkno
;

33 
	mb_îr‹
;

34 *
	mb_ªsid
;

35 } 
	gbuf
[
NBUF
];

48 
	sdevèb


50 
	md_a˘ive
;

51 
	md_îr˙t
;

52 
buf
 *
	mb_f‹w
;

53 
buf
 *
	mb_back
;

54 
buf
 *
	md_a˘f
;

55 
buf
 *
	md_a˘l
;

62 
buf
 
	gb‰ìli°
;

67 
	#B_WRITE
 0

	)

68 
	#B_READ
 01

	)

69 
	#B_DONE
 02

	)

70 
	#B_ERROR
 04

	)

71 
	#B_BUSY
 010

	)

72 
	#B_PHYS
 020

	)

73 
	#B_MAP
 040

	)

74 
	#B_WANTED
 0100

	)

75 
	#B_RELOC
 0200

	)

76 
	#B_ASYNC
 0400

	)

77 
	#B_DELWRI
 01000

	)

	@conf.h

8 
	md_mö‹
;

9 
	md_maj‹
;

21 
	sbdevsw


23 (*
	md_›í
)();

24 (*
	md_˛o£
)();

25 (*
	md_°øãgy
)();

26 *
	md_èb
;

27 } 
	gbdevsw
[];

37 
	gnblkdev
;

42 
	scdevsw


44 (*
	md_›í
)();

45 (*
	md_˛o£
)();

46 (*
	md_ªad
)();

47 (*
	md_wrôe
)();

48 (*
	md_sgây
)();

49 } 
	gcdevsw
[];

55 
	gnchrdev
;

	@conf/mkconf.c

1 
	#CHAR
 01

	)

2 
	#BLOCK
 02

	)

3 
	#INTR
 04

	)

4 
	#EVEN
 010

	)

5 
	#KL
 020

	)

6 
	#ROOT
 040

	)

7 *
	gbèb
[]

19 *
	g˘ab
[]

39 
	sèb


41 *
	m«me
;

42 
	mcou¡
;

43 
	maddªss
;

44 
	mkey
;

45 *
	mcodó
;

46 *
	mcodeb
;

47 *
	mcodec
;

48 *
	mcoded
;

49 *
	mcodì
;

50 } 
	gèbÀ
[]

53 -1, 60, 
	gCHAR
+
	gINTR
+
	gKL
,

61 -1, 300, 
	gCHAR
,

69 0, 70, 
	gCHAR
+
	gINTR
,

77 -2, 100, 
	gINTR
,

85 -1, 114, 
	gINTR
,

105 0, 200, 
	gCHAR
+
	gINTR
,

113 0, 204, 
	gBLOCK
+
	gCHAR
+
	gINTR
,

121 0, 204, 
	gBLOCK
+
	gCHAR
+
	gINTR
,

133 0, 214, 
	gBLOCK
+
	gINTR
,

141 0, 220, 
	gBLOCK
+
	gCHAR
+
	gINTR
,

149 0, 224, 
	gBLOCK
+
	gCHAR
+
	gINTR
,

157 0, 224, 
	gBLOCK
+
	gCHAR
+
	gINTR
,

165 0, 230, 
	gCHAR
+
	gINTR
,

177 0, 254, 
	gBLOCK
+
	gCHAR
+
	gINTR
,

185 0, 254, 
	gBLOCK
+
	gCHAR
+
	gINTR
,

198 0, 308, 
	gCHAR
+
	gINTR
,

206 0, 308, 
	gINTR
+
	gKL
,

214 0, 308, 
	gCHAR
+
	gINTR
,

226 0, 304, 
	gCHAR
+
	gINTR
,

234 0, 304, 
	gINTR
,

251 0, 308, 
	gINTR
+
	gKL
,

263 0, 308, 
	gCHAR
+
	gINTR
+
	gEVEN
,

279 *
	g°ø
[]

309 *
	g°rb
[]

319 *
	g°rc
[]

327 *
	g°rd
[]

338 *
	g°ª
[]

348 *
	g°rf
[]

358 *
	g°rg
[]

370 
	gfout
;

371 
	groŸ
 -1;

373 
	$maö
()

375 
èb
 *
p
;

376 *
q
;

377 
i
, 
n
, 
ev
, 
nkl
;

378 
Êagf
, 
Êagb
;

380 
	`öput
());

385 
nkl
 = 0;

386 
Êagf
 = 
Êagb
 = 1;

387 
fout
 = 
	`¸ót
("l.s", 0666);

388 
	`puke
(
°ø
);

389 
p
=
èbÀ
;Ö->
«me
;Ö++)

390 if(
p
->
cou¡
 !0 &&Ö->
key
 & 
INTR
) {

391 if(
p
->
addªss
>240 && 
Êagb
) {

392 
Êagb
 = 0;

393 
	`puke
(
°rb
);

395 if(
p
->
addªss
 >= 300) {

396 if(
Êagf
) {

397 
ev
 = 0;

398 
Êagf
 = 0;

399 
	`puke
(
°rc
);

401 if(
p
->
key
 & 
EVEN
 && 
ev
 & 07) {

402 
	`¥ötf
("\t.=.+4\n");

403 
ev
 =+ 4;

405 
ev
 =+ 
p
->
addªss
 - 300;

407 
	`¥ötf
("\n. = %d^.\n", 
p
->
addªss
);

408 
n
 = 
p
->
cou¡
;

409 if(
n
 < 0)

410 
n
 = -n;

411 
i
=0; i<
n
; i++)

412 if(
p
->
key
 & 
KL
) {

413 
	`¥ötf
(
p
->
codó
, 
nkl
,Çkl);

414 
nkl
++;

416 
	`¥ötf
(
p
->
codó
, 
i
, i);

418 if(
Êagb
)

419 
	`puke
(
°rb
);

420 
	`puke
(
°rd
);

421 
p
=
èbÀ
;Ö->
«me
;Ö++)

422 if(
p
->
cou¡
 !0 &&Ö->
key
 & 
INTR
)

423 
	`¥ötf
("\n%s%s", 
p
->
codeb
,Ö->
codec
);

424 
	`Êush
();

425 
	`˛o£
(
fout
);

431 
fout
 = 
	`¸ót
("c.c", 0666);

432 
	`puke
(
°ª
);

433 
i
=0; 
q
=
bèb
[i]; i++) {

434 
p
=
èbÀ
;Ö->
«me
;Ö++)

435 if(
	`equÆ
(
q
, 
p
->
«me
) &&

436 (
p
->
key
&
BLOCK
Ë&&Ö->
cou¡
) {

437 
	`¥ötf
("%s\t/* %†*/\n", 
p
->
coded
, 
q
);

438 if(
p
->
key
 & 
ROOT
)

439 
roŸ
 = 
i
;

440 
√wb
;

442 
	`¥ötf
("\t&nodev,\t\t&nodev,\t\t&nodev,\t\t0,\t/* %†*/\n", 
q
);

443 
√wb
:;

445 
	`puke
(
°rf
);

446 
i
=0; 
q
=
˘ab
[i]; i++) {

447 
p
=
èbÀ
;Ö->
«me
;Ö++)

448 if(
	`equÆ
(
q
, 
p
->
«me
) &&

449 (
p
->
key
&
CHAR
Ë&&Ö->
cou¡
) {

450 
	`¥ötf
("%s\t/* %†*/\n", 
p
->
codì
, 
q
);

451 
√wc
;

453 
	`¥ötf
("\t&nodev, &nodev, &nodev, &nodev, &nodev,\t/* %†*/\n", 
q
);

454 
√wc
:;

456 
	`puke
(
°rg
, 
roŸ
);

457 
	`Êush
();

458 
	`˛o£
(
fout
);

459 if(
roŸ
 < 0)

460 
	`wrôe
(2, "no block device given\n", 22);

461 
	}
}

463 
	$puke
(
s
, 
a
)

464 **
s
;

466 *
c
;

468 
c
 = *
s
++) {

469 
	`¥ötf
(
c
, 
a
);

470 
	`¥ötf
("\n");

472 
	}
}

474 
	$öput
()

476 
löe
[100];

477 *
p
;

478 
èb
 *
q
;

479 
n
;

481 
p
 = 
löe
;

482 (
n
=
	`gëch¨
()) != '\n') {

483 if(
n
 == 0)

485 if(
n
 == ' ' ||Ç == '\t')

487 *
p
++ = 
n
;

489 *
p
++ = 0;

490 
n
 = 0;

491 
p
 = 
löe
;

492 *
p
>='0' && *p<='9') {

493 
n
 =* 10;

494 
n
 =+ *
p
++ - '0';

496 if(
n
 == 0)

497 
n
 = 1;

498 if(*
p
 == 0)

500 
q
=
èbÀ
; q->
«me
; q++)

501 if(
	`equÆ
(
q
->
«me
, 
p
)) {

502 if(
roŸ
 < 0 && (
q
->
key
&
BLOCK
)) {

503 
roŸ
 = 0;

504 
q
->
key
 =| 
ROOT
;

506 if(
q
->
cou¡
 < 0) {

507 
	`¥ötf
("%s:Çÿm‹e,ÇÿÀss\n", 
p
);

510 
q
->
cou¡
 =+ 
n
;

511 if(
q
->
addªss
 < 300 && q->
cou¡
 > 1) {

512 
q
->
cou¡
 = 1;

513 
	`¥ötf
("%s: o∆y o√\n", 
p
);

517 if(
	`equÆ
(
p
, "done"))

519 
	`¥ötf
("%s: c™nŸ föd\n", 
p
);

521 
	}
}

523 
	$equÆ
(
a
, 
b
)

524 *
a
, *
b
;

527 *
a
++ =*
b
)

528 if(*
b
++ == 0)

531 
	}
}

533 
	$gëch¨
()

535 
c
;

537 
c
 = 0;

538 
	`ªad
(0, &
c
, 1);

539 (
c
);

540 
	}
}

	@conf/sysfix.c

8 
	gtbuf
[259];

9 
	grbuf
[259];

10 
	gobuf
[259];

11 
	gtxtsiz
;

12 
	gd©siz
;

13 
	gbsssiz
;

14 
	gsymsiz
;

16 
	gtxåñ
 8192;

17 
	gd©ªl
;

20 
	$maö
(
¨gc
, 
¨gv
)

21 **
¨gv
;

23 
w‹d
, 
ªl
, 
s
;

25 i‡(
¨gc
<3) {

26 
	`¥ötf
("Arg count\n");

27 
	`exô
(1);

29 i‡((
tbuf
[0] = 
	`›í
(
¨gv
[1], 0)) < 0) {

30 
	`¥ötf
("Input file\n");

31 
	`exô
(1);

33 
rbuf
[0] = 
	`›í
(
¨gv
[1], 0);

34 i‡((
	`f¸ót
(
¨gv
[2], 
obuf
)) < 0) {

35 
	`¥ötf
("Output file\n");

36 
	`exô
(1);

38 i‡(
	`gëw
(
tbuf
) != 0407) {

39 
	`¥ötf
("Bad input format\n");

40 
	`exô
(1);

42 
	`putw
(0407, 
obuf
);

43 
txtsiz
 = 
	`gëw
(
tbuf
);

44 
d©siz
 = 
	`gëw
(
tbuf
);

45 
bsssiz
 = 
	`gëw
(
tbuf
);

46 
symsiz
 = 
	`gëw
(
tbuf
);

47 
	`gëw
(
tbuf
);

48 
	`gëw
(
tbuf
);

49 i‡(
	`gëw
(
tbuf
) != 0) {

50 
	`¥ötf
("NoÑelocation bits\n");

51 
	`exô
(1);

53 
	`putw
(
txtsiz
, 
obuf
);

54 
	`putw
(
d©siz
, 
obuf
);

55 
	`putw
(
bsssiz
, 
obuf
);

56 
	`putw
(
symsiz
, 
obuf
);

57 
	`putw
(0, 
obuf
);

58 
	`putw
(0, 
obuf
);

59 
	`putw
(1, 
obuf
);

60 
d©ªl
 = -
txtsiz
;

64 
tbuf
[1] = 0;

65 
	`£ek
(
tbuf
[0], 020+
txtsiz
, 0);

66 
	`£ek
(
rbuf
[0], 020+
txtsiz
, 0);

67 
	`£ek
(
rbuf
[0], 
txtsiz
, 1);

68 
	`£ek
(
rbuf
[0], 
d©siz
, 1);

69 
s
 = 
d©siz
 >> 1;

70 
s
--) {

71 
w‹d
 = 
	`gëw
(
tbuf
);

72 
ªl
 = 
	`gëw
(
rbuf
);

73 i‡(
ªl
&01)

74 
w‹d
 =- 
d©ªl
;

75 
w‹d
 =+ 
	`gëªl
(
ªl
);

76 
	`putw
(
w‹d
, 
obuf
);

81 
rbuf
[1] = 0;

82 
tbuf
[1] = 0;

83 
	`£ek
(
rbuf
[0], 020+
txtsiz
, 0);

84 
	`£ek
(
rbuf
[0], 
d©siz
, 1);

85 
	`£ek
(
tbuf
[0], 020, 0);

86 
s
 = 
txtsiz
 >> 1;

87 
s
--) {

88 
ªl
 = 
	`gëw
(
rbuf
);

89 
w‹d
 = 
	`gëw
(
tbuf
);

90 i‡(
ªl
&01)

91 
w‹d
 =- 
txåñ
;

92 
w‹d
 =+ 
	`gëªl
(
ªl
);

93 
	`putw
(
w‹d
, 
obuf
);

98 
tbuf
[1] = 0;

99 
	`£ek
(
tbuf
[0], 020+
txtsiz
, 0);

100 
	`£ek
(
tbuf
[0], 
txtsiz
, 1);

101 
	`£ek
(
tbuf
[0], 
d©siz
, 1);

102 
	`£ek
(
tbuf
[0], 
d©siz
, 1);

103 
s
 = 
symsiz
;

104 (
s
 =- 12) >= 0) {

105 
	`putw
(
	`gëw
(
tbuf
), 
obuf
);

106 
	`putw
(
	`gëw
(
tbuf
), 
obuf
);

107 
	`putw
(
	`gëw
(
tbuf
), 
obuf
);

108 
	`putw
(
	`gëw
(
tbuf
), 
obuf
);

109 
ªl
 = 
	`gëw
(
tbuf
);

110 
	`putw
(
ªl
, 
obuf
);

111 
w‹d
 = 
	`gëw
(
tbuf
);

112 
ªl
&07) {

114 
w‹d
 =+ 
txåñ
;

119 
w‹d
 =+ 
d©ªl
;

121 
	`putw
(
w‹d
, 
obuf
);

123 
	`fÊush
(
obuf
);

124 
	`˛o£
(
obuf
[0]);

125 
	`exô
(0);

126 
	}
}

128 
	$gëªl
(
r
)

130 
r
&016) {

133 (
txåñ
);

137 (
d©ªl
);

143 
	`¥ötf
("BadÑñoˇti⁄ %o\n", 
r
);

146 
	}
}

	@dmr/bio.c

5 
	~"../∑øm.h
"

6 
	~"../u£r.h
"

7 
	~"../buf.h
"

8 
	~"../c⁄f.h
"

9 
	~"../sy°m.h
"

10 
	~"../¥oc.h
"

11 
	~"../£g.h
"

21 
	gbuf„rs
[
NBUF
][514];

22 
buf
 
	gswbuf
;

28 
	gtmèb
;

29 
	ghâab
;

55 
	$bªad
(
dev
, 
blkno
)

57 
buf
 *
rbp
;

59 
rbp
 = 
	`gëblk
(
dev
, 
blkno
);

60 i‡(
rbp
->
b_Êags
&
B_DONE
)

61 (
rbp
);

62 
rbp
->
b_Êags
 =| 
B_READ
;

63 
rbp
->
b_wcou¡
 = -256;

64 (*
bdevsw
[
dev
.
d_maj‹
].
d_°øãgy
)(
rbp
);

65 
	`iowaô
(
rbp
);

66 (
rbp
);

67 
	}
}

73 
	$bªada
(
adev
, 
blkno
, 
øblkno
)

75 
buf
 *
rbp
, *
øbp
;

76 
dev
;

78 
dev
 = 
adev
;

79 
rbp
 = 0;

80 i‡(!
	`öc‹e
(
dev
, 
blkno
)) {

81 
rbp
 = 
	`gëblk
(
dev
, 
blkno
);

82 i‡((
rbp
->
b_Êags
&
B_DONE
) == 0) {

83 
rbp
->
b_Êags
 =| 
B_READ
;

84 
rbp
->
b_wcou¡
 = -256;

85 (*
bdevsw
[
adev
.
d_maj‹
].
d_°øãgy
)(
rbp
);

88 i‡(
øblkno
 && !
	`öc‹e
(
dev
,Ñablkno)) {

89 
øbp
 = 
	`gëblk
(
dev
, 
øblkno
);

90 i‡(
øbp
->
b_Êags
 & 
B_DONE
)

91 
	`bªl£
(
øbp
);

93 
øbp
->
b_Êags
 =| 
B_READ
|
B_ASYNC
;

94 
øbp
->
b_wcou¡
 = -256;

95 (*
bdevsw
[
adev
.
d_maj‹
].
d_°øãgy
)(
øbp
);

98 i‡(
rbp
==0)

99 (
	`bªad
(
dev
, 
blkno
));

100 
	`iowaô
(
rbp
);

101 (
rbp
);

102 
	}
}

108 
	$bwrôe
(
bp
)

109 
buf
 *
bp
;

111 
buf
 *
rbp
;

112 
Êag
;

114 
rbp
 = 
bp
;

115 
Êag
 = 
rbp
->
b_Êags
;

116 
rbp
->
b_Êags
 =& ~(
B_READ
 | 
B_DONE
 | 
B_ERROR
 | 
B_DELWRI
);

117 
rbp
->
b_wcou¡
 = -256;

118 (*
bdevsw
[
rbp
->
b_dev
.
d_maj‹
].
d_°øãgy
)(rbp);

119 i‡((
Êag
&
B_ASYNC
) == 0) {

120 
	`iowaô
(
rbp
);

121 
	`bªl£
(
rbp
);

122 } i‡((
Êag
&
B_DELWRI
)==0)

123 
	`gëîr‹
(
rbp
);

124 
	}
}

134 
	$bdwrôe
(
bp
)

135 
buf
 *
bp
;

137 
buf
 *
rbp
;

138 
devèb
 *
dp
;

140 
rbp
 = 
bp
;

141 
dp
 = 
bdevsw
[
rbp
->
b_dev
.
d_maj‹
].
d_èb
;

142 i‡(
dp
 =&
tmèb
 || d∞=&
hâab
)

143 
	`bawrôe
(
rbp
);

145 
rbp
->
b_Êags
 =| 
B_DELWRI
 | 
B_DONE
;

146 
	`bªl£
(
rbp
);

148 
	}
}

153 
	$bawrôe
(
bp
)

154 
buf
 *
bp
;

156 
buf
 *
rbp
;

158 
rbp
 = 
bp
;

159 
rbp
->
b_Êags
 =| 
B_ASYNC
;

160 
	`bwrôe
(
rbp
);

161 
	}
}

166 
	$bªl£
(
bp
)

167 
buf
 *
bp
;

169 
buf
 *
rbp
, **
backp
;

170 
•s
;

172 
rbp
 = 
bp
;

173 i‡(
rbp
->
b_Êags
&
B_WANTED
)

174 
	`wakeup
(
rbp
);

175 i‡(
b‰ìli°
.
b_Êags
&
B_WANTED
) {

176 
b‰ìli°
.
b_Êags
 =& ~
B_WANTED
;

177 
	`wakeup
(&
b‰ìli°
);

179 i‡(
rbp
->
b_Êags
&
B_ERROR
)

180 
rbp
->
b_dev
.
d_mö‹
 = -1;

181 
backp
 = &
b‰ìli°
.
av_back
;

182 
•s
 = 
PS
->
öãg
;

183 
	`•l6
();

184 
rbp
->
b_Êags
 =& ~(
B_WANTED
|
B_BUSY
|
B_ASYNC
);

185 (*
backp
)->
av_f‹w
 = 
rbp
;

186 
rbp
->
av_back
 = *
backp
;

187 *
backp
 = 
rbp
;

188 
rbp
->
av_f‹w
 = &
b‰ìli°
;

189 
PS
->
öãg
 = 
•s
;

190 
	}
}

196 
	$öc‹e
(
adev
, 
blkno
)

198 
dev
;

199 
buf
 *
bp
;

200 
devèb
 *
dp
;

202 
dev
 = 
adev
;

203 
dp
 = 
bdevsw
[
adev
.
d_maj‹
].
d_èb
;

204 
bp
=
dp
->
b_f‹w
; bp != dp; bp = bp->b_forw)

205 i‡(
bp
->
b_blkno
==
blkno
 && bp->
b_dev
==
dev
)

206 (
bp
);

208 
	}
}

218 
	$gëblk
(
dev
, 
blkno
)

220 
buf
 *
bp
;

221 
devèb
 *
dp
;

222 
lbﬁt
;

224 if(
dev
.
d_maj‹
 >
nblkdev
)

225 
	`∑nic
("blkdev");

227 
lo›
:

228 i‡(
dev
 < 0)

229 
dp
 = &
b‰ìli°
;

231 
dp
 = 
bdevsw
[
dev
.
d_maj‹
].
d_èb
;

232 if(
dp
 =
NULL
)

233 
	`∑nic
("devtab");

234 
bp
=
dp
->
b_f‹w
; bp != dp; bp = bp->b_forw) {

235 i‡(
bp
->
b_blkno
!=
blkno
 || bp->
b_dev
!=
dev
)

237 
	`•l6
();

238 i‡(
bp
->
b_Êags
&
B_BUSY
) {

239 
bp
->
b_Êags
 =| 
B_WANTED
;

240 
	`¶ìp
(
bp
, 
PRIBIO
);

241 
	`•l0
();

242 
lo›
;

244 
	`•l0
();

245 
	`nŸavaû
(
bp
);

246 (
bp
);

249 
	`•l6
();

250 i‡(
b‰ìli°
.
av_f‹w
 == &bfreelist) {

251 
b‰ìli°
.
b_Êags
 =| 
B_WANTED
;

252 
	`¶ìp
(&
b‰ìli°
, 
PRIBIO
);

253 
	`•l0
();

254 
lo›
;

256 
	`•l0
();

257 
	`nŸavaû
(
bp
 = 
b‰ìli°
.
av_f‹w
);

258 i‡(
bp
->
b_Êags
 & 
B_DELWRI
) {

259 
bp
->
b_Êags
 =| 
B_ASYNC
;

260 
	`bwrôe
(
bp
);

261 
lo›
;

263 
bp
->
b_Êags
 = 
B_BUSY
 | 
B_RELOC
;

264 
bp
->
b_back
->
b_f‹w
 = bp->b_forw;

265 
bp
->
b_f‹w
->
b_back
 = bp->b_back;

266 
bp
->
b_f‹w
 = 
dp
->b_forw;

267 
bp
->
b_back
 = 
dp
;

268 
dp
->
b_f‹w
->
b_back
 = 
bp
;

269 
dp
->
b_f‹w
 = 
bp
;

270 
bp
->
b_dev
 = 
dev
;

271 
bp
->
b_blkno
 = 
blkno
;

272 (
bp
);

273 
	}
}

279 
	$iowaô
(
bp
)

280 
buf
 *
bp
;

282 
buf
 *
rbp
;

284 
rbp
 = 
bp
;

285 
	`•l6
();

286 (
rbp
->
b_Êags
&
B_DONE
)==0)

287 
	`¶ìp
(
rbp
, 
PRIBIO
);

288 
	`•l0
();

289 
	`gëîr‹
(
rbp
);

290 
	}
}

296 
	$nŸavaû
(
bp
)

297 
buf
 *
bp
;

299 
buf
 *
rbp
;

300 
•s
;

302 
rbp
 = 
bp
;

303 
•s
 = 
PS
->
öãg
;

304 
	`•l6
();

305 
rbp
->
av_back
->
av_f‹w
 =Ñbp->av_forw;

306 
rbp
->
av_f‹w
->
av_back
 =Ñbp->av_back;

307 
rbp
->
b_Êags
 =| 
B_BUSY
;

308 
PS
->
öãg
 = 
•s
;

309 
	}
}

315 
	$iod⁄e
(
bp
)

316 
buf
 *
bp
;

318 
buf
 *
rbp
;

320 
rbp
 = 
bp
;

321 if(
rbp
->
b_Êags
&
B_MAP
)

322 
	`m≠‰ì
(
rbp
);

323 
rbp
->
b_Êags
 =| 
B_DONE
;

324 i‡(
rbp
->
b_Êags
&
B_ASYNC
)

325 
	`bªl£
(
rbp
);

327 
rbp
->
b_Êags
 =& ~
B_WANTED
;

328 
	`wakeup
(
rbp
);

330 
	}
}

335 
	$˛rbuf
(
bp
)

336 *
bp
;

338 *
p
;

339 
c
;

341 
p
 = 
bp
->
b_addr
;

342 
c
 = 256;

344 *
p
++ = 0;

345 --
c
);

346 
	}
}

352 
	$böô
()

354 
buf
 *
bp
;

355 
devèb
 *
dp
;

356 
i
;

357 
bdevsw
 *
bdp
;

359 
b‰ìli°
.
b_f‹w
 = b‰ìli°.
b_back
 =

360 
b‰ìli°
.
av_f‹w
 = b‰ìli°.
av_back
 = &bfreelist;

361 
i
=0; i<
NBUF
; i++) {

362 
bp
 = &
buf
[
i
];

363 
bp
->
b_dev
 = -1;

364 
bp
->
b_addr
 = 
buf„rs
[
i
];

365 
bp
->
b_back
 = &
b‰ìli°
;

366 
bp
->
b_f‹w
 = 
b‰ìli°
.b_forw;

367 
b‰ìli°
.
b_f‹w
->
b_back
 = 
bp
;

368 
b‰ìli°
.
b_f‹w
 = 
bp
;

369 
bp
->
b_Êags
 = 
B_BUSY
;

370 
	`bªl£
(
bp
);

372 
i
 = 0;

373 
bdp
 = 
bdevsw
; bdp->
d_›í
; bdp++) {

374 
dp
 = 
bdp
->
d_èb
;

375 if(
dp
) {

376 
dp
->
b_f‹w
 = dp;

377 
dp
->
b_back
 = dp;

379 
i
++;

381 
nblkdev
 = 
i
;

382 
	}
}

389 
	#IENABLE
 0100

	)

390 
	#WCOM
 02

	)

391 
	#RCOM
 04

	)

392 
	#GO
 01

	)

393 
	$dev°¨t
(
bp
, 
devloc
, 
devblk
, 
hbcom
)

394 
buf
 *
bp
;

395 *
devloc
;

397 *
dp
;

398 
buf
 *
rbp
;

399 
com
;

401 
dp
 = 
devloc
;

402 
rbp
 = 
bp
;

403 *
dp
 = 
devblk
;

404 *--
dp
 = 
rbp
->
b_addr
;

405 *--
dp
 = 
rbp
->
b_wcou¡
;

406 
com
 = (
hbcom
<<8Ë| 
IENABLE
 | 
GO
 |

407 ((
rbp
->
b_xmem
 & 03) << 4);

408 i‡(
rbp
->
b_Êags
&
B_READ
)

409 
com
 =| 
RCOM
;

411 
com
 =| 
WCOM
;

412 *--
dp
 = 
com
;

413 
	}
}

418 
	#RHWCOM
 060

	)

419 
	#RHRCOM
 070

	)

421 
	$rh°¨t
(
bp
, 
devloc
, 
devblk
, 
ab´
)

422 
buf
 *
bp
;

423 *
devloc
, *
ab´
;

425 *
dp
;

426 
buf
 *
rbp
;

427 
com
;

429 
dp
 = 
devloc
;

430 
rbp
 = 
bp
;

431 if(
˝uty≥
 == 70)

432 *
ab´
 = 
rbp
->
b_xmem
;

433 *
dp
 = 
devblk
;

434 *--
dp
 = 
rbp
->
b_addr
;

435 *--
dp
 = 
rbp
->
b_wcou¡
;

436 
com
 = 
IENABLE
 | 
GO
 |

437 ((
rbp
->
b_xmem
 & 03) << 8);

438 i‡(
rbp
->
b_Êags
&
B_READ
)

439 
com
 =| 
RHRCOM
; 

440 
com
 =| 
RHWCOM
;

441 *--
dp
 = 
com
;

442 
	}
}

452 
	gm≠lock
;

453 
	$m≠Æloc
(
abp
)

454 
buf
 *
abp
;

456 
i
, 
a
;

457 
buf
 *
bp
;

459 if(
˝uty≥
 != 70)

461 
	`•l6
();

462 
m≠lock
&
B_BUSY
) {

463 
m≠lock
 =| 
B_WANTED
;

464 
	`¶ìp
(&
m≠lock
, 
PSWP
);

466 
m≠lock
 =| 
B_BUSY
;

467 
	`•l0
();

468 
bp
 = 
abp
;

469 
bp
->
b_Êags
 =| 
B_MAP
;

470 
a
 = 
bp
->
b_xmem
;

471 
i
=16; i<32; i=+2)

472 
UBMAP
->
r
[
i
+1] = 
a
;

473 
a
++; 
i
<48; i=+2)

474 
UBMAP
->
r
[
i
+1] = 
a
;

475 
bp
->
b_xmem
 = 1;

476 
	}
}

478 
	$m≠‰ì
(
bp
)

479 
buf
 *
bp
;

482 
bp
->
b_Êags
 =& ~
B_MAP
;

483 if(
m≠lock
&
B_WANTED
)

484 
	`wakeup
(&
m≠lock
);

485 
m≠lock
 = 0;

486 
	}
}

491 
	$sw≠
(
blkno
, 
c‹óddr
, 
cou¡
, 
rdÊg
)

493 *
Â
;

495 
Â
 = &
swbuf
.
b_Êags
;

496 
	`•l6
();

497 *
Â
&
B_BUSY
) {

498 *
Â
 =| 
B_WANTED
;

499 
	`¶ìp
(
Â
, 
PSWP
);

501 *
Â
 = 
B_BUSY
 | 
B_PHYS
 | 
rdÊg
;

502 
swbuf
.
b_dev
 = 
sw≠dev
;

503 
swbuf
.
b_wcou¡
 = - (
cou¡
<<5);

504 
swbuf
.
b_blkno
 = 
blkno
;

505 
swbuf
.
b_addr
 = 
c‹óddr
<<6;

506 
swbuf
.
b_xmem
 = (
c‹óddr
>>10) & 077;

507 (*
bdevsw
[
sw≠dev
>>8].
d_°øãgy
)(&
swbuf
);

508 
	`•l6
();

509 (*
Â
&
B_DONE
)==0)

510 
	`¶ìp
(
Â
, 
PSWP
);

511 i‡(*
Â
&
B_WANTED
)

512 
	`wakeup
(
Â
);

513 
	`•l0
();

514 *
Â
 =& ~(
B_BUSY
|
B_WANTED
);

515 (*
Â
&
B_ERROR
);

516 
	}
}

524 
	$bÊush
(
dev
)

526 
buf
 *
bp
;

528 
lo›
:

529 
	`•l6
();

530 
bp
 = 
b‰ìli°
.
av_f‹w
; bp != &bfreelist; bp = bp->av_forw) {

531 i‡(
bp
->
b_Êags
&
B_DELWRI
 && (
dev
 =
NODEV
||dev==bp->
b_dev
)) {

532 
bp
->
b_Êags
 =| 
B_ASYNC
;

533 
	`nŸavaû
(
bp
);

534 
	`bwrôe
(
bp
);

535 
lo›
;

538 
	`•l0
();

539 
	}
}

551 
	$physio
(
°øt
, 
abp
, 
dev
, 
rw
)

552 
buf
 *
abp
;

553 (*
°øt
)();

555 
buf
 *
bp
;

556 *
ba£
;

557 
nb
;

558 
ts
;

560 
bp
 = 
abp
;

561 
ba£
 = 
u
.
u_ba£
;

565 i‡(
ba£
&01 || 
u
.
u_cou¡
&01 || base>=base+u.u_count)

566 
bad
;

567 
ts
 = (
u
.
u_tsize
+127) & ~0177;

568 i‡(
u
.
u_£p
)

569 
ts
 = 0;

570 
nb
 = (
ba£
>>6) & 01777;

575 i‡(
nb
 < 
ts
)

576 
bad
;

583 i‡((((
ba£
+
u
.
u_cou¡
)>>6)&01777Ë>
ts
+u.
u_dsize


584 && 
nb
 < 1024-
u
.
u_ssize
)

585 
bad
;

586 
	`•l6
();

587 
bp
->
b_Êags
&
B_BUSY
) {

588 
bp
->
b_Êags
 =| 
B_WANTED
;

589 
	`¶ìp
(
bp
, 
PRIBIO
);

591 
bp
->
b_Êags
 = 
B_BUSY
 | 
B_PHYS
 | 
rw
;

592 
bp
->
b_dev
 = 
dev
;

597 
bp
->
b_addr
 = 
ba£
&077;

598 
ba£
 = (
u
.
u_£p
? 
UDSA
: 
UISA
)->
r
[
nb
>>7] + (nb&0177);

599 
bp
->
b_addr
 =+ 
ba£
<<6;

600 
bp
->
b_xmem
 = (
ba£
>>10) & 077;

601 
bp
->
b_blkno
 = 
	`lshi·
(
u
.
u_off£t
, -9);

602 
bp
->
b_wcou¡
 = -((
u
.
u_cou¡
>>1) & 077777);

603 
bp
->
b_îr‹
 = 0;

604 
u
.
u_¥o˝
->
p_Êag
 =| 
SLOCK
;

605 (*
°øt
)(
bp
);

606 
	`•l6
();

607 (
bp
->
b_Êags
&
B_DONE
) == 0)

608 
	`¶ìp
(
bp
, 
PRIBIO
);

609 
u
.
u_¥o˝
->
p_Êag
 =& ~
SLOCK
;

610 i‡(
bp
->
b_Êags
&
B_WANTED
)

611 
	`wakeup
(
bp
);

612 
	`•l0
();

613 
bp
->
b_Êags
 =& ~(
B_BUSY
|
B_WANTED
);

614 
u
.
u_cou¡
 = (-
bp
->
b_ªsid
)<<1;

615 
	`gëîr‹
(
bp
);

617 
bad
:

618 
u
.
u_îr‹
 = 
EFAULT
;

619 
	}
}

627 
	$gëîr‹
(
abp
)

628 
buf
 *
abp
;

630 
buf
 *
bp
;

632 
bp
 = 
abp
;

633 i‡(
bp
->
b_Êags
&
B_ERROR
)

634 i‡((
u
.
u_îr‹
 = 
bp
->
b_îr‹
)==0)

635 
u
.
u_îr‹
 = 
EIO
;

636 
	}
}

	@dmr/cat.c

9 
	~"../∑øm.h
"

10 
	~"../u£r.h
"

11 
	~"../ây.h
"

13 
	#CATADDR
 0167750

	)

14 
	#PCAT
 9

	)

15 
	#CATHIWAT
 60

	)

16 
	#CATLOWAT
 15

	)

19 
	mˇéock
;

20 
˛i°
 
	moq
;

21 } 
	gˇt
;

24 
	mˇtc§
;

25 
	mˇtbuf
;

28 
	$˘›í
(
dev
)

30 i‡(
ˇt
.
ˇéock
==0) {

31 
ˇt
.
ˇéock
++;

32 
CATADDR
->
ˇtc§
 =| 
IENABLE
;

34 
u
.
u_îr‹
 = 
ENXIO
;

35 
	}
}

37 
	$˘˛o£
()

39 
ˇt
.
ˇéock
 = 0;

40 
	}
}

42 
	$˘wrôe
(
dev
)

44 
c
;

45 
lbﬁt
;

47 (
c
=
	`˝ass
()) >= 0) {

48 
	`•l5
();

49 
ˇt
.
oq
.
c_cc
 > 
CATHIWAT
)

50 
	`¶ìp
(&
ˇt
.
oq
, 
PCAT
);

51 
	`putc
(
c
, &
ˇt
.
oq
) < 0)

52 
	`¶ìp
(&
lbﬁt
, 
PCAT
);

53 
	`ˇtöå
();

54 
	`•l0
();

56 
	}
}

58 
	$ˇtöå
()

60 
c
;

62 i‡(
CATADDR
->
ˇtc§
&
DONE
 && (
c
=
	`gëc
(&
ˇt
.
oq
))>=0) {

63 
CATADDR
->
ˇtbuf
 = 
c
;

64 i‡(
ˇt
.
oq
.
c_cc
==0 || c©.oq.c_cc==
CATLOWAT
)

65 
	`wakeup
(&
ˇt
.
oq
);

67 i‡(
ˇt
.
ˇéock
==0)

68 
CATADDR
->
ˇtc§
 = 0;

70 
	}
}

	@dmr/dc.c

8 
	~"../∑øm.h
"

9 
	~"../c⁄f.h
"

10 
	~"../u£r.h
"

11 
	~"../ây.h
"

12 
	~"../¥oc.h
"

18 
	#DCADDR
 0174000

	)

23 
	#NDC11
 14

	)

28 
	#CDLEAD
 01

	)

29 
	#CARRIER
 04

	)

30 
	#SPEED1
 010

	)

31 
	#STOP1
 0400

	)

32 
	#RQSEND
 01

	)

33 
	#PARITY
 040

	)

34 
	#ERROR
 0100000

	)

35 
	#CTRANS
 040000

	)

36 
	#RINGIND
 020000

	)

39 
ây
 
	gdc11
[
NDC11
];

41 
	sd¸egs
 {

42 
	md¸c§
;

43 
	md¸buf
;

44 
	md˘c§
;

45 
	md˘buf
;

55 
	gd¸°ab
[] {

77 
	gd˘°ab
[] {

103 
	$dc›í
(
dev
, 
Êag
)

105 
ây
 *
πp
;

106 *
addr
;

108 i‡(
dev
.
d_mö‹
 >
NDC11
) {

109 
u
.
u_îr‹
 = 
ENXIO
;

112 
πp
 = &
dc11
[
dev
.
d_mö‹
];

113 
πp
->
t_addr
 = 
addr
 = 
DCADDR
 + 
dev
.
d_mö‹
*8;

114 
πp
->
t_°©e
 =| 
WOPEN
;

115 
addr
->
d¸c§
 =| 
IENABLE
|
CDLEAD
;

116 i‡((
πp
->
t_°©e
&
ISOPEN
) == 0) {

117 
πp
->
t_îa£
 = 
CERASE
;

118 
πp
->
t_kûl
 = 
CKILL
;

119 
addr
->
d¸c§
 = 
IENABLE
|
CDLEAD
|
SPEED1
;

120 
addr
->
d˘c§
 = 
IENABLE
|
SPEED1
|
STOP1
|
RQSEND
;

121 
πp
->
t_°©e
 = 
ISOPEN
 | 
WOPEN
;

122 
πp
->
t_Êags
 = 
ODDP
|
EVENP
|
ECHO
;

124 i‡(
addr
->
d¸c§
 & 
CARRIER
)

125 
πp
->
t_°©e
 =| 
CARR_ON
;

126 (
πp
->
t_°©e
 & 
CARR_ON
) == 0)

127 
	`¶ìp
(&
πp
->
t_øwq
, 
TTIPRI
);

128 
πp
->
t_°©e
 =& ~
WOPEN
;

129 i‡(
u
.
u_¥o˝
->
p_âyp
 == 0) {

130 
u
.
u_¥o˝
->
p_âyp
 = 
πp
;

131 
πp
->
t_dev
 = 
dev
;

133 
	}
}

138 
	$dc˛o£
(
dev
)

140 
ây
 *
ç
;

142 (
ç
 = &
dc11
[
dev
.
d_mö‹
])->
t_°©e
 = 0;

143 i‡(
ç
->
t_Êags
&
HUPCL
)

144 
ç
->
t_addr
->
d¸c§
 =& ~
CDLEAD
;

145 
	`wÊushây
(
ç
);

146 
	}
}

151 
	$d¸ód
(
dev
)

153 
	`âªad
(&
dc11
[
dev
.
d_mö‹
]);

154 
	}
}

159 
	$dcwrôe
(
dev
)

161 
	`âwrôe
(&
dc11
[
dev
.
d_mö‹
]);

162 
	}
}

167 
	$dcxöt
(
dev
)

169 
ây
 *
ç
;

171 
	`â°¨t
(
ç
 = &
dc11
[
dev
.
d_mö‹
]);

172 i‡(
ç
->
t_outq
.
c_cc
 =0 ||Åp->t_outq.c_c¯=
TTLOWAT
)

173 
	`wakeup
(&
ç
->
t_outq
);

174 
	}
}

179 
	$d¸öt
(
dev
)

181 
ây
 *
ç
;

182 
c
, 
c§
;

184 
ç
 = &
dc11
[
dev
.
d_mö‹
];

185 
c
 = 
ç
->
t_addr
->
d¸buf
;

191 i‡(((
c§
 = 
ç
->
t_addr
->
d¸c§
Ë& 
CARRIER
) == 0) {

192 i‡((
ç
->
t_°©e
&
WOPEN
) == 0) {

193 
ç
->
t_addr
->
d¸c§
 =& ~
CDLEAD
;

194 i‡(
ç
->
t_°©e
 & 
CARR_ON
)

195 
	`sig«l
(
ç
, 
SIGHUP
);

196 
	`Êushây
(
ç
);

198 
ç
->
t_°©e
 =& ~
CARR_ON
;

201 i‡(
c§
&
ERROR
 || (
ç
->
t_°©e
&
ISOPEN
)==0) {

202 i‡(
ç
->
t_°©e
&
WOPEN
 && 
c§
&
CARRIER
)

203 
ç
->
t_°©e
 =| 
CARR_ON
;

204 
	`wakeup
(
ç
);

207 
c§
 =& 
PARITY
;

208 i‡(
c§
&&(
ç
->
t_Êags
&
ODDP
Ë|| !c§&&—p->t_Êags&
EVENP
))

209 
	`âyöput
(
c
, 
ç
);

210 
	}
}

216 
	$dcsgây
(
dev
, 
av
)

217 *
av
;

219 
ây
 *
ç
;

220 
r
;

222 
ç
 = &
dc11
[
dev
.
d_mö‹
];

223 i‡(
	`ây°ty
(
ç
, 
av
))

225 i‡(
r
 = 
d¸°ab
[
ç
->
t_•ìds
.
lobyã
&017])

226 
ç
->
t_addr
->
d¸c§
 = 
r
;

228 
ç
->
t_addr
->
d¸c§
 =& ~
CDLEAD
;

229 i‡(
r
 = 
d˘°ab
[
ç
->
t_•ìds
.
hibyã
&017])

230 
ç
->
t_addr
->
d˘c§
 = 
r
;

231 
	}
}

	@dmr/dh.c

13 
	~"../∑øm.h
"

14 
	~"../c⁄f.h
"

15 
	~"../u£r.h
"

16 
	~"../ây.h
"

17 
	~"../¥oc.h
"

19 
	#DHADDR
 0160020

	)

20 
	#NDH11
 16

	)

21 
	#DHNCH
 8

	)

23 
ây
 
	gdh11
[
NDH11
];

27 
	gdh_˛i°
[
NDH11
][
DHNCH
];

32 
ndh11
 
	gNDH11
;

37 
	#BITS6
 01

	)

38 
	#BITS7
 02

	)

39 
	#BITS8
 03

	)

40 
	#TWOSB
 04

	)

41 
	#PENABLE
 020

	)

43 
	#OPAR
 040

	)

44 
	#HDUPLX
 040000

	)

46 
	#IENABLE
 030100

	)

47 
	#PERROR
 010000

	)

48 
	#FRERROR
 020000

	)

49 
	#XINT
 0100000

	)

50 
	#SSPEED
 7

	)

55 
	gdhßr
;

57 
	sdhªgs
 {

58 
	mdhc§
;

59 
	mdhnxch
;

60 
	mdhÕr
;

61 
	mdhˇr
;

62 
	mdhb¸
;

63 
	mdhb¨
;

64 
	mdhbªak
;

65 
	mdhsûo
;

71 
	$dh›í
(
dev
, 
Êag
)

73 
ây
 *
ç
;

74 
	`dh°¨t
();

76 i‡(
dev
.
d_mö‹
 >
NDH11
) {

77 
u
.
u_îr‹
 = 
ENXIO
;

80 
ç
 = &
dh11
[
dev
.
d_mö‹
];

81 
ç
->
t_addr
 = 
dh°¨t
;

82 
ç
->
t_dev
 = 
dev
;

83 
DHADDR
->
dhc§
 =| 
IENABLE
;

84 
ç
->
t_°©e
 =| 
WOPEN
|
SSTART
;

85 i‡((
ç
->
t_°©e
&
ISOPEN
) == 0) {

86 
ç
->
t_îa£
 = 
CERASE
;

87 
ç
->
t_kûl
 = 
CKILL
;

88 
ç
->
t_•ìds
 = 
SSPEED
 | (SSPEED<<8);

89 
ç
->
t_Êags
 = 
ODDP
|
EVENP
|
ECHO
;

90 
	`dh∑øm
(
ç
);

92 
	`dm›í
(
dev
);

93 
ç
->
t_°©e
 =& ~
WOPEN
;

94 
ç
->
t_°©e
 =| 
ISOPEN
;

95 i‡(
u
.
u_¥o˝
->
p_âyp
 == 0)

96 
u
.
u_¥o˝
->
p_âyp
 = 
ç
;

97 
	}
}

102 
	$dh˛o£
(
dev
)

104 
ây
 *
ç
;

106 
ç
 = &
dh11
[
dev
.
d_mö‹
];

107 
	`dm˛o£
(
dev
);

108 
ç
->
t_°©e
 =& (
CARR_ON
|
SSTART
);

109 
	`wÊushây
(
ç
);

110 
	}
}

115 
	$dhªad
(
dev
)

117 
	`âªad
(&
dh11
[
dev
.
d_mö‹
]);

118 
	}
}

123 
	$dhwrôe
(
dev
)

125 
	`âwrôe
(&
dh11
[
dev
.
d_mö‹
]);

126 
	}
}

131 
	$dhröt
()

133 
ây
 *
ç
;

134 
c
;

136 (
c
 = 
DHADDR
->
dhnxch
) < 0) {

137 
ç
 = &
dh11
[(
c
>>8)&017];

138 i‡(
ç
 >&
dh11
[
NDH11
])

140 if((
ç
->
t_°©e
&
ISOPEN
)==0 || (
c
&
PERROR
)) {

141 
	`wakeup
(
ç
);

144 i‡(
c
&
FRERROR
)

145 i‡(
ç
->
t_Êags
&
RAW
)

146 
c
 = 0;

148 
c
 = 0177;

149 
	`âyöput
(
c
, 
ç
);

151 
	}
}

156 
	$dhsgây
(
dev
, 
av
)

157 *
av
;

159 
ây
 *
ç
;

160 
r
;

162 
ç
 = &
dh11
[
dev
.
d_mö‹
];

163 i‡(
	`ây°ty
(
ç
, 
av
))

165 
	`dh∑øm
(
ç
);

166 
	}
}

172 
	$dh∑øm
(
©p
)

173 
ây
 *
©p
;

175 
ây
 *
ç
;

176 
Õr
;

178 
ç
 = 
©p
;

179 
	`•l5
();

180 
DHADDR
->
dhc§
.
lobyã
 = 
ç
->
t_dev
.
d_mö‹
 | 
IENABLE
;

184 i‡(
ç
->
t_•ìds
.
lobyã
==0) {

185 
ç
->
t_Êags
 =| 
HUPCL
;

186 
	`dm˛o£
(
ç
->
t_dev
);

189 
Õr
 = (
ç
->
t_•ìds
.
hibyã
<<10Ë| (ç->t_•ìds.
lobyã
<<6);

190 i‡(
ç
->
t_•ìds
.
lobyã
 == 4)

191 
Õr
 =| 
BITS6
|
PENABLE
|
HDUPLX
; 

192 i‡(
ç
->
t_Êags
&
EVENP
)

193 i‡(
ç
->
t_Êags
&
ODDP
)

194 
Õr
 =| 
BITS8
; 

195 
Õr
 =| 
BITS7
|
PENABLE
; 

196 
Õr
 =| 
BITS7
|
OPAR
|
PENABLE
;

197 i‡(
ç
->
t_•ìds
.
lobyã
 == 3)

198 
Õr
 =| 
TWOSB
;

199 
DHADDR
->
dhÕr
 = 
Õr
;

200 
	`•l0
();

201 
	}
}

208 
	$dhxöt
()

210 
ây
 *
ç
;

211 
âybô
, 
b¨
;

213 
b¨
 = 
dhßr
 & ~
DHADDR
->
dhb¨
;

214 
DHADDR
->
dhc§
 =& ~
XINT
;

215 
âybô
 = 1;

216 
ç
 = 
dh11
; 
b¨
;Åp++) {

217 if(
b¨
&
âybô
) {

218 
dhßr
 =& ~
âybô
;

219 
b¨
 =& ~
âybô
;

220 
ç
->
t_°©e
 =& ~
BUSY
;

221 
	`dh°¨t
(
ç
);

223 
âybô
 =<< 1;

225 
	}
}

230 
	$dh°¨t
(
©p
)

231 
ây
 *
©p
;

233 
	`âr°π
();

234 
c
, 
nch
;

235 
ây
 *
ç
;

236 
•s
;

237 *
˝
;

239 
•s
 = 
PS
->
öãg
;

240 
	`•l5
();

241 
ç
 = 
©p
;

246 i‡(
ç
->
t_°©e
&(
TIMEOUT
|
BUSY
))

247 
out
;

253 i‡(
c
 = 
ç
->
t_ch¨
) {

254 
ç
->
t_ch¨
 = 0;

255 
	`timeout
(
âr°π
, 
ç
, (
c
&0177)+6);

256 
ç
->
t_°©e
 =| 
TIMEOUT
;

257 
out
;

259 
˝
 = 
dh_˛i°
[
ç
->
t_dev
.
d_mö‹
];

260 
nch
 = 0;

265 
nch
 > -
DHNCH
 && (
c
 = 
	`gëc
(&
ç
->
t_outq
))>=0) {

266 i‡(
c
 >= 0200) {

267 
ç
->
t_ch¨
 = 
c
;

270 *
˝
++ = 
c
;

271 
nch
--;

277 i‡(
ç
->
t_outq
.
c_cc
<=
TTLOWAT
 &&Åp->
t_°©e
&
ASLEEP
) {

278 
ç
->
t_°©e
 =& ~
ASLEEP
;

279 
	`wakeup
(&
ç
->
t_outq
);

285 i‡(
nch
) {

286 
DHADDR
->
dhc§
.
lobyã
 = 
ç
->
t_dev
.
d_mö‹
 | 
IENABLE
;

287 
DHADDR
->
dhˇr
 = 
˝
+
nch
;

288 
DHADDR
->
dhb¸
 = 
nch
;

289 
c
 = 1<<
ç
->
t_dev
.
d_mö‹
;

290 
DHADDR
->
dhb¨
 =| 
c
;

291 
dhßr
 =| 
c
;

292 
ç
->
t_°©e
 =| 
BUSY
;

293 } i‡(
c
 = 
ç
->
t_ch¨
) {

294 
ç
->
t_ch¨
 = 0;

295 
	`timeout
(
âr°π
, 
ç
, (
c
&0177)+6);

296 
ç
->
t_°©e
 =| 
TIMEOUT
;

298 
out
:

299 
PS
->
öãg
 = 
•s
;

300 
	}
}

	@dmr/dhdm.c

8 
	~"../∑øm.h
"

9 
	~"../ây.h
"

10 
	~"../c⁄f.h
"

12 
	#DMADDR
 0170500

	)

14 
ây
 
	gdh11
[];

15 
	gndh11
;

17 
	#DONE
 0200

	)

18 
	#SCENABL
 040

	)

19 
	#CLSCAN
 01000

	)

20 
	#TURNON
 07

	)

21 
	#TURNOFF
 1

	)

22 
	#CARRIER
 0100

	)

24 
	sdmªgs
 {

25 
	mdmc§
;

26 
	mdml°©
;

32 
	$dm›í
(
dev
)

34 
ây
 *
ç
;

36 
ç
 = &
dh11
[
dev
.
d_mö‹
];

37 
DMADDR
->
dmc§
 = 
dev
.
d_mö‹
;

38 
DMADDR
->
dml°©
 = 
TURNON
;

39 i‡(
DMADDR
->
dml°©
&
CARRIER
)

40 
ç
->
t_°©e
 =| 
CARR_ON
;

41 
DMADDR
->
dmc§
 = 
IENABLE
|
SCENABL
;

42 
	`•l5
();

43 (
ç
->
t_°©e
&
CARR_ON
)==0)

44 
	`¶ìp
(&
ç
->
t_øwq
, 
TTIPRI
);

45 
	`•l0
();

46 
	}
}

52 
	$dm˛o£
(
dev
)

54 
ây
 *
ç
;

56 
ç
 = &
dh11
[
dev
.
d_mö‹
];

57 i‡(
ç
->
t_Êags
&
HUPCL
) {

58 
DMADDR
->
dmc§
 = 
dev
.
d_mö‹
;

59 
DMADDR
->
dml°©
 = 
TURNOFF
;

60 
DMADDR
->
dmc§
 = 
IENABLE
|
SCENABL
;

62 
	}
}

68 
	$dmöt
()

70 
ây
 *
ç
;

72 i‡(
DMADDR
->
dmc§
&
DONE
) {

73 
ç
 = &
dh11
[
DMADDR
->
dmc§
&017];

74 i‡(
ç
 < &
dh11
[
ndh11
]) {

75 
	`wakeup
(
ç
);

76 i‡((
DMADDR
->
dml°©
&
CARRIER
)==0) {

77 i‡((
ç
->
t_°©e
&
WOPEN
)==0) {

78 
	`sig«l
(
ç
, 
SIGHUP
);

79 
DMADDR
->
dml°©
 = 0;

80 
	`Êushây
(
ç
);

82 
ç
->
t_°©e
 =& ~
CARR_ON
;

84 
ç
->
t_°©e
 =| 
CARR_ON
;

86 
DMADDR
->
dmc§
 = 
IENABLE
|
SCENABL
;

88 
	}
}

	@dmr/dhfdm.c

8 
	~"../ây.h
"

9 
	~"../c⁄f.h
"

11 
ây
 
	gdh11
[];

13 
	$dm›í
(
dev
)

15 
ây
 *
ç
;

17 
ç
 = &
dh11
[
dev
.
d_mö‹
];

18 
ç
->
t_°©e
 =| 
CARR_ON
;

19 
	}
}

21 
	$dm˛o£
(
dev
)

23 
	}
}

	@dmr/dn.c

9 
	~"../∑øm.h
"

10 
	~"../c⁄f.h
"

11 
	~"../u£r.h
"

13 
	sdn
 {

15 
	mdn_°©
;

16 
	mdn_ªg
;

17 } 
	mdn11
[3];

20 
	#DNADDR
 0175200

	)

22 
	#PWI
 00200

	)

23 
	#ACR
 00100

	)

24 
	#DLO
 0020

	)

25 
	#DONE
 0200

	)

26 
	#IENABLE
 0100

	)

27 
	#DSS
 040

	)

28 
	#PND
 020

	)

29 
	#MENABLE
 04

	)

30 
	#DPR
 02

	)

31 
	#CRQ
 01

	)

33 
	#DNPRI
 5

	)

35 
	$dn›í
(
dev
, 
Êag
)

37 
dn
 *
dp
;

38 
rdev
;

40 
rdev
 = 
dev
.
d_mö‹
;

41 
dp
 = &
DNADDR
->
dn11
[
rdev
];

42 i‡(
dp
->
dn_ªg
&(
PWI
|
DLO
))

43 
u
.
u_îr‹
 = 
ENXIO
;

45 
DNADDR
->
dn11
[0].
dn_°©
 =| 
MENABLE
;

46 
dp
->
dn_°©
 = 
IENABLE
|
MENABLE
|
CRQ
;

48 
	}
}

50 
	$dn˛o£
(
dev
)

52 
DNADDR
->
dn11
[
dev
.
d_mö‹
].
dn_°©
 =& 
MENABLE
;

53 
	}
}

55 
	$dnwrôe
(
dev
)

57 
dn
 *
dp
;

58 
c
;

59 
lbﬁt
;

61 
dp
 = &
DNADDR
->
dn11
[
dev
.
d_mö‹
];

63 (
dp
->
dn_°©
&
DONE
)==0)

64 
	`¶ìp
(
DNADDR
, 
DNPRI
);

65 
dp
->
dn_°©
 =& ~
DONE
;

66 
c⁄tö
:

67 i‡(
dp
->
dn_ªg
&(
PWI
|
ACR
)) {

68 
u
.
u_îr‹
 = 
EIO
;

71 i‡(
dp
->
dn_°©
&
DSS
)

73 
c
 = 0;

74 i‡(
u
.
u_cou¡
==0 || (
dp
->
dn_°©
&
PND
)==0 || (
c
=
	`˝ass
())<0)

76 i‡(
c
=='-') {

77 
	`¶ìp
(&
lbﬁt
, 
DNPRI
);

78 
	`¶ìp
(&
lbﬁt
, 
DNPRI
);

79 
c⁄tö
;

81 
dp
->
dn_ªg
 = 
c
-'0';

82 
dp
->
dn_°©
 =| 
DPR
;

84 
	}
}

86 
	$dnöt
(
dev
)

88 
	`wakeup
(
DNADDR
);

89 
	}
}

	@dmr/dp.c

15 
	~"../∑øm.h
"

16 
	~"../c⁄f.h
"

17 
	~"../u£r.h
"

18 
	~"../buf.h
"

22 *
	mdp_buf
;

23 *
	mdp_buÂ
;

24 
	mdp_nxmô
;

25 
	mdp_°©e
;

26 
	mdp_timî
;

27 
	mdp_¥oc
;

28 } 
	gdp11
;

32 
	md¥c§
;

33 
	md¥buf
;

34 
	mdpsyn0
;

35 
	md±c§
;

36 
	md±buf
;

37 
	mdpsyn1
;

41 
	#ODDPAR
 010000

	)

42 
	#IENABLE
 0100

	)

43 
	#HDUPLX
 02

	)

45 
	#CTRANS
 0100000

	)

46 
	#RORUN
 040000

	)

47 
	#RING
 020000

	)

48 
	#DSRDY
 010000

	)

49 
	#CARRIER
 04000

	)

50 
	#DONE
 0200

	)

51 
	#IENABLE
 0100

	)

52 
	#SIENABL
 040

	)

54 
	#WRITE
 1

	)

55 
	#READ
 0

	)

57 
	#DTRDY
 01

	)

58 
	#RCVACT
 04000

	)

60 
	#DPADDR
 0174770

	)

61 
	#DPPRI
 5

	)

62 
	#SYN
 026

	)

68 
	$dp›í
(
dev
, 
Êag
)

70 
	`d±imeout
();

72 i‡(
dp11
.
dp_¥oc
!=0 && dp11.dp_¥oc!=
u
.
u_¥o˝
) {

73 
u
.
u_îr‹
 = 
ENXIO
;

76 
dp11
.
dp_¥oc
 = 
u
.
u_¥o˝
;

77 
dp11
.
dp_°©e
 = 
READ
;

78 i‡(
dp11
.
dp_buf
==0) {

79 
dp11
.
dp_buf
 = 
	`gëblk
(
NODEV
);

80 
dp11
.
dp_buÂ
 = dp11.
dp_buf
->
b_addr
;

81 
dp11
.
dp_timî
 = 
HZ
;

82 
	`timeout
(
d±imeout
, 0, 
HZ
);

84 
DPADDR
->
dpsyn0
 = 
SYN
;

85 
DPADDR
->
d¥c§
 = 
HDUPLX
|
IENABLE
;

86 
DPADDR
->
d±c§
 = 
IENABLE
|
SIENABL
|
DTRDY
;

87 
	}
}

89 
	$dp˛o£
()

91 
DPADDR
->
d¥c§
 = 0;

92 
DPADDR
->
d±c§
 = 0;

93 
dp11
.
dp_timî
 = 0;

94 
dp11
.
dp_¥oc
 = 0;

95 i‡(
dp11
.
dp_buf
 != 0) {

96 
	`bªl£
(
dp11
.
dp_buf
);

97 
dp11
.
dp_buf
 = 0;

99 
	}
}

108 
	$d¥ód
()

110 *
bp
, **
ïp
;

112 
bp
 = 
dp11
.
dp_buf
->
b_addr
;

113 
ïp
 = &
dp11
.
dp_buÂ
;

115 if(
	`dpwaô
())

117 i‡(*
ïp
 > 
bp
)

119 
	`•l6
();

120 i‡(
dp11
.
dp_timî
 <= 1) {

121 
	`•l0
();

124 
	`¶ìp
(&
dp11
, 
DPPRI
);

125 
	`•l0
();

127 
	`iomove
(
dp11
.
dp_buf
, 0, 
	`mö
(
u
.
u_cou¡
, *
ïp
-
bp
), 
B_READ
);

128 
	}
}

135 
	$dpwrôe
()

137 *
bp
;

139 i‡(
u
.
u_cou¡
==0 || 
	`dpwaô
())

141 
dp11
.
dp_°©e
 = 
WRITE
;

142 
bp
 = 
dp11
.
dp_buf
->
b_addr
;

143 
dp11
.
dp_buÂ
 = 
bp
;

144 i‡(
u
.
u_cou¡
>512)

145 
u
.
u_cou¡
 = 512;

146 
dp11
.
dp_nxmô
 = 
u
.
u_cou¡
;

147 
	`iomove
(
dp11
.
dp_buf
, 0, 
u
.
u_cou¡
, 
B_WRITE
);

148 
	`dp°¨t
();

149 
	}
}

156 
	$dpwaô
()

159 i‡((
DPADDR
->
d±c§
&
DSRDY
)==0 || 
dp11
.
dp_buf
==0) {

160 
u
.
u_îr‹
 = 
EIO
;

163 
	`•l6
();

164 i‡(
dp11
.
dp_°©e
==
READ
 && (
DPADDR
->
d±c§
&
CARRIER
)==0) {

165 
	`•l0
();

168 
	`¶ìp
(&
dp11
, 
DPPRI
);

169 
	`•l0
();

171 
	}
}

177 
	$dp°¨t
()

179 
c
;

180 
∑πab
[];

182 
dp11
.
dp_timî
 = 10;

183 i‡(--
dp11
.
dp_nxmô
 >= 0) {

184 
c
 = (*
dp11
.
dp_buÂ
++) & 0177;

185 
DPADDR
->
d±buf
 = 
c
 | ~
∑πab
[c]&0200;

187 
dp11
.
dp_buÂ
 = dp11.
dp_buf
->
b_addr
;

188 
dp11
.
dp_°©e
 = 
READ
;

190 
	}
}

197 
	$d±imeout
()

199 i‡(
dp11
.
dp_timî
==0)

201 i‡(--
dp11
.
dp_timî
==0) {

202 
	`d±u∫¨ound
();

203 
dp11
.
dp_timî
 = 1;

205 
	`timeout
(
d±imeout
, 0, 
HZ
);

206 
	}
}

212 
	$d¥öt
()

214 
c
;

216 
c
 = 
DPADDR
->
d¥buf
 & 0177;

217 i‡(
dp11
.
dp_°©e
==
READ
) {

218 i‡((
DPADDR
->
d¥c§
&
ODDPAR
) == 0)

219 
c
 =| 0200;

220 i‡(
dp11
.
dp_buÂ
 < dp11.
dp_buf
->
b_addr
+512)

221 *
dp11
.
dp_buÂ
++ = 
c
;

223 
	}
}

231 
	$dpxöt
()

233 
dp°©
;

235 
dp°©
 = 
DPADDR
->
d±c§
;

236 
DPADDR
->
d±c§
 =& ~(
CTRANS
|
RORUN
|
RING
|
DONE
);

237 i‡(
dp°©
 & (
CTRANS
|
RORUN
))

238 
	`d±u∫¨ound
();

239 i‡(
dp°©
&
DONE
 && 
dp11
.
dp_°©e
==
WRITE
)

240 
	`dp°¨t
();

241 
	}
}

246 
	$d±u∫¨ound
()

248 
DPADDR
->
d¥c§
 =& ~
RCVACT
;

249 i‡(
dp11
.
dp_°©e
==
WRITE
) {

250 
dp11
.
dp_timî
 = 10;

251 
dp11
.
dp_°©e
 = 
READ
;

252 
dp11
.
dp_buÂ
 = dp11.
dp_buf
->
b_addr
;

254 
	`wakeup
(&
dp11
);

255 
	}
}

	@dmr/hp.c

14 
	~"../∑øm.h
"

15 
	~"../buf.h
"

16 
	~"../c⁄f.h
"

17 
	~"../u£r.h
"

20 
	mhpcs1
;

21 
	mhpwc
;

22 
	mhpba
;

23 
	mhpda
;

24 
	mhpcs2
;

25 
	mhpds
;

26 
	mh≥r1
;

27 
	mh∑s
;

28 
	mh∂a
;

29 
	mhpdb
;

30 
	mhpmr
;

31 
	mhpdt
;

32 
	mhp¢
;

33 
	mhpof
;

34 
	mhpˇ
;

35 
	mhpcc
;

36 
	mh≥r2
;

37 
	mh≥r3
;

38 
	mhµos
;

39 
	mhµ©
;

40 
	mhpb´
;

43 
	#HPADDR
 0176700

	)

44 
	#NHP
 8

	)

47 *
	mnblocks
;

48 
	mcyloff
;

49 } 
	ghp_sizes
[] {

63 
devèb
 
	gh±ab
;

64 
buf
 
	ghpbuf
;

66 
	ghp_›íf
;

69 
	#GO
 01

	)

70 
	#PRESET
 020

	)

71 
	#RECAL
 06

	)

72 
	#RCLR
 010

	)

73 
	#OFFSET
 014

	)

75 
	#READY
 0200

	)

76 
	#PIP
 020000

	)

77 
	#ERR
 040000

	)

79 
	#DU
 040000

	)

80 
	#DTE
 010000

	)

81 
	#OPI
 020000

	)

83 
	#DCK
 0100000

	)

84 
	#ECH
 0100

	)

86 
	#CLR
 040

	)

88 
	#FMT22
 010000

	)

94 
	#åk£c
 
av_back


	)

95 
	#cylö
 
b_ªsid


	)

97 
	$hp›í
()

100 if(!
hp_›íf
){

101 
hp_›íf
++;

102 
HPADDR
->
hpcs2
 = 
CLR
;

103 
HPADDR
->
hpcs1
 = 
RCLR
|
GO
;

104 
HPADDR
->
hpcs1
 = 
PRESET
|
GO
;

105 
HPADDR
->
hpof
 = 
FMT22
;

107 
	}
}

109 
	$hp°øãgy
(
abp
)

110 
buf
 *
abp
;

112 
buf
 *
bp
;

113 *
p1
, *
p2
;

115 
bp
 = 
abp
;

116 
p1
 = &
hp_sizes
[
bp
->
b_dev
.
d_mö‹
&07];

117 i‡(
bp
->
b_dev
.
d_mö‹
 >(
NHP
<<3) ||

118 
bp
->
b_blkno
 >
p1
->
nblocks
) {

119 
bp
->
b_Êags
 =| 
B_ERROR
;

120 
	`iod⁄e
(
bp
);

123 
bp
->
av_f‹w
 = 0;

124 
bp
->
cylö
 = 
p1
->
cyloff
;

125 
p1
 = 
bp
->
b_blkno
;

126 
p2
 = 
	`Ãem
(
p1
, 22);

127 
p1
 = 
	`ldiv
(p1, 22);

128 
bp
->
åk£c
 = (
p1
%19)<<8 | 
p2
;

129 
bp
->
cylö
 =+ 
p1
/19;

130 
	`•l5
();

131 i‡((
p1
 = 
h±ab
.
d_a˘f
)==0)

132 
h±ab
.
d_a˘f
 = 
bp
;

134 ; 
p2
 = 
p1
->
av_f‹w
;Ö1 =Ö2) {

135 i‡(
p1
->
cylö
 <
bp
->cylin

136 && 
bp
->
cylö
 < 
p2
->cylin

137 || 
p1
->
cylö
 >
bp
->cylin

138 && 
bp
->
cylö
 > 
p2
->cylin)

141 
bp
->
av_f‹w
 = 
p2
;

142 
p1
->
av_f‹w
 = 
bp
;

144 i‡(
h±ab
.
d_a˘ive
==0)

145 
	`hp°¨t
();

146 
	`•l0
();

147 
	}
}

149 
	$hp°¨t
()

151 
buf
 *
bp
;

153 i‡((
bp
 = 
h±ab
.
d_a˘f
) == 0)

155 
h±ab
.
d_a˘ive
++;

156 
HPADDR
->
hpcs2
 = 
bp
->
b_dev
.
d_mö‹
 >> 3;

157 
HPADDR
->
hpˇ
 = 
bp
->
cylö
;

158 
	`rh°¨t
(
bp
, &
HPADDR
->
hpda
, bp->
åk£c
, &HPADDR->
hpb´
);

159 
	}
}

161 
	$hpöå
()

163 
buf
 *
bp
;

164 
˘r
;

166 i‡(
h±ab
.
d_a˘ive
 == 0)

168 
bp
 = 
h±ab
.
d_a˘f
;

169 
h±ab
.
d_a˘ive
 = 0;

170 i‡(
HPADDR
->
hpcs1
 & 
ERR
) {

171 
	`devîr‹
(
bp
, 
HPADDR
->
hpcs2
, 0);

172 if(
HPADDR
->
h≥r1
 & (
DU
|
DTE
|
OPI
)) {

173 
HPADDR
->
hpcs2
 = 
CLR
;

174 
HPADDR
->
hpcs1
 = 
RECAL
|
GO
;

175 
˘r
 = 0;

176 (
HPADDR
->
hpds
&
PIP
Ë&& --
˘r
);

178 
HPADDR
->
hpcs1
 = 
RCLR
|
GO
;

179 i‡(++
h±ab
.
d_îr˙t
 <= 10) {

180 
	`hp°¨t
();

183 
bp
->
b_Êags
 =| 
B_ERROR
;

185 
h±ab
.
d_îr˙t
 = 0;

186 
h±ab
.
d_a˘f
 = 
bp
->
av_f‹w
;

187 
bp
->
b_ªsid
 = 
HPADDR
->
hpwc
;

188 
	`iod⁄e
(
bp
);

189 
	`hp°¨t
();

190 
	}
}

192 
	$h¥ód
(
dev
)

195 if(
	`hµhys
(
dev
))

196 
	`physio
(
hp°øãgy
, &
hpbuf
, 
dev
, 
B_READ
);

197 
	}
}

199 
	$hpwrôe
(
dev
)

202 if(
	`hµhys
(
dev
))

203 
	`physio
(
hp°øãgy
, &
hpbuf
, 
dev
, 
B_WRITE
);

204 
	}
}

206 
	$hµhys
(
dev
)

208 
c
;

210 
c
 = 
	`lshi·
(
u
.
u_off£t
, -9);

211 
c
 =+ 
	`ldiv
(
u
.
u_cou¡
+511, 512);

212 if(
c
 > 
hp_sizes
[
dev
.
d_mö‹
 & 07].
nblocks
) {

213 
u
.
u_îr‹
 = 
ENXIO
;

217 
	}
}

	@dmr/hs.c

9 
	~"../∑øm.h
"

10 
	~"../buf.h
"

11 
	~"../c⁄f.h
"

12 
	~"../u£r.h
"

16 
	mhscs1
;

17 
	mhswc
;

18 
	mhsba
;

19 
	mhsda
;

20 
	mhscs2
;

21 
	mhsds
;

22 
	mh£r
;

23 
	mhßs
;

24 
	mh¶a
;

25 
	mhsdb
;

26 
	mhsmr
;

27 
	mhsdt
;

28 
	mhsb´
;

31 
devèb
 
	gh°ab
;

32 
buf
 
	grhsbuf
;

34 
	#HSADDR
 0172040

	)

36 
	#ERR
 040000

	)

38 
	#GO
 01

	)

39 
	#RCLR
 010

	)

40 
	#DRY
 0200

	)

42 
	$hs°øãgy
(
abp
)

43 
buf
 *
abp
;

45 
buf
 *
bp
;

46 
mblks
;

48 
bp
 = 
abp
;

49 
mblks
 = 1024;

50 if(
bp
->
b_dev
.
d_mö‹
 >= 8)

51 
mblks
 = 2048;

52 if(
bp
->
b_blkno
 >
mblks
) {

53 
bp
->
b_Êags
 =| 
B_ERROR
;

54 
	`iod⁄e
(
bp
);

57 
bp
->
av_f‹w
 = 0;

58 
	`•l5
();

59 i‡(
h°ab
.
d_a˘f
==0)

60 
h°ab
.
d_a˘f
 = 
bp
; 

61 
h°ab
.
d_a˘l
->
av_f‹w
 = 
bp
;

62 
h°ab
.
d_a˘l
 = 
bp
;

63 i‡(
h°ab
.
d_a˘ive
==0)

64 
	`hs°¨t
();

65 
	`•l0
();

66 
	}
}

68 
	$hs°¨t
()

70 
buf
 *
bp
;

71 
addr
;

73 i‡((
bp
 = 
h°ab
.
d_a˘f
) == 0)

75 
h°ab
.
d_a˘ive
++;

76 
addr
 = 
bp
->
b_blkno
;

77 if(
bp
->
b_dev
.
d_mö‹
 < 8)

78 
addr
 =<< 1;

79 
HSADDR
->
hscs2
 = 
bp
->
b_dev
.
d_mö‹
 & 07;

80 
	`rh°¨t
(
bp
, &
HSADDR
->
hsda
, 
addr
<<1, &HSADDR->
hsb´
);

81 
	}
}

83 
	$hsöå
()

85 
buf
 *
bp
;

87 i‡(
h°ab
.
d_a˘ive
 == 0)

89 
bp
 = 
h°ab
.
d_a˘f
;

90 
h°ab
.
d_a˘ive
 = 0;

91 if(
HSADDR
->
hscs1
 & 
ERR
){

92 
	`devîr‹
(
bp
, 
HSADDR
->
hscs2
, 0);

93 
HSADDR
->
hscs1
 = 
RCLR
|
GO
;

94 i‡(++
h°ab
.
d_îr˙t
 <= 10) {

95 
	`hs°¨t
();

98 
bp
->
b_Êags
 =| 
B_ERROR
;

100 
h°ab
.
d_îr˙t
 = 0;

101 
h°ab
.
d_a˘f
 = 
bp
->
av_f‹w
;

102 
	`iod⁄e
(
bp
);

103 
	`hs°¨t
();

104 
	}
}

106 
	$h§ód
(
dev
)

109 
	`physio
(
hs°øãgy
, &
rhsbuf
, 
dev
, 
B_READ
);

110 
	}
}

112 
	$hswrôe
(
dev
)

115 
	`physio
(
hs°øãgy
, &
rhsbuf
, 
dev
, 
B_WRITE
);

116 
	}
}

	@dmr/ht.c

9 
	~"../∑øm.h
"

10 
	~"../buf.h
"

11 
	~"../c⁄f.h
"

12 
	~"../u£r.h
"

15 
	mhtcs1
;

16 
	mhtwc
;

17 
	mhtba
;

18 
	mhtfc
;

19 
	mhtcs2
;

20 
	mhtds
;

21 
	mhãr
;

22 
	mhès
;

23 
	mhtck
;

24 
	mhtdb
;

25 
	mhtmr
;

26 
	mhtdt
;

27 
	mht¢
;

28 
	mhâc
;

29 
	mhtb´
;

32 
devèb
 
	ghâab
;

33 
buf
 
	grhtbuf
;

35 
	#NUNIT
 8

	)

37 
	gh_›íf
[
NUNIT
];

38 *
	gh_blkno
[
NUNIT
];

39 *
	gh_nxªc
[
NUNIT
];

41 
	#HTADDR
 0172440

	)

43 
	#GO
 01

	)

44 
	#NOP
 0

	)

45 
	#WEOF
 026

	)

46 
	#SFORW
 030

	)

47 
	#SREV
 032

	)

48 
	#ERASE
 024

	)

49 
	#REW
 06

	)

50 
	#CLR
 010

	)

51 
	#P800
 01300

	)

52 
	#P1600
 02300

	)

53 
	#IENABLE
 0100

	)

54 
	#CRDY
 0200

	)

55 
	#EOF
 04

	)

56 
	#DRY
 0200

	)

57 
	#MOL
 010000

	)

58 
	#PIP
 020000

	)

59 
	#ERR
 040000

	)

61 
	#SSEEK
 1

	)

62 
	#SIO
 2

	)

64 
	$ht›í
(
dev
, 
Êag
)

66 
unô
;

68 
unô
 = 
dev
.
d_mö‹
&077;

69 i‡(
unô
 >
NUNIT
 || 
h_›íf
[unit])

70 
u
.
u_îr‹
 = 
ENXIO
;

72 
h_›íf
[
unô
]++;

73 
h_blkno
[
unô
] = 0;

74 
h_nxªc
[
unô
] = 65535;

75 
	`hcomm™d
(
dev
, 
NOP
);

77 
	}
}

79 
	$ht˛o£
(
dev
, 
Êag
)

81 
unô
;

83 
unô
 = 
dev
.
d_mö‹
&077;

84 
h_›íf
[
unô
] = 0;

85 i‡(
Êag
) {

86 
	`hcomm™d
(
dev
, 
WEOF
);

87 
	`hcomm™d
(
dev
, 
WEOF
);

89 
	`hcomm™d
(
dev
, 
REW
);

90 
	}
}

92 
	$hcomm™d
(
dev
, 
com
)

94 
unô
;

95 
lbﬁt
;

97 
unô
 = 
dev
.
d_mö‹
;

98 
hâab
.
d_a˘ive
 || (
HTADDR
->
htcs1
 & 
CRDY
)==0)

99 
	`¶ìp
(&
lbﬁt
, 1);

100 
HTADDR
->
htcs2
 = (
unô
>>3)&07;

101 (
HTADDR
->
htds
&
DRY
) == 0)

102 
	`¶ìp
(&
lbﬁt
, 1);

103 if(
unô
 >= 64)

104 
HTADDR
->
hâc
 = 
P800
 | (
unô
&07); 

105 
HTADDR
->
hâc
 = 
P1600
 | (
unô
&07);

106 (
HTADDR
->
htds
&(
MOL
|
PIP
)) != MOL)

107 
	`¶ìp
(&
lbﬁt
, 1);

108 
HTADDR
->
htcs1
 = 
com
 | 
GO
;

109 
	}
}

111 
	$ht°øãgy
(
abp
)

112 
buf
 *
abp
;

114 
buf
 *
bp
;

115 **
p
;

117 
bp
 = 
abp
;

118 
p
 = &
h_nxªc
[
bp
->
b_dev
.
d_mö‹
&077];

119 i‡(*
p
 <
bp
->
b_blkno
) {

120 i‡(*
p
 < 
bp
->
b_blkno
) {

121 
bp
->
b_Êags
 =| 
B_ERROR
;

122 
	`iod⁄e
(
bp
);

125 i‡(
bp
->
b_Êags
&
B_READ
) {

126 
	`˛rbuf
(
bp
);

127 
	`iod⁄e
(
bp
);

131 i‡((
bp
->
b_Êags
&
B_READ
)==0)

132 *
p
 = 
bp
->
b_blkno
 + 1;

133 
bp
->
av_f‹w
 = 0;

134 
	`•l5
();

135 i‡(
hâab
.
d_a˘f
==0)

136 
hâab
.
d_a˘f
 = 
bp
;

138 
hâab
.
d_a˘l
->
av_f‹w
 = 
bp
;

139 
hâab
.
d_a˘l
 = 
bp
;

140 i‡(
hâab
.
d_a˘ive
==0)

141 
	`ht°¨t
();

142 
	`•l0
();

143 
	}
}

145 
	$ht°¨t
()

147 
buf
 *
bp
;

148 
unô
;

149 *
blkno
;

151 
lo›
:

152 i‡((
bp
 = 
hâab
.
d_a˘f
) == 0)

154 
unô
 = 
bp
->
b_dev
.
d_mö‹
;

155 
HTADDR
->
htcs2
 = (
unô
>>3)&07;

156 if(
unô
 >= 64)

157 
HTADDR
->
hâc
 = 
P800
 | (
unô
&07); 

158 
HTADDR
->
hâc
 = 
P1600
 | (
unô
&07);

159 
unô
 =& 077;

160 
blkno
 = 
h_blkno
[
unô
];

161 i‡(
h_›íf
[
unô
] < 0 || (
HTADDR
->
htcs1
 & 
CRDY
)==0) {

162 
bp
->
b_Êags
 =| 
B_ERROR
;

163 
hâab
.
d_a˘f
 = 
bp
->
av_f‹w
;

164 
	`iod⁄e
(
bp
);

165 
lo›
;

167 i‡(
blkno
 !
bp
->
b_blkno
) {

168 
hâab
.
d_a˘ive
 = 
SSEEK
;

169 i‡(
blkno
 < 
bp
->
b_blkno
) {

170 
HTADDR
->
htfc
 = 
blkno
 - 
bp
->
b_blkno
;

171 
HTADDR
->
htcs1
 = 
SFORW
|
IENABLE
|
GO
;

173 i‡(
bp
->
b_blkno
 == 0)

174 
HTADDR
->
htcs1
 = 
REW
|
IENABLE
|
GO
;

176 
HTADDR
->
htfc
 = 
bp
->
b_blkno
 - 
blkno
;

177 
HTADDR
->
htcs1
 = 
SREV
|
IENABLE
|
GO
;

182 
hâab
.
d_a˘ive
 = 
SIO
;

183 
	`rh°¨t
(
bp
, &
HTADDR
->
htfc
, bp->
b_wcou¡
<<1, &HTADDR->
htb´
);

184 
	}
}

186 
	$htöå
()

188 
buf
 *
bp
;

189 
unô
;

191 i‡((
bp
 = 
hâab
.
d_a˘f
)==0)

193 
unô
 = 
bp
->
b_dev
.
d_mö‹
&077;

194 i‡(
HTADDR
->
htcs1
 & 
ERR
) {

198 if(
HTADDR
->
htds
&
EOF
) {

199 if(
bp
 !&
rhtbuf
 && 
h_›íf
[
unô
])

200 
h_›íf
[
unô
] = -1;

202 
HTADDR
->
htcs1
 = 
ERR
|
CLR
|
GO
;

203 i‡((
HTADDR
->
htds
&
DRY
)!=0 && 
hâab
.
d_a˘ive
==
SIO
) {

204 i‡(++
hâab
.
d_îr˙t
 < 10) {

205 
h_blkno
[
unô
]++;

206 
hâab
.
d_a˘ive
 = 0;

207 
	`ht°¨t
();

211 
bp
->
b_Êags
 =| 
B_ERROR
;

212 
hâab
.
d_a˘ive
 = 
SIO
;

214 i‡(
hâab
.
d_a˘ive
 =
SIO
) {

215 
hâab
.
d_îr˙t
 = 0;

216 
h_blkno
[
unô
]++;

217 
hâab
.
d_a˘f
 = 
bp
->
av_f‹w
;

218 
hâab
.
d_a˘ive
 = 0;

219 
	`iod⁄e
(
bp
);

220 
bp
->
b_ªsid
 = 
HTADDR
->
htfc
;

222 
h_blkno
[
unô
] = 
bp
->
b_blkno
;

223 
	`ht°¨t
();

224 
	}
}

226 
	$håód
(
dev
)

228 
	`hçhys
(
dev
);

229 
	`physio
(
ht°øãgy
, &
rhtbuf
, 
dev
, 
B_READ
);

230 
u
.
u_cou¡
 = -
rhtbuf
.
b_ªsid
;

231 
	}
}

233 
	$htwrôe
(
dev
)

235 
	`hçhys
(
dev
);

236 
	`physio
(
ht°øãgy
, &
rhtbuf
, 
dev
, 
B_WRITE
);

237 
u
.
u_cou¡
 = 0;

238 
	}
}

240 
	$hçhys
(
dev
)

242 
unô
, 
a
;

244 
unô
 = 
dev
.
d_mö‹
;

245 
a
 = 
	`lshi·
(
u
.
u_off£t
, -9);

246 
h_blkno
[
unô
] = 
a
;

247 
h_nxªc
[
unô
] = ++
a
;

248 
	}
}

	@dmr/kl.c

8 
	~"../∑øm.h
"

9 
	~"../c⁄f.h
"

10 
	~"../u£r.h
"

11 
	~"../ây.h
"

12 
	~"../¥oc.h
"

15 
	#KLADDR
 0177560

	)

16 
	#KLBASE
 0176500

	)

17 
	#DLBASE
 0175610

	)

18 
	#NKL11
 1

	)

19 
	#NDL11
 0

	)

20 
	#DSRDY
 02

	)

21 
	#RDRENB
 01

	)

23 
ây
 
	gkl11
[
NKL11
+
NDL11
];

25 
	skÃegs
 {

26 
	mkÃc§
;

27 
	mkÃbuf
;

28 
	mk…c§
;

29 
	mk…buf
;

32 
	$kl›í
(
dev
, 
Êag
)

34 *
addr
;

35 
ây
 *
ç
;

37 if(
dev
.
d_mö‹
 >
NKL11
+
NDL11
) {

38 
u
.
u_îr‹
 = 
ENXIO
;

41 
ç
 = &
kl11
[
dev
.
d_mö‹
];

42 i‡(
u
.
u_¥o˝
->
p_âyp
 == 0) {

43 
u
.
u_¥o˝
->
p_âyp
 = 
ç
;

44 
ç
->
t_dev
 = 
dev
;

51 
addr
 = 
KLADDR
 + 8*
dev
.
d_mö‹
;

52 if(
dev
.
d_mö‹
)

53 
addr
 =+ 
KLBASE
-
KLADDR
-8;

54 if(
dev
.
d_mö‹
 >
NKL11
)

55 
addr
 =+ 
DLBASE
-
KLBASE
-8*
NKL11
+8;

56 
ç
->
t_addr
 = 
addr
;

57 i‡((
ç
->
t_°©e
&
ISOPEN
) == 0) {

58 
ç
->
t_°©e
 = 
ISOPEN
|
CARR_ON
;

59 
ç
->
t_Êags
 = 
XTABS
|
LCASE
|
ECHO
|
CRMOD
;

60 
ç
->
t_îa£
 = 
CERASE
;

61 
ç
->
t_kûl
 = 
CKILL
;

63 
addr
->
kÃc§
 =| 
IENABLE
|
DSRDY
|
RDRENB
;

64 
addr
->
k…c§
 =| 
IENABLE
;

65 
	}
}

67 
	$kl˛o£
(
dev
)

69 
ây
 *
ç
;

71 
ç
 = &
kl11
[
dev
.
d_mö‹
];

72 
	`wÊushây
(
ç
);

73 
ç
->
t_°©e
 = 0;

74 
	}
}

76 
	$kÃód
(
dev
)

78 
	`âªad
(&
kl11
[
dev
.
d_mö‹
]);

79 
	}
}

81 
	$klwrôe
(
dev
)

83 
	`âwrôe
(&
kl11
[
dev
.
d_mö‹
]);

84 
	}
}

86 
	$klxöt
(
dev
)

88 
ây
 *
ç
;

90 
ç
 = &
kl11
[
dev
.
d_mö‹
];

91 
	`â°¨t
(
ç
);

92 i‡(
ç
->
t_outq
.
c_cc
 =0 ||Åp->t_outq.c_c¯=
TTLOWAT
)

93 
	`wakeup
(&
ç
->
t_outq
);

94 
	}
}

96 
	$kÃöt
(
dev
)

98 
c
, *
addr
;

99 
ây
 *
ç
;

101 
ç
 = &
kl11
[
dev
.
d_mö‹
];

102 
addr
 = 
ç
->
t_addr
;

103 
c
 = 
addr
->
kÃbuf
;

104 
addr
->
kÃc§
 =| 
RDRENB
;

105 i‡((
c
&0177)==0)

106 
addr
->
k…buf
 = 
c
;

107 
	`âyöput
(
c
, 
ç
);

108 
	}
}

110 
	$klsgây
(
dev
, 
v
)

111 *
v
;

113 
ây
 *
ç
;

115 
ç
 = &
kl11
[
dev
.
d_mö‹
];

116 
	`ây°ty
(
ç
, 
v
);

117 
	}
}

	@dmr/lp.c

9 
	~"../∑øm.h
"

10 
	~"../c⁄f.h
"

11 
	~"../u£r.h
"

13 
	#LPADDR
 0177514

	)

15 
	#IENABLE
 0100

	)

16 
	#DONE
 0200

	)

18 
	#LPPRI
 10

	)

19 
	#LPLWAT
 50

	)

20 
	#LPHWAT
 100

	)

21 
	#EJLINE
 60

	)

22 
	#MAXCOL
 80

	)

25 
	mÕ§
;

26 
	mÕbuf
;

30 
	mcc
;

31 
	mcf
;

32 
	m˛
;

33 
	mÊag
;

34 
	mmcc
;

35 
	mccc
;

36 
	mmlc
;

37 } 
	gÕ11
;

39 
	#CAP
 01

	)

40 
	#EJECT
 02

	)

41 
	#OPEN
 04

	)

42 
	#IND
 010

	)

44 
	#FORM
 014

	)

46 
	$Õ›í
(
dev
, 
Êag
)

49 if(
Õ11
.
Êag
 & 
OPEN
 || 
LPADDR
->
Õ§
 < 0) {

50 
u
.
u_îr‹
 = 
EIO
;

53 
Õ11
.
Êag
 =| (
IND
|
EJECT
|
OPEN
);

54 
LPADDR
->
Õ§
 =| 
IENABLE
;

55 
	`Õˇn⁄
(
FORM
);

56 
	}
}

58 
	$Õ˛o£
(
dev
, 
Êag
)

60 
	`Õˇn⁄
(
FORM
);

61 
Õ11
.
Êag
 = 0;

62 
	}
}

64 
	$Õwrôe
()

66 
c
;

68 (
c
=
	`˝ass
())>=0)

69 
	`Õˇn⁄
(
c
);

70 
	}
}

72 
	$Õˇn⁄
(
c
)

74 
c1
, 
c2
;

76 
c1
 = 
c
;

77 if(
Õ11
.
Êag
&
CAP
) {

78 if(
c1
>='a' && c1<='z')

79 
c1
 =+ 'A'-'a'; 

80 
c1
) {

83 
c2
 = '(';

84 
esc
;

87 
c2
 = ')';

88 
esc
;

91 
c2
 = '\'';

92 
esc
;

95 
c2
 = '!';

96 
esc
;

99 
c2
 = '^';

101 
esc
:

102 
	`Õˇn⁄
(
c2
);

103 
Õ11
.
ccc
--;

104 
c1
 = '-';

108 
c1
) {

111 
Õ11
.
ccc
 = (lp11.ccc+8) & ~7;

114 
FORM
:

116 if((
Õ11
.
Êag
&
EJECT
) == 0 ||

117 
Õ11
.
mcc
!=0 ||Üp11.
mlc
!=0) {

118 
Õ11
.
mcc
 = 0;

119 
Õ11
.
mlc
++;

120 if(
Õ11
.
mlc
 >
EJLINE
 &&Üp11.
Êag
&
EJECT
)

121 
c1
 = 
FORM
;

122 
	`Õouçut
(
c1
);

123 if(
c1
 =
FORM
)

124 
Õ11
.
mlc
 = 0;

128 
Õ11
.
ccc
 = 0;

129 if(
Õ11
.
Êag
&
IND
)

130 
Õ11
.
ccc
 = 8;

134 if(
Õ11
.
ccc
 > 0)

135 
Õ11
.
ccc
--;

139 
Õ11
.
ccc
++;

143 if(
Õ11
.
ccc
 <Üp11.
mcc
) {

144 
	`Õouçut
('\r');

145 
Õ11
.
mcc
 = 0;

147 if(
Õ11
.
ccc
 < 
MAXCOL
) {

148 
Õ11
.
ccc
 >Üp11.
mcc
) {

149 
	`Õouçut
(' ');

150 
Õ11
.
mcc
++;

152 
	`Õouçut
(
c1
);

153 
Õ11
.
mcc
++;

155 
Õ11
.
ccc
++;

157 
	}
}

159 
	$Õ°¨t
()

161 
c
;

163 
LPADDR
->
Õ§
&
DONE
 && (
c
 = 
	`gëc
(&
Õ11
)) >= 0)

164 
LPADDR
->
Õbuf
 = 
c
;

165 
	}
}

167 
	$Õöt
()

169 
c
;

171 
	`Õ°¨t
();

172 i‡(
Õ11
.
cc
 =
LPLWAT
 ||Üp11.cc == 0)

173 
	`wakeup
(&
Õ11
);

174 
	}
}

176 
	$Õouçut
(
c
)

178 i‡(
Õ11
.
cc
 >
LPHWAT
)

179 
	`¶ìp
(&
Õ11
, 
LPPRI
);

180 
	`putc
(
c
, &
Õ11
);

181 
	`•l4
();

182 
	`Õ°¨t
();

183 
	`•l0
();

184 
	}
}

	@dmr/mem.c

12 
	~"../∑øm.h
"

13 
	~"../u£r.h
"

14 
	~"../c⁄f.h
"

15 
	~"../£g.h
"

17 
	$mmªad
(
dev
)

19 
c
, 
bn
, 
⁄
;

20 
a
, 
d
;

22 if(
dev
.
d_mö‹
 == 2)

25 
bn
 = 
	`lshi·
(
u
.
u_off£t
, -6);

26 
⁄
 = 
u
.
u_off£t
[1] & 077;

27 
a
 = 
UISA
->
r
[0];

28 
d
 = 
UISD
->
r
[0];

29 
	`•l7
();

30 
UISA
->
r
[0] = 
bn
;

31 
UISD
->
r
[0] = 077406;

32 if(
dev
.
d_mö‹
 == 1)

33 
UISA
->
r
[0] = (
ka6
-6)->r[(
bn
>>7)&07] + (bn & 0177);

34 
c
 = 
	`fuibyã
(
⁄
);

35 
UISA
->
r
[0] = 
a
;

36 
UISD
->
r
[0] = 
d
;

37 
	`•l0
();

38 } 
u
.
u_îr‹
==0 && 
	`∑ssc
(
c
)>=0);

39 
	}
}

41 
	$mmwrôe
(
dev
)

43 
c
, 
bn
, 
⁄
;

44 
a
, 
d
;

46 if(
dev
.
d_mö‹
 == 2) {

47 
c
 = 
u
.
u_cou¡
;

48 
u
.
u_cou¡
 = 0;

49 
u
.
u_ba£
 =+ 
c
;

50 
	`d∑dd
(
u
.
u_off£t
, 
c
);

54 
bn
 = 
	`lshi·
(
u
.
u_off£t
, -6);

55 
⁄
 = 
u
.
u_off£t
[1] & 077;

56 i‡((
c
=
	`˝ass
())<0 || 
u
.
u_îr‹
!=0)

58 
a
 = 
UISA
->
r
[0];

59 
d
 = 
UISD
->
r
[0];

60 
	`•l7
();

61 
UISA
->
r
[0] = 
bn
;

62 
UISD
->
r
[0] = 077406;

63 if(
dev
.
d_mö‹
 == 1)

64 
UISA
->
r
[0] = (
ka6
-6)->r[(
bn
>>7)&07] + (bn & 0177);

65 
	`suibyã
(
⁄
, 
c
);

66 
UISA
->
r
[0] = 
a
;

67 
UISD
->
r
[0] = 
d
;

68 
	`•l0
();

70 
	}
}

	@dmr/partab.c

4 
	g∑πab
[] {

	@dmr/pc.c

9 
	~"../∑øm.h
"

10 
	~"../c⁄f.h
"

11 
	~"../u£r.h
"

13 
	#PCADDR
 0177550

	)

15 
	#CLOSED
 0

	)

16 
	#WAITING
 1

	)

17 
	#READING
 2

	)

18 
	#EOF
 3

	)

20 
	#RDRENB
 01

	)

21 
	#IENABLE
 0100

	)

22 
	#DONE
 0200

	)

23 
	#BUSY
 04000

	)

24 
	#ERROR
 0100000

	)

26 
	#PCIPRI
 30

	)

27 
	#PCOPRI
 40

	)

28 
	#PCOLWAT
 50

	)

29 
	#PCOHWAT
 100

	)

30 
	#PCIHWAT
 250

	)

33 
	mp¸c§
;

34 
	mp¸buf
;

35 
	mp˝c§
;

36 
	mp˝buf
;

39 
	s˛i°
 {

40 
	mcc
;

41 
	mcf
;

42 
	m˛
;

45 
	spc11
 {

46 
	mpc°©e
;

47 
˛i°
 
	mpcö
;

48 
˛i°
 
	mpcout
;

49 } 
	gpc11
;

51 
	$pc›í
(
dev
, 
Êag
)

53 
lbﬁt
;

55 i‡(
Êag
==0) {

56 i‡(
pc11
.
pc°©e
!=
CLOSED
) {

57 
u
.
u_îr‹
 = 
ENXIO
;

60 
pc11
.
pc°©e
 = 
WAITING
;

61 
pc11
.
pc°©e
==
WAITING
) {

62 
PCADDR
->
p¸c§
 = 
IENABLE
|
RDRENB
;

63 
	`¶ìp
(&
lbﬁt
, 
PCIPRI
);

66 
PCADDR
->
p˝c§
 =| 
IENABLE
;

67 
	`p˛ódî
();

69 
	}
}

71 
	$pc˛o£
(
dev
, 
Êag
)

73 i‡(
Êag
==0) {

74 
	`•l4
();

75 
	`gëc
(&
pc11
.
pcö
) >= 0);

76 
PCADDR
->
p¸c§
 = 0;

77 
pc11
.
pc°©e
 = 
CLOSED
;

78 
	`•l0
();

80 
	`p˛ódî
();

81 
	}
}

83 
	$p¸ód
()

85 
c
;

87 
	`•l4
();

89 (
c
 = 
	`gëc
(&
pc11
.
pcö
)) < 0) {

90 i‡(
pc11
.
pc°©e
==
EOF
)

91 
out
;

92 i‡((
PCADDR
->
p¸c§
&(
ERROR
|
BUSY
|
DONE
))==0)

93 
PCADDR
->
p¸c§
 =| 
IENABLE
|
RDRENB
;

94 
	`¶ìp
(&
pc11
.
pcö
, 
PCIPRI
);

96 } 
	`∑ssc
(
c
)>=0);

97 
out
:

98 
	`•l0
();

99 
	}
}

101 
	$pcwrôe
()

103 
c
;

105 (
c
=
	`˝ass
())>=0)

106 
	`pcouçut
(
c
);

107 
	}
}

109 
	$pc°¨t
()

111 
c
;

113 i‡(
PCADDR
->
p˝c§
&
DONE
 && (
c
 = 
	`gëc
(&
pc11
.
pcout
)) >= 0)

114 
PCADDR
->
p˝buf
 = 
c
;

115 
	}
}

117 
	$p¸öt
()

119 i‡(
pc11
.
pc°©e
==
WAITING
) {

120 i‡(
PCADDR
->
p¸c§
&
ERROR
)

122 
pc11
.
pc°©e
 = 
READING
;

124 i‡(
pc11
.
pc°©e
==
READING
) {

125 i‡(
PCADDR
->
p¸c§
&
ERROR
)

126 
pc11
.
pc°©e
 = 
EOF
;

128 
	`putc
(
PCADDR
->
p¸buf
, &
pc11
.
pcö
);

129 i‡(
pc11
.
pcö
.
cc
 < 
PCIHWAT
)

130 
PCADDR
->
p¸c§
 =| 
IENABLE
|
RDRENB
;

132 
	`wakeup
(&
pc11
.
pcö
);

134 
	}
}

136 
	$p˝öt
()

139 
	`pc°¨t
();

140 i‡(
pc11
.
pcout
.
cc
 <
PCOLWAT
)

141 
	`wakeup
(&
pc11
.
pcout
);

142 
	}
}

144 
	$pcouçut
(
c
)

146 i‡(
PCADDR
->
p˝c§
&
ERROR
) {

147 
u
.
u_îr‹
 = 
EIO
;

150 i‡(
pc11
.
pcout
.
cc
 >
PCOHWAT
)

151 
	`¶ìp
(&
pc11
.
pcout
, 
PCOPRI
);

152 
	`putc
(
c
, &
pc11
.
pcout
);

153 
	`•l4
();

154 
	`pc°¨t
();

155 
	`•l0
();

156 
	}
}

158 
	$p˛ódî
()

160 
i
;

162 
i
 = 100;

164 
	`pcouçut
(0);

165 --
i
);

166 
	}
}

	@dmr/rf.c

9 
	~"../∑øm.h
"

10 
	~"../buf.h
"

11 
	~"../c⁄f.h
"

12 
	~"../u£r.h
"

15 
	mrfcs
;

16 
	mrfwc
;

17 
	mrfba
;

18 
	mrfda
;

19 
	mrfd´
;

22 
devèb
 
	gr·ab
;

23 
buf
 
	gºfbuf
;

25 
	#NRFBLK
 1024

	)

26 
	#RFADDR
 0177460

	)

28 
	#GO
 01

	)

29 
	#RCOM
 02

	)

30 
	#WCOM
 04

	)

31 
	#CTLCLR
 0400

	)

32 
	#IENABLE
 0100

	)

34 
	$rf°øãgy
(
abp
)

35 
buf
 *
abp
;

37 
buf
 *
bp
;

39 
bp
 = 
abp
;

40 if(
bp
->
b_Êags
&
B_PHYS
)

41 
	`m≠Æloc
(
bp
);

42 i‡(
bp
->
b_blkno
 >
NRFBLK
*(bp->
b_dev
.
d_mö‹
+1)) {

43 
bp
->
b_Êags
 =| 
B_ERROR
;

44 
	`iod⁄e
(
bp
);

47 
bp
->
av_f‹w
 = 0;

48 
	`•l5
();

49 i‡(
r·ab
.
d_a˘f
==0)

50 
r·ab
.
d_a˘f
 = 
bp
;

52 
r·ab
.
d_a˘l
->
av_f‹w
 = 
bp
;

53 
r·ab
.
d_a˘l
 = 
bp
;

54 i‡(
r·ab
.
d_a˘ive
==0)

55 
	`rf°¨t
();

56 
	`•l0
();

57 
	}
}

59 
	$rf°¨t
()

61 
buf
 *
bp
;

63 i‡((
bp
 = 
r·ab
.
d_a˘f
) == 0)

65 
r·ab
.
d_a˘ive
++;

66 
RFADDR
->
rfd´
 = 
bp
->
b_blkno
.
hibyã
;

67 
	`dev°¨t
(
bp
, &
RFADDR
->
rfda
, bp->
b_blkno
<<8, 0);

68 
	}
}

70 
	$rföå
()

72 
buf
 *
bp
;

74 i‡(
r·ab
.
d_a˘ive
 == 0)

76 
bp
 = 
r·ab
.
d_a˘f
;

77 
r·ab
.
d_a˘ive
 = 0;

78 i‡(
RFADDR
->
rfcs
 < 0) {

79 
	`devîr‹
(
bp
, 
RFADDR
->
rfcs
, RFADDR->
rfd´
);

80 
RFADDR
->
rfcs
 = 
CTLCLR
;

81 i‡(++
r·ab
.
d_îr˙t
 <= 10) {

82 
	`rf°¨t
();

85 
bp
->
b_Êags
 =| 
B_ERROR
;

87 
r·ab
.
d_îr˙t
 = 0;

88 
r·ab
.
d_a˘f
 = 
bp
->
av_f‹w
;

89 
	`iod⁄e
(
bp
);

90 
	`rf°¨t
();

91 
	}
}

93 
	$r‰ód
(
dev
)

96 
	`physio
(
rf°øãgy
, &
ºfbuf
, 
dev
, 
B_READ
);

97 
	}
}

99 
	$rfwrôe
(
dev
)

102 
	`physio
(
rf°øãgy
, &
ºfbuf
, 
dev
, 
B_WRITE
);

103 
	}
}

	@dmr/rk.c

9 
	~"../∑øm.h
"

10 
	~"../buf.h
"

11 
	~"../c⁄f.h
"

12 
	~"../u£r.h
"

14 
	#RKADDR
 0177400

	)

15 
	#NRK
 4

	)

16 
	#NRKBLK
 4872

	)

18 
	#RESET
 0

	)

19 
	#GO
 01

	)

20 
	#DRESET
 014

	)

21 
	#IENABLE
 0100

	)

22 
	#DRY
 0200

	)

23 
	#ARDY
 0100

	)

24 
	#WLO
 020000

	)

25 
	#CTLRDY
 0200

	)

28 
	mrkds
;

29 
	mrkî
;

30 
	mrkcs
;

31 
	mrkwc
;

32 
	mrkba
;

33 
	mrkda
;

36 
devèb
 
	grkèb
;

37 
buf
 
	gºkbuf
;

39 
	$rk°øãgy
(
abp
)

40 
buf
 *
abp
;

42 
buf
 *
bp
;

43 *
qc
, *
ql
;

44 
d
;

46 
bp
 = 
abp
;

47 if(
bp
->
b_Êags
&
B_PHYS
)

48 
	`m≠Æloc
(
bp
);

49 
d
 = 
bp
->
b_dev
.
d_mö‹
-7;

50 if(
d
 <= 0)

51 
d
 = 1;

52 i‡(
bp
->
b_blkno
 >
NRKBLK
*
d
) {

53 
bp
->
b_Êags
 =| 
B_ERROR
;

54 
	`iod⁄e
(
bp
);

57 
bp
->
av_f‹w
 = 0;

58 
	`•l5
();

59 i‡(
rkèb
.
d_a˘f
==0)

60 
rkèb
.
d_a˘f
 = 
bp
;

62 
rkèb
.
d_a˘l
->
av_f‹w
 = 
bp
;

63 
rkèb
.
d_a˘l
 = 
bp
;

64 i‡(
rkèb
.
d_a˘ive
==0)

65 
	`rk°¨t
();

66 
	`•l0
();

67 
	}
}

69 
	$rkaddr
(
bp
)

70 
buf
 *
bp
;

72 
buf
 *
p
;

73 
b
;

74 
d
, 
m
;

76 
p
 = 
bp
;

77 
b
 = 
p
->
b_blkno
;

78 
m
 = 
p
->
b_dev
.
d_mö‹
 - 7;

79 if(
m
 <= 0)

80 
d
 = 
p
->
b_dev
.
d_mö‹
;

82 
d
 = 
	`Ãem
(
b
, 
m
);

83 
b
 = 
	`ldiv
(b, 
m
);

85 (
d
<<13 | (
b
/12)<<4 | b%12);

86 
	}
}

88 
	$rk°¨t
()

90 
buf
 *
bp
;

92 i‡((
bp
 = 
rkèb
.
d_a˘f
) == 0)

94 
rkèb
.
d_a˘ive
++;

95 
	`dev°¨t
(
bp
, &
RKADDR
->
rkda
, 
	`rkaddr
(bp), 0);

96 
	}
}

98 
	$rköå
()

100 
buf
 *
bp
;

102 i‡(
rkèb
.
d_a˘ive
 == 0)

104 
bp
 = 
rkèb
.
d_a˘f
;

105 
rkèb
.
d_a˘ive
 = 0;

106 i‡(
RKADDR
->
rkcs
 < 0) {

107 
	`devîr‹
(
bp
, 
RKADDR
->
rkî
, RKADDR->
rkds
);

108 
RKADDR
->
rkcs
 = 
RESET
|
GO
;

109 (
RKADDR
->
rkcs
&
CTLRDY
) == 0) ;

110 i‡(++
rkèb
.
d_îr˙t
 <= 10) {

111 
	`rk°¨t
();

114 
bp
->
b_Êags
 =| 
B_ERROR
;

116 
rkèb
.
d_îr˙t
 = 0;

117 
rkèb
.
d_a˘f
 = 
bp
->
av_f‹w
;

118 
	`iod⁄e
(
bp
);

119 
	`rk°¨t
();

120 
	}
}

122 
	$rkªad
(
dev
)

125 
	`physio
(
rk°øãgy
, &
ºkbuf
, 
dev
, 
B_READ
);

126 
	}
}

128 
	$rkwrôe
(
dev
)

131 
	`physio
(
rk°øãgy
, &
ºkbuf
, 
dev
, 
B_WRITE
);

132 
	}
}

	@dmr/rp.c

9 
	~"../∑øm.h
"

10 
	~"../buf.h
"

11 
	~"../c⁄f.h
"

12 
	~"../u£r.h
"

15 
	mΩds
;

16 
	mΩî
;

17 
	mΩcs
;

18 
	mΩwc
;

19 
	mΩba
;

20 
	mΩˇ
;

21 
	mΩda
;

24 
	#RPADDR
 0176710

	)

25 
	#NRP
 8

	)

28 *
	mnblocks
;

29 
	mcyloff
;

30 } 
	gΩ_sizes
[] {

41 
devèb
 
	gΩèb
;

42 
buf
 
	gºpbuf
;

44 
	#GO
 01

	)

45 
	#RESET
 0

	)

46 
	#HSEEK
 014

	)

48 
	#IENABLE
 0100

	)

49 
	#READY
 0200

	)

51 
	#SUFU
 01000

	)

52 
	#SUSU
 02000

	)

53 
	#SUSI
 04000

	)

54 
	#HNF
 010000

	)

61 
	#åk£c
 
av_back


	)

62 
	#cylö
 
b_ªsid


	)

64 
	$Ω°øãgy
(
abp
)

65 
buf
 *
abp
;

67 
buf
 *
bp
;

68 *
p1
, *
p2
;

70 
bp
 = 
abp
;

71 if(
bp
->
b_Êags
&
B_PHYS
)

72 
	`m≠Æloc
(
bp
);

73 
p1
 = &
Ω_sizes
[
bp
->
b_dev
.
d_mö‹
&07];

74 i‡(
bp
->
b_dev
.
d_mö‹
 >(
NRP
<<3) ||

75 
bp
->
b_blkno
 >
p1
->
nblocks
) {

76 
bp
->
b_Êags
 =| 
B_ERROR
;

77 
	`iod⁄e
(
bp
);

80 
bp
->
av_f‹w
 = 0;

81 
bp
->
cylö
 = 
p1
->
cyloff
;

82 
p1
 = 
bp
->
b_blkno
;

83 
p2
 = 
	`Ãem
(
p1
, 10);

84 
p1
 = 
	`ldiv
(p1, 10);

85 
bp
->
åk£c
 = (
p1
%20)<<8 | 
p2
;

86 
bp
->
cylö
 =+ 
p1
/20;

87 
	`•l5
();

88 i‡((
p1
 = 
Ωèb
.
d_a˘f
)==0)

89 
Ωèb
.
d_a˘f
 = 
bp
;

91 ; 
p2
 = 
p1
->
av_f‹w
;Ö1 =Ö2) {

92 i‡(
p1
->
cylö
 <
bp
->cylin

93 && 
bp
->
cylö
 < 
p2
->cylin

94 || 
p1
->
cylö
 >
bp
->cylin

95 && 
bp
->
cylö
 > 
p2
->cylin)

98 
bp
->
av_f‹w
 = 
p2
;

99 
p1
->
av_f‹w
 = 
bp
;

101 i‡(
Ωèb
.
d_a˘ive
==0)

102 
	`Ω°¨t
();

103 
	`•l0
();

104 
	}
}

106 
	$Ω°¨t
()

108 
buf
 *
bp
;

110 i‡((
bp
 = 
Ωèb
.
d_a˘f
) == 0)

112 
Ωèb
.
d_a˘ive
++;

113 
RPADDR
->
Ωda
 = 
bp
->
åk£c
;

114 
	`dev°¨t
(
bp
, &
RPADDR
->
Ωˇ
, bp->
cylö
, bp->
b_dev
.
d_mö‹
>>3);

115 
	}
}

117 
	$Ωöå
()

119 
buf
 *
bp
;

120 
˘r
;

122 i‡(
Ωèb
.
d_a˘ive
 == 0)

124 
bp
 = 
Ωèb
.
d_a˘f
;

125 
Ωèb
.
d_a˘ive
 = 0;

126 i‡(
RPADDR
->
Ωcs
 < 0) {

127 
	`devîr‹
(
bp
, 
RPADDR
->
Ωî
, RPADDR->
Ωds
);

128 if(
RPADDR
->
Ωds
 & (
SUFU
|
SUSI
|
HNF
)) {

129 
RPADDR
->
Ωcs
.
lobyã
 = 
HSEEK
|
GO
;

130 
˘r
 = 0;

131 (
RPADDR
->
Ωds
&
SUSU
Ë&& --
˘r
);

133 
RPADDR
->
Ωcs
 = 
RESET
|
GO
;

134 
˘r
 = 0;

135 (
RPADDR
->
Ωcs
&
READY
Ë=0 && --
˘r
);

136 i‡(++
Ωèb
.
d_îr˙t
 <= 10) {

137 
	`Ω°¨t
();

140 
bp
->
b_Êags
 =| 
B_ERROR
;

142 
Ωèb
.
d_îr˙t
 = 0;

143 
Ωèb
.
d_a˘f
 = 
bp
->
av_f‹w
;

144 
bp
->
b_ªsid
 = 
RPADDR
->
Ωwc
;

145 
	`iod⁄e
(
bp
);

146 
	`Ω°¨t
();

147 
	}
}

149 
	$Ωªad
(
dev
)

152 if(
	`Ωphys
(
dev
))

153 
	`physio
(
Ω°øãgy
, &
ºpbuf
, 
dev
, 
B_READ
);

154 
	}
}

156 
	$Ωwrôe
(
dev
)

159 if(
	`Ωphys
(
dev
))

160 
	`physio
(
Ω°øãgy
, &
ºpbuf
, 
dev
, 
B_WRITE
);

161 
	}
}

163 
	$Ωphys
(
dev
)

165 
c
;

167 
c
 = 
	`lshi·
(
u
.
u_off£t
, -9);

168 
c
 =+ 
	`ldiv
(
u
.
u_cou¡
+511, 512);

169 if(
c
 > 
Ω_sizes
[
dev
.
d_mö‹
 & 07].
nblocks
) {

170 
u
.
u_îr‹
 = 
ENXIO
;

174 
	}
}

	@dmr/sys.c

8 
	~"../∑øm.h
"

9 
	~"../c⁄f.h
"

10 
	~"../u£r.h
"

11 
	~"../ây.h
"

12 
	~"../¥oc.h
"

14 
	$sy›í
(
dev
, 
Êag
)

16 *
ç
;

18 if(
ç
 = 
	`syâyp
())

19 (*
cdevsw
[
ç
->
t_dev
.
d_maj‹
].
d_›í
)—p->t_dev, 
Êag
);

20 
	}
}

22 
	$syªad
(
dev
)

24 *
ç
;

26 if(
ç
 = 
	`syâyp
())

27 (*
cdevsw
[
ç
->
t_dev
.
d_maj‹
].
d_ªad
)(tp->t_dev);

28 
	}
}

30 
	$sywrôe
(
dev
)

32 *
ç
;

34 if(
ç
 = 
	`syâyp
())

35 (*
cdevsw
[
ç
->
t_dev
.
d_maj‹
].
d_wrôe
)(tp->t_dev);

36 
	}
}

38 
	$sysgây
(
dev
, 
Êag
)

40 *
ç
;

42 if(
ç
 = 
	`syâyp
())

43 (*
cdevsw
[
ç
->
t_dev
.
d_maj‹
].
d_sgây
)—p->t_dev, 
Êag
);

44 
	}
}

46 
	$syâyp
()

48 
ç
;

50 
ç
 = 
u
.
u_¥o˝
->
p_âyp
;

51 if(
ç
 =
NULL
)

52 
u
.
u_îr‹
 = 
ENXIO
;

53 (
ç
);

54 
	}
}

	@dmr/tc.c

9 
	~"../∑øm.h
"

10 
	~"../c⁄f.h
"

11 
	~"../buf.h
"

12 
	~"../u£r.h
"

15 
	mtcc§
;

16 
	mtccm
;

17 
	mtcwc
;

18 
	mtcba
;

19 
	mtcdt
;

22 
devèb
 
	gt˘ab
;

23 
	gt˝î
[8];

25 
	#TCADDR
 0177340

	)

26 
	#NTCBLK
 578

	)

28 
	#TAPERR
 0100000

	)

29 
	#TREV
 04000

	)

30 
	#READY
 0200

	)

31 
	#IENABLE
 0100

	)

32 
	#UPS
 0200

	)

33 
	#ENDZ
 0100000

	)

34 
	#BLKM
 02000

	)

35 
	#ILGOP
 010000

	)

36 
	#SELERR
 04000

	)

38 
	#SAT
 0

	)

39 
	#RNUM
 02

	)

40 
	#RDATA
 04

	)

41 
	#SST
 010

	)

42 
	#WDATA
 014

	)

43 
	#GO
 01

	)

45 
	#SFORW
 1

	)

46 
	#SREV
 2

	)

47 
	#SIO
 3

	)

49 
	$tc˛o£
(
dev
)

51 
	`bÊush
(
dev
);

52 
t˝î
[
dev
&07] = 0;

53 
	}
}

55 
	$tc°øãgy
(
abp
)

56 
buf
 *
abp
;

58 
buf
 *
bp
;

60 
bp
 = 
abp
;

61 if(
bp
->
b_Êags
&
B_PHYS
)

62 
	`m≠Æloc
(
bp
);

63 if(
bp
->
b_blkno
 >
NTCBLK
 || 
t˝î
[bp->
b_dev
&07]) {

64 
bp
->
b_Êags
 =| 
B_ERROR
;

65 
	`iod⁄e
(
bp
);

68 
bp
->
av_f‹w
 = 0;

69 
	`•l6
();

70 i‡(
t˘ab
.
d_a˘f
==0)

71 
t˘ab
.
d_a˘f
 = 
bp
;

73 
t˘ab
.
d_a˘l
->
av_f‹w
 = 
bp
;

74 
t˘ab
.
d_a˘l
 = 
bp
;

75 i‡(
t˘ab
.
d_a˘ive
==0)

76 
	`tc°¨t
();

77 
	`•l0
();

78 
	}
}

80 
	$tc°¨t
()

82 
buf
 *
bp
;

83 *
tccmp
, 
com
;

85 
lo›
:

86 
tccmp
 = &
TCADDR
->
tccm
;

87 i‡((
bp
 = 
t˘ab
.
d_a˘f
) == 0)

89 if(
t˝î
[
bp
->
b_dev
&07]) {

90 if((
t˘ab
.
d_a˘f
 = 
bp
->
av_f‹w
) == 0)

91 (*
tccmp
).
lobyã
 = 
SAT
|
GO
;

92 
bp
->
b_Êags
 =| 
B_ERROR
;

93 
	`iod⁄e
(
bp
);

94 
lo›
;

96 i‡(((*
tccmp
).
hibyã
&07Ë!
bp
->
b_dev
.
d_mö‹
)

97 (*
tccmp
).
lobyã
 = 
SAT
|
GO
;

98 
t˘ab
.
d_îr˙t
 = 20;

99 
t˘ab
.
d_a˘ive
 = 
SFORW
;

100 
com
 = (
bp
->
b_dev
.
d_mö‹
<<8Ë| 
IENABLE
|
RNUM
|
GO
;

101 i‡((
TCADDR
->
tcc§
 & 
UPS
) == 0) {

102 
com
 =| 
TREV
;

103 
t˘ab
.
d_a˘ive
 = 
SREV
;

105 *
tccmp
 = 
com
;

106 
	}
}

108 
	$tcöå
()

110 
buf
 *
bp
;

111 *
tccmp
;

112 *
tcdç
;

114 
tccmp
 = &
TCADDR
->
tccm
;

115 
tcdç
 = &
TCADDR
->
tcc§
;

116 
bp
 = 
t˘ab
.
d_a˘f
;

117 i‡(*
tccmp
&
TAPERR
) {

118 if((*
tcdç
&(
ENDZ
|
BLKM
)) == 0)

119 
	`devîr‹
(
bp
, *
tcdç
, 0);

120 if(*
tcdç
 & (
ILGOP
|
SELERR
)) {

121 
t˝î
[
bp
->
b_dev
&07]++;

122 
t˘ab
.
d_îr˙t
 = 0;

124 *
tccmp
 =& ~
TAPERR
;

125 i‡(--
t˘ab
.
d_îr˙t
 <= 0) {

126 
bp
->
b_Êags
 =| 
B_ERROR
;

127 
d⁄e
;

129 i‡(*
tccmp
&
TREV
) {

130 
£tf‹w
:

131 
t˘ab
.
d_a˘ive
 = 
SFORW
;

132 *
tccmp
 =& ~
TREV
;

134 
£tback
:

135 
t˘ab
.
d_a˘ive
 = 
SREV
;

136 *
tccmp
 =| 
TREV
;

138 (*
tccmp
).
lobyã
 = 
IENABLE
|
RNUM
|
GO
;

141 
tcdç
 = &
TCADDR
->
tcdt
;

142 
t˘ab
.
d_a˘ive
) {

144 
SIO
:

145 
d⁄e
:

146 
t˘ab
.
d_a˘ive
 = 0;

147 i‡(
t˘ab
.
d_a˘f
 = 
bp
->
av_f‹w
)

148 
	`tc°¨t
();

150 
TCADDR
->
tccm
.
lobyã
 = 
SAT
|
GO
;

151 
	`iod⁄e
(
bp
);

154 
SFORW
:

155 i‡(*
tcdç
 > 
bp
->
b_blkno
)

156 
£tback
;

157 i‡(*
tcdç
 < 
bp
->
b_blkno
)

158 
£tf‹w
;

159 *--
tcdç
 = 
bp
->
b_addr
;

160 *--
tcdç
 = 
bp
->
b_wcou¡
;

161 
tccmp
->
lobyã
 = ((
bp
->
b_xmem
 & 03Ë<< 4Ë| 
IENABLE
|
GO


162 | (
bp
->
b_Êags
&
B_READ
?
RDATA
:
WDATA
);

163 
t˘ab
.
d_a˘ive
 = 
SIO
;

166 
SREV
:

167 i‡(*
tcdç
+3 > 
bp
->
b_blkno
)

168 
£tback
;

169 
£tf‹w
;

171 
	}
}

	@dmr/tm.c

9 
	~"../∑øm.h
"

10 
	~"../buf.h
"

11 
	~"../c⁄f.h
"

12 
	~"../u£r.h
"

15 
	mtmî
;

16 
	mtmcs
;

17 
	mtmbc
;

18 
	mtmba
;

19 
	mtmdb
;

20 
	mtmrd
;

23 
devèb
 
	gtmèb
;

24 
buf
 
	gπmbuf
;

26 
	gt_›íf
[8];

27 *
	gt_blkno
[8];

28 *
	gt_nxªc
[8];

30 
	#TMADDR
 0172520

	)

32 
	#GO
 01

	)

33 
	#RCOM
 02

	)

34 
	#WCOM
 04

	)

35 
	#WEOF
 06

	)

36 
	#SFORW
 010

	)

37 
	#SREV
 012

	)

38 
	#WIRG
 014

	)

39 
	#REW
 016

	)

40 
	#DENS
 060000

	)

41 
	#IENABLE
 0100

	)

42 
	#CRDY
 0200

	)

43 
	#GAPSD
 010000

	)

44 
	#TUR
 1

	)

45 
	#HARD
 0102200

	)

46 
	#EOF
 0040000

	)

48 
	#SSEEK
 1

	)

49 
	#SIO
 2

	)

51 
	$tm›í
(
dev
, 
Êag
)

53 
dmö‹
;

55 
dmö‹
 = 
dev
.
d_mö‹
;

56 i‡(
t_›íf
[
dmö‹
])

57 
u
.
u_îr‹
 = 
ENXIO
;

59 
t_›íf
[
dmö‹
]++;

60 
t_blkno
[
dmö‹
] = 0;

61 
t_nxªc
[
dmö‹
] = 65535;

63 
	}
}

65 
	$tm˛o£
(
dev
, 
Êag
)

67 
dmö‹
;

69 
dmö‹
 = 
dev
.
d_mö‹
;

70 
t_›íf
[
dmö‹
] = 0;

71 i‡(
Êag
)

72 
	`tcomm™d
(
dmö‹
, 
WEOF
);

73 
	`tcomm™d
(
dmö‹
, 
REW
);

74 
	}
}

76 
	$tcomm™d
(
unô
, 
com
)

78 
lbﬁt
;

80 
tmèb
.
d_a˘ive
 || (
TMADDR
->
tmcs
 & 
CRDY
)==0)

81 
	`¶ìp
(&
lbﬁt
, 1);

82 
TMADDR
->
tmcs
 = 
DENS
|
com
|
GO
 | (
unô
<<8);

83 
	}
}

85 
	$tm°øãgy
(
abp
)

86 
buf
 *
abp
;

88 
buf
 *
bp
;

89 **
p
;

91 
bp
 = 
abp
;

92 
p
 = &
t_nxªc
[
bp
->
b_dev
.
d_mö‹
];

93 i‡(*
p
 <
bp
->
b_blkno
) {

94 i‡(*
p
 < 
bp
->
b_blkno
) {

95 
bp
->
b_Êags
 =| 
B_ERROR
;

96 
	`iod⁄e
(
bp
);

99 i‡(
bp
->
b_Êags
&
B_READ
) {

100 
	`˛rbuf
(
bp
);

101 
	`iod⁄e
(
bp
);

105 i‡((
bp
->
b_Êags
&
B_READ
)==0)

106 *
p
 = 
bp
->
b_blkno
 + 1;

107 
bp
->
av_f‹w
 = 0;

108 
	`•l5
();

109 i‡(
tmèb
.
d_a˘f
==0)

110 
tmèb
.
d_a˘f
 = 
bp
;

112 
tmèb
.
d_a˘l
->
av_f‹w
 = 
bp
;

113 
tmèb
.
d_a˘l
 = 
bp
;

114 i‡(
tmèb
.
d_a˘ive
==0)

115 
	`tm°¨t
();

116 
	`•l0
();

117 
	}
}

119 
	$tm°¨t
()

121 
buf
 *
bp
;

122 
com
;

123 
unô
;

124 *
blkno
;

126 
lo›
:

127 i‡((
bp
 = 
tmèb
.
d_a˘f
) == 0)

129 
unô
 = 
bp
->
b_dev
.
d_mö‹
;

130 
blkno
 = 
t_blkno
[
unô
];

131 i‡(
t_›íf
[
unô
] < 0 || (
TMADDR
->
tmcs
 & 
CRDY
)==0) {

132 
bp
->
b_Êags
 =| 
B_ERROR
;

133 
tmèb
.
d_a˘f
 = 
bp
->
av_f‹w
;

134 
	`iod⁄e
(
bp
);

135 
lo›
;

137 
com
 = (
unô
<<8Ë| ((
bp
->
b_xmem
 & 03Ë<< 4Ë| 
IENABLE
|
DENS
;

138 i‡(
blkno
 !
bp
->
b_blkno
) {

139 
tmèb
.
d_a˘ive
 = 
SSEEK
;

140 i‡(
blkno
 < 
bp
->
b_blkno
) {

141 
com
 =| 
SFORW
|
GO
;

142 
TMADDR
->
tmbc
 = 
blkno
 - 
bp
->
b_blkno
;

144 i‡(
bp
->
b_blkno
 == 0)

145 
com
 =| 
REW
|
GO
;

147 
com
 =| 
SREV
|
GO
;

148 
TMADDR
->
tmbc
 = 
bp
->
b_blkno
 - 
blkno
;

151 
TMADDR
->
tmcs
 = 
com
;

154 
tmèb
.
d_a˘ive
 = 
SIO
;

155 
TMADDR
->
tmbc
 = 
bp
->
b_wcou¡
 << 1;

156 
TMADDR
->
tmba
 = 
bp
->
b_addr
;

157 
TMADDR
->
tmcs
 = 
com
 | ((
bp
->
b_Êags
&
B_READ
)? 
RCOM
|
GO
:

158 ((
tmèb
.
d_îr˙t
)? 
WIRG
|
GO
: 
WCOM
|GO));

159 
	}
}

161 
	$tmöå
()

163 
buf
 *
bp
;

164 
unô
;

166 i‡((
bp
 = 
tmèb
.
d_a˘f
)==0)

168 
unô
 = 
bp
->
b_dev
.
d_mö‹
;

169 i‡(
TMADDR
->
tmcs
 < 0) {

173 
TMADDR
->
tmrd
 & 
GAPSD
) ;

174 i‡((
TMADDR
->
tmî
&(
HARD
|
EOF
))==0 && 
tmèb
.
d_a˘ive
==
SIO
) {

175 i‡(++
tmèb
.
d_îr˙t
 < 10) {

176 
t_blkno
[
unô
]++;

177 
tmèb
.
d_a˘ive
 = 0;

178 
	`tm°¨t
();

182 if(
bp
 !&
πmbuf
 && (
TMADDR
->
tmî
&
EOF
)==0)

183 
t_›íf
[
unô
] = -1;

184 
bp
->
b_Êags
 =| 
B_ERROR
;

185 
tmèb
.
d_a˘ive
 = 
SIO
;

187 i‡(
tmèb
.
d_a˘ive
 =
SIO
) {

188 
tmèb
.
d_îr˙t
 = 0;

189 
t_blkno
[
unô
]++;

190 
tmèb
.
d_a˘f
 = 
bp
->
av_f‹w
;

191 
tmèb
.
d_a˘ive
 = 0;

192 
	`iod⁄e
(
bp
);

193 
bp
->
b_ªsid
 = 
TMADDR
->
tmbc
;

195 
t_blkno
[
unô
] = 
bp
->
b_blkno
;

196 
	`tm°¨t
();

197 
	}
}

199 
	$tmªad
(
dev
)

201 
	`tmphys
(
dev
);

202 
	`physio
(
tm°øãgy
, &
πmbuf
, 
dev
, 
B_READ
);

203 
u
.
u_cou¡
 = -
πmbuf
.
b_ªsid
;

204 
	}
}

206 
	$tmwrôe
(
dev
)

208 
	`tmphys
(
dev
);

209 
	`physio
(
tm°øãgy
, &
πmbuf
, 
dev
, 
B_WRITE
);

210 
u
.
u_cou¡
 = 0;

211 
	}
}

213 
	$tmphys
(
dev
)

215 
unô
, 
a
;

217 
unô
 = 
dev
.
d_mö‹
;

218 
a
 = 
	`lshi·
(
u
.
u_off£t
, -9);

219 
t_blkno
[
unô
] = 
a
;

220 
t_nxªc
[
unô
] = ++
a
;

221 
	}
}

	@dmr/tty.c

8 
	~"../∑øm.h
"

9 
	~"../sy°m.h
"

10 
	~"../u£r.h
"

11 
	~"../ây.h
"

12 
	~"../¥oc.h
"

13 
	~"../öode.h
"

14 
	~"../fûe.h
"

15 
	~"../ªg.h
"

16 
	~"../c⁄f.h
"

24 
	gm≠èb
[]

48 
	scblock
 {

49 
cblock
 *
	mc_√xt
;

50 
	möfo
[6];

54 
cblock
 
	gc‰ì
[
NCLIST
];

56 
cblock
 *
	gc‰ìli°
;

65 
	mârc§
;

66 
	mârbuf
;

67 
	mâtc§
;

68 
	mâtbuf
;

75 
	$gây
()

77 
v
[3];

78 *
up
, *
vp
;

80 
vp
 = 
v
;

81 
	`sgây
(
vp
);

82 i‡(
u
.
u_îr‹
)

84 
up
 = 
u
.
u_¨g
[0];

85 
	`suw‹d
(
up
, *
vp
++);

86 
	`suw‹d
(++
up
, *
vp
++);

87 
	`suw‹d
(++
up
, *
vp
++);

88 
	}
}

94 
	$°ty
()

96 *
up
;

98 
up
 = 
u
.
u_¨g
[0];

99 
u
.
u_¨g
[0] = 
	`fuw‹d
(
up
);

100 
u
.
u_¨g
[1] = 
	`fuw‹d
(++
up
);

101 
u
.
u_¨g
[2] = 
	`fuw‹d
(++
up
);

102 
	`sgây
(0);

103 
	}
}

113 
	$sgây
(
v
)

114 *
v
;

116 
fûe
 *
Â
;

117 
öode
 *
ù
;

119 i‡((
Â
 = 
	`gëf
(
u
.
u_¨0
[
R0
])Ë=
NULL
)

121 
ù
 = 
Â
->
f_öode
;

122 i‡((
ù
->
i_mode
&
IFMT
Ë!
IFCHR
) {

123 
u
.
u_îr‹
 = 
ENOTTY
;

126 (*
cdevsw
[
ù
->
i_addr
[0].
d_maj‹
].
d_sgây
)(ù->i_addr[0], 
v
);

127 
	}
}

132 
	$wÊushây
(
©p
)

133 
ây
 *
©p
;

135 
ây
 *
ç
;

137 
ç
 = 
©p
;

138 
	`•l5
();

139 
ç
->
t_outq
.
c_cc
) {

140 
ç
->
t_°©e
 =| 
ASLEEP
;

141 
	`¶ìp
(&
ç
->
t_outq
, 
TTOPRI
);

143 
	`Êushây
(
ç
);

144 
	`•l0
();

145 
	}
}

151 
	$cöô
()

153 
c˝
;

154 
cblock
 *
˝
;

155 
cdevsw
 *
cdp
;

157 
c˝
 = 
c‰ì
;

158 
˝
=(
c˝
+07)&~07; c∞<&
c‰ì
[
NCLIST
-1]; cp++) {

159 
˝
->
c_√xt
 = 
c‰ìli°
;

160 
c‰ìli°
 = 
˝
;

162 
c˝
 = 0;

163 
cdp
 = 
cdevsw
; cdp->
d_›í
; cdp++)

164 
c˝
++;

165 
nchrdev
 = 
c˝
;

166 
	}
}

171 
	$Êushây
(
©p
)

172 
ây
 *
©p
;

174 
ây
 *
ç
;

175 
•s
;

177 
ç
 = 
©p
;

178 
	`gëc
(&
ç
->
t_ˇnq
) >= 0);

179 
	`gëc
(&
ç
->
t_outq
) >= 0);

180 
	`wakeup
(&
ç
->
t_øwq
);

181 
	`wakeup
(&
ç
->
t_outq
);

182 
•s
 = 
PS
->
öãg
;

183 
	`•l5
();

184 
	`gëc
(&
ç
->
t_øwq
) >= 0);

185 
ç
->
t_dñ˘
 = 0;

186 
PS
->
öãg
 = 
•s
;

187 
	}
}

195 
	$ˇn⁄
(
©p
)

196 
ây
 *
©p
;

198 *
bp
;

199 *
bp1
;

200 
ây
 *
ç
;

201 
c
;

203 
ç
 = 
©p
;

204 
	`•l5
();

205 
ç
->
t_dñ˘
==0) {

206 i‡((
ç
->
t_°©e
&
CARR_ON
)==0)

208 
	`¶ìp
(&
ç
->
t_øwq
, 
TTIPRI
);

210 
	`•l0
();

211 
lo›
:

212 
bp
 = &
ˇn⁄b
[2];

213 (
c
=
	`gëc
(&
ç
->
t_øwq
)) >= 0) {

214 i‡(
c
==0377) {

215 
ç
->
t_dñ˘
--;

218 i‡((
ç
->
t_Êags
&
RAW
)==0) {

219 i‡(
bp
[-1]!='\\') {

220 i‡(
c
==
ç
->
t_îa£
) {

221 i‡(
bp
 > &
ˇn⁄b
[2])

222 
bp
--;

225 i‡(
c
==
ç
->
t_kûl
)

226 
lo›
;

227 i‡(
c
==
CEOT
)

230 i‡(
m≠èb
[
c
] && (m≠èb[c]==¯|| (
ç
->
t_Êags
&
LCASE
))) {

231 i‡(
bp
[-2] != '\\')

232 
c
 = 
m≠èb
[c];

233 
bp
--;

236 *
bp
++ = 
c
;

237 i‡(
bp
>=
ˇn⁄b
+
CANBSIZ
)

240 
bp1
 = 
bp
;

241 
bp
 = &
ˇn⁄b
[2];

242 
c
 = &
ç
->
t_ˇnq
;

243 
bp
<
bp1
)

244 
	`putc
(*
bp
++, 
c
);

246 
	}
}

255 
	$âyöput
(
ac
, 
©p
)

256 
ây
 *
©p
;

258 
t_Êags
, 
c
;

259 
ây
 *
ç
;

261 
ç
 = 
©p
;

262 
c
 = 
ac
;

263 
t_Êags
 = 
ç
->t_flags;

264 i‡((
c
 =& 0177Ë='\r' && 
t_Êags
&
CRMOD
)

265 
c
 = '\n';

266 i‡((
t_Êags
&
RAW
)==0 && (
c
==
CQUIT
 || c==
CINTR
)) {

267 
	`sig«l
(
ç
, 
c
==
CINTR
? 
SIGINT
:
SIGQIT
);

268 
	`Êushây
(
ç
);

271 i‡(
ç
->
t_øwq
.
c_cc
>=
TTYHOG
) {

272 
	`Êushây
(
ç
);

275 i‡(
t_Êags
&
LCASE
 && 
c
>='A' && c<='Z')

276 
c
 =+ 'a'-'A';

277 
	`putc
(
c
, &
ç
->
t_øwq
);

278 i‡(
t_Êags
&
RAW
 || 
c
=='\n' || c==004) {

279 
	`wakeup
(&
ç
->
t_øwq
);

280 i‡(
	`putc
(0377, &
ç
->
t_øwq
)==0)

281 
ç
->
t_dñ˘
++;

283 i‡(
t_Êags
&
ECHO
) {

284 
	`âyouçut
(
c
, 
ç
);

285 
	`â°¨t
(
ç
);

287 
	}
}

296 
	$âyouçut
(
ac
, 
ç
)

297 
ây
 *
ç
;

299 
c
;

300 
ây
 *
πp
;

301 *
cﬁp
;

302 
˘y≥
;

304 
πp
 = 
ç
;

305 
c
 = 
ac
&0177;

310 i‡(
c
==004 && (
πp
->
t_Êags
&
RAW
)==0)

315 i‡(
c
=='\t' && 
πp
->
t_Êags
&
XTABS
) {

317 
	`âyouçut
(' ', 
πp
);

318 
πp
->
t_cﬁ
&07);

325 i‡(
πp
->
t_Êags
&
LCASE
) {

326 
cﬁp
 = "({)}!|^~'`";

327 *
cﬁp
++)

328 if(
c
 =*
cﬁp
++) {

329 
	`âyouçut
('\\', 
πp
);

330 
c
 = 
cﬁp
[-2];

333 i‡('a'<=
c
 && c<='z')

334 
c
 =+ 'A' - 'a';

339 i‡(
c
=='\n' && 
πp
->
t_Êags
&
CRMOD
)

340 
	`âyouçut
('\r', 
πp
);

341 i‡(
	`putc
(
c
, &
πp
->
t_outq
))

351 
cﬁp
 = &
πp
->
t_cﬁ
;

352 
˘y≥
 = 
∑πab
[
c
];

353 
c
 = 0;

354 
˘y≥
&077) {

358 (*
cﬁp
)++;

366 i‡(*
cﬁp
)

367 (*
cﬁp
)--;

372 
˘y≥
 = (
πp
->
t_Êags
 >> 8) & 03;

373 if(
˘y≥
 == 1) {

374 i‡(*
cﬁp
)

375 
c
 = 
	`max
((*
cﬁp
>>4) + 3, 6);

377 if(
˘y≥
 == 2) {

378 
c
 = 6;

380 *
cﬁp
 = 0;

385 
˘y≥
 = (
πp
->
t_Êags
 >> 10) & 03;

386 if(
˘y≥
 == 1) {

387 
c
 = 1 - (*
cﬁp
 | ~07);

388 if(
c
 < 5)

389 
c
 = 0;

391 *
cﬁp
 =| 07;

392 (*
cﬁp
)++;

397 if(
πp
->
t_Êags
 & 
VTDELAY
)

398 
c
 = 0177;

403 
˘y≥
 = (
πp
->
t_Êags
 >> 12) & 03;

404 if(
˘y≥
 == 1) {

405 
c
 = 5;

407 if(
˘y≥
 == 2) {

408 
c
 = 10;

410 *
cﬁp
 = 0;

412 if(
c
)

413 
	`putc
(
c
|0200, &
πp
->
t_outq
);

414 
	}
}

422 
	$âr°π
(
©p
)

424 
ây
 *
ç
;

426 
ç
 = 
©p
;

427 
ç
->
t_°©e
 =& ~
TIMEOUT
;

428 
	`â°¨t
(
ç
);

429 
	}
}

441 
	$â°¨t
(
©p
)

442 
ây
 *
©p
;

444 *
addr
, 
c
;

445 
ây
 *
ç
;

446 °ru˘ { (*
func
)(); };

448 
ç
 = 
©p
;

449 
addr
 = 
ç
->
t_addr
;

450 i‡(
ç
->
t_°©e
&
SSTART
) {

451 (*
addr
.
func
)(
ç
);

454 i‡((
addr
->
âtc§
&
DONE
)==0 || 
ç
->
t_°©e
&
TIMEOUT
)

456 i‡((
c
=
	`gëc
(&
ç
->
t_outq
)) >= 0) {

457 i‡(
c
<=0177)

458 
addr
->
âtbuf
 = 
c
 | (
∑πab
[c]&0200);

460 
	`timeout
(
âr°π
, 
ç
, 
c
&0177);

461 
ç
->
t_°©e
 =| 
TIMEOUT
;

464 
	}
}

472 
	$âªad
(
©p
)

473 
ây
 *
©p
;

475 
ây
 *
ç
;

477 
ç
 = 
©p
;

478 i‡((
ç
->
t_°©e
&
CARR_ON
)==0)

480 i‡(
ç
->
t_ˇnq
.
c_cc
 || 
	`ˇn⁄
(tp))

481 
ç
->
t_ˇnq
.
c_cc
 && 
	`∑ssc
(
	`gëc
(&tp->t_canq))>=0);

482 
	}
}

488 
	$âwrôe
(
©p
)

489 
ây
 *
©p
;

491 
ây
 *
ç
;

492 
c
;

494 
ç
 = 
©p
;

495 i‡((
ç
->
t_°©e
&
CARR_ON
)==0)

497 (
c
=
	`˝ass
())>=0) {

498 
	`•l5
();

499 
ç
->
t_outq
.
c_cc
 > 
TTHIWAT
) {

500 
	`â°¨t
(
ç
);

501 
ç
->
t_°©e
 =| 
ASLEEP
;

502 
	`¶ìp
(&
ç
->
t_outq
, 
TTOPRI
);

504 
	`•l0
();

505 
	`âyouçut
(
c
, 
ç
);

507 
	`â°¨t
(
ç
);

508 
	}
}

517 
	$ây°ty
(
©p
, 
av
)

518 *
©p
, *
av
;

520 *
ç
, *
v
;

522 
ç
 = 
©p
;

523 if(
v
 = 
av
) {

524 *
v
++ = 
ç
->
t_•ìds
;

525 
v
->
lobyã
 = 
ç
->
t_îa£
;

526 
v
->
hibyã
 = 
ç
->
t_kûl
;

527 
v
[1] = 
ç
->
t_Êags
;

530 
	`wÊushây
(
ç
);

531 
v
 = 
u
.
u_¨g
;

532 
ç
->
t_•ìds
 = *
v
++;

533 
ç
->
t_îa£
 = 
v
->
lobyã
;

534 
ç
->
t_kûl
 = 
v
->
hibyã
;

535 
ç
->
t_Êags
 = 
v
[1];

537 
	}
}

	@dmr/vs.c

9 
	~"../ây.h
"

11 
	#VSADDR
 0174150

	)

12 
	#CDLEAD
 01

	)

13 
	#B1200
 030

	)

14 
	#STOP1
 0400

	)

15 
	#CLSEND
 02

	)

16 
	#RQSEND
 01

	)

18 
	#MAGIC_MAP
 0377

	)

21 
	mv§c§
;

22 
	mv§buf
;

23 
	mvsxc§
;

24 
	mvsxbuf
;

28 
˛i°
 
	miq
;

29 
˛i°
 
	moq
;

30 } 
	gvs
;

32 
	$vs›í
(
dev
)

34 
VSADDR
->
v§c§
 = 
IENABLE
|
B1200
|
CDLEAD
;

35 
VSADDR
->
vsxc§
 = 
STOP1
|
IENABLE
|
B1200
;

36 
	`vsch¨
(0);

37 
	}
}

39 
	$vs˛o£
(
dev
)

41 
	`vsch¨
(0);

42 
VSADDR
->
v§c§
 =& ~
IENABLE
;

43 
	`gëc
(&
vs
.
iq
) >= 0);

44 
	}
}

46 
	$vswrôe
(
dev
)

48 
cou¡
, 
c
;

50 
cou¡
 = 0;

51 (
c
=
	`˝ass
()) >= 0) {

52 i‡(--
cou¡
 <= 0) {

53 
cou¡
 = 60;

54 
	`vsch¨
(0);

56 
	`vsch¨
(
c
);

58 
	`vsch¨
(0);

59 
	}
}

61 
	$vsch¨
(
c
)

64 
c
 =^ 
MAGIC_MAP
;

65 
	`•l5
();

66 
vs
.
oq
.
c_cc
 > 60) {

67 
	`vsxöå
();

68 
	`¶ìp
(&
vs
.
oq
, 
TTIPRI
);

70 
	`putc
(
c
, &
vs
.
oq
);

71 
	`vsxöå
();

72 
	`•l0
();

73 
	}
}

75 
	$vsxöå
()

77 
lch¨
;

78 
c
;

79 *
xc§
;

81 
xc§
 = &
VSADDR
->
vsxc§
;

82 i‡(*
xc§
&
DONE
) {

83 i‡(
lch¨
==
MAGIC_MAP
) {

84 *
xc§
 =& ~
RQSEND
;

85 
lch¨
 = 0;

86 i‡(
vs
.
oq
.
c_cc
==0)

87 
wake
;

89 i‡((*
xc§
&
CLSEND
) == 0) {

90 *
xc§
 =& ~
RQSEND
;

91 *
xc§
 =| 
RQSEND
;

92 i‡((*
xc§
&
CLSEND
) == 0)

93 
wake
;

95 i‡((
c
 = 
	`gëc
(&
vs
.
oq
)) >= 0)

96 
VSADDR
->
vsxbuf
 = 
lch¨
 = 
c
;

97 i‡(
vs
.
oq
.
c_cc
 <= 15)

98 
wake
:

99 
	`wakeup
(&
vs
.
oq
);

101 
	}
}

103 
	$v§ód
(
dev
)

105 
c
;

107 
	`•l5
();

108 (
c
 = 
	`gëc
(&
vs
.
iq
)) < 0)

109 
	`¶ìp
(&
vs
.
iq
, 
TTIPRI
);

110 
	`•l0
();

111 
	`∑ssc
("?0*#?546?213?879?"[
c
&017]);

112 
	}
}

114 
	$v§öå
()

116 
c
;

118 
c
 = 
VSADDR
->
v§buf
;

119 i‡(
vs
.
iq
.
c_cc
<=10)

120 
	`putc
(
c
, &
vs
.
iq
);

121 
	`wakeup
(&
vs
.
iq
);

122 
	}
}

	@dmr/vt.c

9 
	~"../∑øm.h
"

10 
	~"../u£r.h
"

12 
	gvtÊag
;

14 
	svåeg
 {

15 
	mc§
;

16 
	mbuf
;

19 
	#VTADDR
 0167770

	)

20 
	#RQINT
 01

	)

21 
	#BIENABL
 040

	)

22 
	#SEOF
 0100000

	)

23 
	#VTPRI
 8

	)

25 
	$vt›í
(
dev
, 
Êag
)

27 i‡(!
Êag
)

28 
u
.
u_îr‹
 = 
ENXIO
;

30 
VTADDR
->
c§
 = 
BIENABL
;

31 
	}
}

33 
	$vt˛o£
()

35 
VTADDR
->
buf
 = 
SEOF
;

36 
VTADDR
->
c§
 =| 
RQINT
;

37 
	}
}

39 
	$vtwrôe
()

41 
c
;

42 
cou¡
;

44 (
c
=
	`˝ass
()) >= 0) {

45 
ªåy
:

46 
cou¡
=0; count<10; count++)

47 i‡((
VTADDR
->
c§
&
RQINT
)==0) {

48 
VTADDR
->
buf
 = 
c
&0377;

49 
VTADDR
->
c§
 =| 
RQINT
;

50 
c⁄tö
;

52 
	`•l5
();

53 i‡(
VTADDR
->
c§
&
RQINT
) {

54 
vtÊag
++;

55 
	`¶ìp
(
VTADDR
, 
VTPRI
);

57 
	`•l0
();

58 
ªåy
;

59 
c⁄tö
:;

61 
	}
}

63 
	$vtöå
()

65 
VTADDR
->
c§
 =& ~
RQINT
;

66 i‡(
vtÊag
) {

67 
vtÊag
 = 0;

68 
	`wakeup
(
VTADDR
);

70 
	}
}

	@file.h

8 
	sfûe


10 
	mf_Êag
;

11 
	mf_cou¡
;

12 
	mf_öode
;

13 *
	mf_off£t
[2];

14 } 
	gfûe
[
NFILE
];

17 
	#FREAD
 01

	)

18 
	#FWRITE
 02

	)

19 
	#FPIPE
 04

	)

	@filsys.h

12 
	sfûsys


14 
	ms_isize
;

15 
	ms_fsize
;

16 
	ms_n‰ì
;

17 
	ms_‰ì
[100];

18 
	ms_nöode
;

19 
	ms_öode
[100];

20 
	ms_Êock
;

21 
	ms_ûock
;

22 
	ms_fmod
;

23 
	ms_r⁄ly
;

24 
	ms_time
[2];

25 
	m∑d
[50];

	@ino.h

6 
	söode


8 
	mi_mode
;

9 
	mi_∆ök
;

10 
	mi_uid
;

11 
	mi_gid
;

12 
	mi_size0
;

13 *
	mi_size1
;

14 
	mi_addr
[8];

15 
	mi_©ime
[2];

16 
	mi_mtime
[2];

20 
	#IALLOC
 0100000

	)

21 
	#IFMT
 060000

	)

22 
	#IFDIR
 040000

	)

23 
	#IFCHR
 020000

	)

24 
	#IFBLK
 060000

	)

25 
	#ILARG
 010000

	)

26 
	#ISUID
 04000

	)

27 
	#ISGID
 02000

	)

28 
	#ISVTX
 01000

	)

29 
	#IREAD
 0400

	)

30 
	#IWRITE
 0200

	)

31 
	#IEXEC
 0100

	)

	@inode.h

11 
	söode


13 
	mi_Êag
;

14 
	mi_cou¡
;

15 
	mi_dev
;

16 
	mi_numbî
;

17 
	mi_mode
;

18 
	mi_∆ök
;

19 
	mi_uid
;

20 
	mi_gid
;

21 
	mi_size0
;

22 *
	mi_size1
;

23 
	mi_addr
[8];

24 
	mi_œ°r
;

25 } 
	göode
[
NINODE
];

28 
	#ILOCK
 01

	)

29 
	#IUPD
 02

	)

30 
	#IACC
 04

	)

31 
	#IMOUNT
 010

	)

32 
	#IWANT
 020

	)

33 
	#ITEXT
 040

	)

36 
	#IALLOC
 0100000

	)

37 
	#IFMT
 060000

	)

38 
	#IFDIR
 040000

	)

39 
	#IFCHR
 020000

	)

40 
	#IFBLK
 060000

	)

41 
	#ILARG
 010000

	)

42 
	#ISUID
 04000

	)

43 
	#ISGID
 02000

	)

44 
	#ISVTX
 01000

	)

45 
	#IREAD
 0400

	)

46 
	#IWRITE
 0200

	)

47 
	#IEXEC
 0100

	)

	@ken/alloc.c

5 
	~"../∑øm.h
"

6 
	~"../sy°m.h
"

7 
	~"../fûsys.h
"

8 
	~"../c⁄f.h
"

9 
	~"../buf.h
"

10 
	~"../öode.h
"

11 
	~"../u£r.h
"

23 
	$iöô
()

25 *
˝
, *
bp
;

27 (*
bdevsw
[
roŸdev
.
d_maj‹
].
d_›í
)(rootdev, 1);

28 
bp
 = 
	`bªad
(
roŸdev
, 1);

29 
˝
 = 
	`gëblk
(
NODEV
);

30 if(
u
.
u_îr‹
)

31 
	`∑nic
("iinit");

32 
	`bc›y
(
bp
->
b_addr
, 
˝
->b_addr, 256);

33 
	`bªl£
(
bp
);

34 
mou¡
[0].
m_buÂ
 = 
˝
;

35 
mou¡
[0].
m_dev
 = 
roŸdev
;

36 
˝
 = cp->
b_addr
;

37 
˝
->
s_Êock
 = 0;

38 
˝
->
s_ûock
 = 0;

39 
˝
->
s_r⁄ly
 = 0;

40 
time
[0] = 
˝
->
s_time
[0];

41 
time
[1] = 
˝
->
s_time
[1];

42 
	}
}

55 
	$Æloc
(
dev
)

57 
bno
;

58 *
bp
, *
ù
, *
Â
;

60 
Â
 = 
	`gëfs
(
dev
);

61 
Â
->
s_Êock
)

62 
	`¶ìp
(&
Â
->
s_Êock
, 
PINOD
);

64 if(
Â
->
s_n‰ì
 <= 0)

65 
no•a˚
;

66 
bno
 = 
Â
->
s_‰ì
[--Â->
s_n‰ì
];

67 if(
bno
 == 0)

68 
no•a˚
;

69 } 
	`badblock
(
Â
, 
bno
, 
dev
));

70 if(
Â
->
s_n‰ì
 <= 0) {

71 
Â
->
s_Êock
++;

72 
bp
 = 
	`bªad
(
dev
, 
bno
);

73 
ù
 = 
bp
->
b_addr
;

74 
Â
->
s_n‰ì
 = *
ù
++;

75 
	`bc›y
(
ù
, 
Â
->
s_‰ì
, 100);

76 
	`bªl£
(
bp
);

77 
Â
->
s_Êock
 = 0;

78 
	`wakeup
(&
Â
->
s_Êock
);

80 
bp
 = 
	`gëblk
(
dev
, 
bno
);

81 
	`˛rbuf
(
bp
);

82 
Â
->
s_fmod
 = 1;

83 (
bp
);

85 
no•a˚
:

86 
Â
->
s_n‰ì
 = 0;

87 
	`¥dev
("nÿ•a˚", 
dev
);

88 
u
.
u_îr‹
 = 
ENOSPC
;

89 (
NULL
);

90 
	}
}

97 
	$‰ì
(
dev
, 
bno
)

99 *
Â
, *
bp
, *
ù
;

101 
Â
 = 
	`gëfs
(
dev
);

102 
Â
->
s_fmod
 = 1;

103 
Â
->
s_Êock
)

104 
	`¶ìp
(&
Â
->
s_Êock
, 
PINOD
);

105 i‡(
	`badblock
(
Â
, 
bno
, 
dev
))

107 if(
Â
->
s_n‰ì
 <= 0) {

108 
Â
->
s_n‰ì
 = 1;

109 
Â
->
s_‰ì
[0] = 0;

111 if(
Â
->
s_n‰ì
 >= 100) {

112 
Â
->
s_Êock
++;

113 
bp
 = 
	`gëblk
(
dev
, 
bno
);

114 
ù
 = 
bp
->
b_addr
;

115 *
ù
++ = 
Â
->
s_n‰ì
;

116 
	`bc›y
(
Â
->
s_‰ì
, 
ù
, 100);

117 
Â
->
s_n‰ì
 = 0;

118 
	`bwrôe
(
bp
);

119 
Â
->
s_Êock
 = 0;

120 
	`wakeup
(&
Â
->
s_Êock
);

122 
Â
->
s_‰ì
[Â->
s_n‰ì
++] = 
bno
;

123 
Â
->
s_fmod
 = 1;

124 
	}
}

135 
	$badblock
(
aÂ
, 
abn
, 
dev
)

137 
fûsys
 *
Â
;

138 *
bn
;

140 
Â
 = 
aÂ
;

141 
bn
 = 
abn
;

142 i‡(
bn
 < 
Â
->
s_isize
+2 || b¿>Â->
s_fsize
) {

143 
	`¥dev
("bad block", 
dev
);

147 
	}
}

160 
	$üŒoc
(
dev
)

162 *
Â
, *
bp
, *
ù
;

163 
i
, 
j
, 
k
, 
öo
;

165 
Â
 = 
	`gëfs
(
dev
);

166 
Â
->
s_ûock
)

167 
	`¶ìp
(&
Â
->
s_ûock
, 
PINOD
);

168 
lo›
:

169 if(
Â
->
s_nöode
 > 0) {

170 
öo
 = 
Â
->
s_öode
[--Â->
s_nöode
];

171 
ù
 = 
	`igë
(
dev
, 
öo
);

172 i‡(
ù
==
NULL
)

173 (
NULL
);

174 if(
ù
->
i_mode
 == 0) {

175 
bp
 = &
ù
->
i_mode
; b∞< &ù->
i_addr
[8];)

176 *
bp
++ = 0;

177 
Â
->
s_fmod
 = 1;

178 (
ù
);

184 
	`ùut
(
ù
);

185 
lo›
;

187 
Â
->
s_ûock
++;

188 
öo
 = 0;

189 
i
=0; i<
Â
->
s_isize
; i++) {

190 
bp
 = 
	`bªad
(
dev
, 
i
+2);

191 
ù
 = 
bp
->
b_addr
;

192 
j
=0; j<256; j=+16) {

193 
öo
++;

194 if(
ù
[
j
] != 0)

196 
k
=0; k<
NINODE
; k++)

197 if(
dev
==
öode
[
k
].
i_dev
 && 
öo
==öode[k].
i_numbî
)

198 
c⁄t
;

199 
Â
->
s_öode
[Â->
s_nöode
++] = 
öo
;

200 if(
Â
->
s_nöode
 >= 100)

202 
c⁄t
:;

204 
	`bªl£
(
bp
);

205 if(
Â
->
s_nöode
 >= 100)

208 
Â
->
s_ûock
 = 0;

209 
	`wakeup
(&
Â
->
s_ûock
);

210 i‡(
Â
->
s_nöode
 > 0)

211 
lo›
;

212 
	`¥dev
("Ouào‡öodes", 
dev
);

213 
u
.
u_îr‹
 = 
ENOSPC
;

214 (
NULL
);

215 
	}
}

224 
	$i‰ì
(
dev
, 
öo
)

226 *
Â
;

228 
Â
 = 
	`gëfs
(
dev
);

229 if(
Â
->
s_ûock
)

231 if(
Â
->
s_nöode
 >= 100)

233 
Â
->
s_öode
[Â->
s_nöode
++] = 
öo
;

234 
Â
->
s_fmod
 = 1;

235 
	}
}

255 
	$gëfs
(
dev
)

257 
mou¡
 *
p
;

258 *
n1
, *
n2
;

260 
p
 = &
mou¡
[0];Ö < &mou¡[
NMOUNT
];Ö++)

261 if(
p
->
m_buÂ
 !
NULL
 &&Ö->
m_dev
 =
dev
) {

262 
p
 =Ö->
m_buÂ
->
b_addr
;

263 
n1
 = 
p
->
s_n‰ì
;

264 
n2
 = 
p
->
s_nöode
;

265 if(
n1
 > 100 || 
n2
 > 100) {

266 
	`¥dev
("bad cou¡", 
dev
);

267 
p
->
s_n‰ì
 = 0;

268 
p
->
s_nöode
 = 0;

270 (
p
);

272 
	`∑nic
("no fs");

273 
	}
}

284 
	$upd©e
()

286 
öode
 *
ù
;

287 
mou¡
 *
mp
;

288 *
bp
;

290 if(
updlock
)

292 
updlock
++;

293 
mp
 = &
mou¡
[0]; m∞< &mou¡[
NMOUNT
]; mp++)

294 if(
mp
->
m_buÂ
 !
NULL
) {

295 
ù
 = 
mp
->
m_buÂ
->
b_addr
;

296 if(
ù
->
s_fmod
==0 || ip->
s_ûock
!=0 ||

297 
ù
->
s_Êock
!=0 || ip->
s_r⁄ly
!=0)

299 
bp
 = 
	`gëblk
(
mp
->
m_dev
, 1);

300 
ù
->
s_fmod
 = 0;

301 
ù
->
s_time
[0] = 
time
[0];

302 
ù
->
s_time
[1] = 
time
[1];

303 
	`bc›y
(
ù
, 
bp
->
b_addr
, 256);

304 
	`bwrôe
(
bp
);

306 
ù
 = &
öode
[0]; i∞< &öode[
NINODE
]; ip++)

307 if((
ù
->
i_Êag
&
ILOCK
) == 0) {

308 
ù
->
i_Êag
 =| 
ILOCK
;

309 
	`iupd©
(
ù
, 
time
);

310 
	`¥ñe
(
ù
);

312 
updlock
 = 0;

313 
	`bÊush
(
NODEV
);

314 
	}
}

	@ken/clock.c

1 
#ö˛udê
	~"../∑øm.h
"

3 
	~"../sy°m.h
"

4 
	~"../u£r.h
"

5 
	~"../¥oc.h
"

7 
	#UMODE
 0170000

	)

8 
	#SCHMAG
 10

	)

26 
	$˛ock
(
dev
, 
•
, 
r1
, 
≈s
, 
r0
, 
pc
, 
ps
)

28 
ˇŒo
 *
p1
, *
p2
;

29 
¥oc
 *
µ
;

35 *
lks
 = 0115;

41 
	`di•œy
();

49 if(
ˇŒout
[0].
c_func
 == 0)

50 
out
;

51 
p2
 = &
ˇŒout
[0];

52 
p2
->
c_time
<=0 &&Ö2->
c_func
!=0)

53 
p2
++;

54 
p2
->
c_time
--;

60 if((
ps
&0340) != 0)

61 
out
;

67 
	`•l5
();

68 if(
ˇŒout
[0].
c_time
 <= 0) {

69 
p1
 = &
ˇŒout
[0];

70 
p1
->
c_func
 !0 &&Ö1->
c_time
 <= 0) {

71 (*
p1
->
c_func
)’1->
c_¨g
);

72 
p1
++;

74 
p2
 = &
ˇŒout
[0];

75 
p2
->
c_func
 = 
p1
->c_func) {

76 
p2
->
c_time
 = 
p1
->c_time;

77 
p2
->
c_¨g
 = 
p1
->c_arg;

78 
p1
++;

79 
p2
++;

88 
out
:

89 if((
ps
&
UMODE
) == UMODE) {

90 
u
.
u_utime
++;

91 if(
u
.
u_¥of
[3])

92 
	`öcupc
(
pc
, 
u
.
u_¥of
);

94 
u
.
u_°ime
++;

95 
µ
 = 
u
.
u_¥o˝
;

96 if(++
µ
->
p_˝u
 == 0)

97 
µ
->
p_˝u
--;

98 if(++
lbﬁt
 >
HZ
) {

99 if((
ps
&0340) != 0)

101 
lbﬁt
 =- 
HZ
;

102 if(++
time
[1] == 0)

103 ++
time
[0];

104 
	`•l1
();

105 if(
time
[1]==
tout
[1] &&Åime[0]==tout[0])

106 
	`wakeup
(
tout
);

107 if((
time
[1]&03) == 0) {

108 
ruƒun
++;

109 
	`wakeup
(&
lbﬁt
);

111 
µ
 = &
¥oc
[0];Ö∞< &¥oc[
NPROC
];Öp++)

112 i‡(
µ
->
p_°©
) {

113 if(
µ
->
p_time
 != 127)

114 
µ
->
p_time
++;

115 if((
µ
->
p_˝u
 & 0377Ë> 
SCHMAG
)

116 
µ
->
p_˝u
 =- 
SCHMAG
; 

117 
µ
->
p_˝u
 = 0;

118 if(
µ
->
p_¥i
 > 
PUSER
)

119 
	`£çri
(
µ
);

121 if(
runö
!=0) {

122 
runö
 = 0;

123 
	`wakeup
(&
runö
);

125 if((
ps
&
UMODE
) == UMODE) {

126 
u
.
u_¨0
 = &
r0
;

127 if(
	`issig
())

128 
	`psig
();

129 
	`£çri
(
u
.
u_¥o˝
);

132 
	}
}

145 
	$timeout
(
fun
, 
¨g
, 
tim
)

147 
ˇŒo
 *
p1
, *
p2
;

148 
t
;

149 
s
;

151 
t
 = 
tim
;

152 
s
 = 
PS
->
öãg
;

153 
p1
 = &
ˇŒout
[0];

154 
	`•l7
();

155 
p1
->
c_func
 !0 &&Ö1->
c_time
 <
t
) {

156 
t
 =- 
p1
->
c_time
;

157 
p1
++;

159 
p1
->
c_time
 =- 
t
;

160 
p2
 = 
p1
;

161 
p2
->
c_func
 != 0)

162 
p2
++;

163 
p2
 >
p1
) {

164 (
p2
+1)->
c_time
 =Ö2->c_time;

165 (
p2
+1)->
c_func
 =Ö2->c_func;

166 (
p2
+1)->
c_¨g
 =Ö2->c_arg;

167 
p2
--;

169 
p1
->
c_time
 = 
t
;

170 
p1
->
c_func
 = 
fun
;

171 
p1
->
c_¨g
 = 
¨g
;

172 
PS
->
öãg
 = 
s
;

173 
	}
}

	@ken/fio.c

5 
	~"../∑øm.h
"

6 
	~"../u£r.h
"

7 
	~"../fûsys.h
"

8 
	~"../fûe.h
"

9 
	~"../c⁄f.h
"

10 
	~"../öode.h
"

11 
	~"../ªg.h
"

20 
	$gëf
(
f
)

22 *
Â
, 
rf
;

24 
rf
 = 
f
;

25 if(
rf
<0 ||Ñf>=
NOFILE
)

26 
bad
;

27 
Â
 = 
u
.
u_ofûe
[
rf
];

28 if(
Â
 !
NULL
)

29 (
Â
);

30 
bad
:

31 
u
.
u_îr‹
 = 
EBADF
;

32 (
NULL
);

33 
	}
}

43 
	$˛o£f
(
Â
)

44 *
Â
;

46 *
rÂ
, *
ù
;

48 
rÂ
 = 
Â
;

49 if(
rÂ
->
f_Êag
&
FPIPE
) {

50 
ù
 = 
rÂ
->
f_öode
;

51 
ù
->
i_mode
 =& ~(
IREAD
|
IWRITE
);

52 
	`wakeup
(
ù
+1);

53 
	`wakeup
(
ù
+2);

55 if(
rÂ
->
f_cou¡
 <= 1)

56 
	`˛o£i
(
rÂ
->
f_öode
,ÑÂ->
f_Êag
&
FWRITE
);

57 
rÂ
->
f_cou¡
--;

58 
	}
}

71 
	$˛o£i
(
ù
, 
rw
)

72 *
ù
;

74 *
rù
;

75 
dev
, 
maj
;

77 
rù
 = 
ù
;

78 
dev
 = 
rù
->
i_addr
[0];

79 
maj
 = 
rù
->
i_addr
[0].
d_maj‹
;

80 if(
rù
->
i_cou¡
 <= 1)

81 
rù
->
i_mode
&
IFMT
) {

83 
IFCHR
:

84 (*
cdevsw
[
maj
].
d_˛o£
)(
dev
, 
rw
);

87 
IFBLK
:

88 (*
bdevsw
[
maj
].
d_˛o£
)(
dev
, 
rw
);

90 
	`ùut
(
rù
);

91 
	}
}

100 
	$›íi
(
ù
, 
rw
)

101 *
ù
;

103 *
rù
;

104 
dev
, 
maj
;

106 
rù
 = 
ù
;

107 
dev
 = 
rù
->
i_addr
[0];

108 
maj
 = 
rù
->
i_addr
[0].
d_maj‹
;

109 
rù
->
i_mode
&
IFMT
) {

111 
IFCHR
:

112 if(
maj
 >
nchrdev
)

113 
bad
;

114 (*
cdevsw
[
maj
].
d_›í
)(
dev
, 
rw
);

117 
IFBLK
:

118 if(
maj
 >
nblkdev
)

119 
bad
;

120 (*
bdevsw
[
maj
].
d_›í
)(
dev
, 
rw
);

124 
bad
:

125 
u
.
u_îr‹
 = 
ENXIO
;

126 
	}
}

143 
	$ac˚ss
(
aù
, 
mode
)

144 *
aù
;

146 *
ù
, 
m
;

148 
ù
 = 
aù
;

149 
m
 = 
mode
;

150 if(
m
 =
IWRITE
) {

151 if(
	`gëfs
(
ù
->
i_dev
)->
s_r⁄ly
 != 0) {

152 
u
.
u_îr‹
 = 
EROFS
;

155 if(
ù
->
i_Êag
 & 
ITEXT
) {

156 
u
.
u_îr‹
 = 
ETXTBSY
;

160 if(
u
.
u_uid
 == 0) {

161 if(
m
 =
IEXEC
 && (
ù
->
i_mode
 &

162 (
IEXEC
 | (IEXEC>>3) | (IEXEC>>6))) == 0)

163 
bad
;

166 if(
u
.
u_uid
 !
ù
->
i_uid
) {

167 
m
 =>> 3;

168 if(
u
.
u_gid
 !
ù
->
i_gid
)

169 
m
 =>> 3;

171 if((
ù
->
i_mode
&
m
) != 0)

174 
bad
:

175 
u
.
u_îr‹
 = 
EACCES
;

177 
	}
}

187 
	$ow√r
()

189 
öode
 *
ù
;

190 
	`uch¨
();

192 i‡((
ù
 = 
	`«mei
(
uch¨
, 0)Ë=
NULL
)

193 (
NULL
);

194 if(
u
.
u_uid
 =
ù
->
i_uid
)

195 (
ù
);

196 i‡(
	`su£r
())

197 (
ù
);

198 
	`ùut
(
ù
);

199 (
NULL
);

200 
	}
}

206 
	$su£r
()

209 if(
u
.
u_uid
 == 0)

211 
u
.
u_îr‹
 = 
EPERM
;

213 
	}
}

218 
	$uÁŒoc
()

220 
i
;

222 
i
=0; i<
NOFILE
; i++)

223 i‡(
u
.
u_ofûe
[
i
] =
NULL
) {

224 
u
.
u_¨0
[
R0
] = 
i
;

225 (
i
);

227 
u
.
u_îr‹
 = 
EMFILE
;

229 
	}
}

240 
	$ÁŒoc
()

242 
fûe
 *
Â
;

243 
i
;

245 i‡((
i
 = 
	`uÁŒoc
()) < 0)

246 (
NULL
);

247 
Â
 = &
fûe
[0]; f∞< &fûe[
NFILE
]; fp++)

248 i‡(
Â
->
f_cou¡
==0) {

249 
u
.
u_ofûe
[
i
] = 
Â
;

250 
Â
->
f_cou¡
++;

251 
Â
->
f_off£t
[0] = 0;

252 
Â
->
f_off£t
[1] = 0;

253 (
Â
);

255 
	`¥ötf
("no file\n");

256 
u
.
u_îr‹
 = 
ENFILE
;

257 (
NULL
);

258 
	}
}

	@ken/iget.c

1 
#ö˛udê
	~"../∑øm.h
"

3 
	~"../sy°m.h
"

4 
	~"../u£r.h
"

5 
	~"../öode.h
"

6 
	~"../fûsys.h
"

7 
	~"../c⁄f.h
"

8 
	~"../buf.h
"

27 
	$igë
(
dev
, 
öo
)

29 
öode
 *
p
;

30 *
ù2
;

31 *
ù1
;

32 
mou¡
 *
ù
;

34 
lo›
:

35 
ù
 = 
NULL
;

36 
p
 = &
öode
[0];Ö < &öode[
NINODE
];Ö++) {

37 if(
dev
==
p
->
i_dev
 && 
öo
=ı->
i_numbî
) {

38 if((
p
->
i_Êag
&
ILOCK
) != 0) {

39 
p
->
i_Êag
 =| 
IWANT
;

40 
	`¶ìp
(
p
, 
PINOD
);

41 
lo›
;

43 if((
p
->
i_Êag
&
IMOUNT
) != 0) {

44 
ù
 = &
mou¡
[0]; i∞< &mou¡[
NMOUNT
]; ip++)

45 if(
ù
->
m_öodp
 =
p
) {

46 
dev
 = 
ù
->
m_dev
;

47 
öo
 = 
ROOTINO
;

48 
lo›
;

50 
	`∑nic
("no imt");

52 
p
->
i_cou¡
++;

53 
p
->
i_Êag
 =| 
ILOCK
;

54 (
p
);

56 if(
ù
==
NULL
 && 
p
->
i_cou¡
==0)

57 
ù
 = 
p
;

59 if((
p
=
ù
Ë=
NULL
) {

60 
	`¥ötf
("InodeÅable overflow\n");

61 
u
.
u_îr‹
 = 
ENFILE
;

62 (
NULL
);

64 
p
->
i_dev
 = 
dev
;

65 
p
->
i_numbî
 = 
öo
;

66 
p
->
i_Êag
 = 
ILOCK
;

67 
p
->
i_cou¡
++;

68 
p
->
i_œ°r
 = -1;

69 
ù
 = 
	`bªad
(
dev
, 
	`ldiv
(
öo
+31,16));

73 i‡(
ù
->
b_Êags
&
B_ERROR
) {

74 
	`bªl£
(
ù
);

75 
	`ùut
(
p
);

76 (
NULL
);

78 
ù1
 = 
ù
->
b_addr
 + 32*
	`Ãem
(
öo
+31, 16);

79 
ù2
 = &
p
->
i_mode
;

80 
ù2
 < &
p
->
i_addr
[8])

81 *
ù2
++ = *
ù1
++;

82 
	`bªl£
(
ù
);

83 (
p
);

84 
	}
}

93 
	$ùut
(
p
)

94 
öode
 *
p
;

96 *
Ω
;

98 
Ω
 = 
p
;

99 if(
Ω
->
i_cou¡
 == 1) {

100 
Ω
->
i_Êag
 =| 
ILOCK
;

101 if(
Ω
->
i_∆ök
 <= 0) {

102 
	`ôrunc
(
Ω
);

103 
Ω
->
i_mode
 = 0;

104 
	`i‰ì
(
Ω
->
i_dev
,Ñp->
i_numbî
);

106 
	`iupd©
(
Ω
, 
time
);

107 
	`¥ñe
(
Ω
);

108 
Ω
->
i_Êag
 = 0;

109 
Ω
->
i_numbî
 = 0;

111 
Ω
->
i_cou¡
--;

112 
	`¥ñe
(
Ω
);

113 
	}
}

122 
	$iupd©
(
p
, 
tm
)

123 *
p
;

124 *
tm
;

126 *
ù1
, *
ù2
, *
Ω
;

127 *
bp
, 
i
;

129 
Ω
 = 
p
;

130 if((
Ω
->
i_Êag
&(
IUPD
|
IACC
)) != 0) {

131 if(
	`gëfs
(
Ω
->
i_dev
)->
s_r⁄ly
)

133 
i
 = 
Ω
->
i_numbî
+31;

134 
bp
 = 
	`bªad
(
Ω
->
i_dev
, 
	`ldiv
(
i
,16));

135 
ù1
 = 
bp
->
b_addr
 + 32*
	`Ãem
(
i
, 16);

136 
ù2
 = &
Ω
->
i_mode
;

137 
ù2
 < &
Ω
->
i_addr
[8])

138 *
ù1
++ = *
ù2
++;

139 if(
Ω
->
i_Êag
&
IACC
) {

140 *
ù1
++ = 
time
[0];

141 *
ù1
++ = 
time
[1];

143 
ù1
 =+ 2;

144 if(
Ω
->
i_Êag
&
IUPD
) {

145 *
ù1
++ = *
tm
++;

146 *
ù1
++ = *
tm
;

148 
	`bwrôe
(
bp
);

150 
	}
}

161 
	$ôrunc
(
ù
)

162 *
ù
;

164 *
Ω
, *
bp
, *
˝
;

165 *
dp
, *
ï
;

167 
Ω
 = 
ù
;

168 if((
Ω
->
i_mode
&(
IFCHR
&
IFBLK
)) != 0)

170 
ù
 = &
Ω
->
i_addr
[7]; ip >= &rp->i_addr[0]; ip--)

171 if(*
ù
) {

172 if((
Ω
->
i_mode
&
ILARG
) != 0) {

173 
bp
 = 
	`bªad
(
Ω
->
i_dev
, *
ù
);

174 
˝
 = 
bp
->
b_addr
+512; cp >= bp->b_addr; cp--)

175 if(*
˝
) {

176 if(
ù
 =&
Ω
->
i_addr
[7]) {

177 
dp
 = 
	`bªad
(
Ω
->
i_dev
, *
˝
);

178 
ï
 = 
dp
->
b_addr
+512;Ép >= dp->b_addr;Ép--)

179 if(*
ï
)

180 
	`‰ì
(
Ω
->
i_dev
, *
ï
);

181 
	`bªl£
(
dp
);

183 
	`‰ì
(
Ω
->
i_dev
, *
˝
);

185 
	`bªl£
(
bp
);

187 
	`‰ì
(
Ω
->
i_dev
, *
ù
);

188 *
ù
 = 0;

190 
Ω
->
i_mode
 =& ~
ILARG
;

191 
Ω
->
i_size0
 = 0;

192 
Ω
->
i_size1
 = 0;

193 
Ω
->
i_Êag
 =| 
IUPD
;

194 
	}
}

199 
	$maknode
(
mode
)

201 *
ù
;

203 
ù
 = 
	`üŒoc
(
u
.
u_pdú
->
i_dev
);

204 i‡(
ù
==
NULL
)

205 (
NULL
);

206 
ù
->
i_Êag
 =| 
IACC
|
IUPD
;

207 
ù
->
i_mode
 = 
mode
|
IALLOC
;

208 
ù
->
i_∆ök
 = 1;

209 
ù
->
i_uid
 = 
u
.
u_uid
;

210 
ù
->
i_gid
 = 
u
.
u_gid
;

211 
	`wdú
(
ù
);

212 (
ù
);

213 
	}
}

220 
	$wdú
(
ù
)

221 *
ù
;

223 *
˝1
, *
˝2
;

225 
u
.
u_dít
.
u_öo
 = 
ù
->
i_numbî
;

226 
˝1
 = &
u
.
u_dít
.
u_«me
[0];

227 
˝2
 = &
u
.
u_dbuf
[0]; cp2 < &u.u_dbuf[
DIRSIZ
];)

228 *
˝1
++ = *
˝2
++;

229 
u
.
u_cou¡
 = 
DIRSIZ
+2;

230 
u
.
u_£gÊg
 = 1;

231 
u
.
u_ba£
 = &u.
u_dít
;

232 
	`wrôei
(
u
.
u_pdú
);

233 
	`ùut
(
u
.
u_pdú
);

234 
	}
}

	@ken/main.c

1 
#ö˛udê
	~"../∑øm.h
"

3 
	~"../u£r.h
"

4 
	~"../sy°m.h
"

5 
	~"../¥oc.h
"

6 
	~"../ãxt.h
"

7 
	~"../öode.h
"

8 
	~"../£g.h
"

10 
	#CLOCK1
 0177546

	)

11 
	#CLOCK2
 0172540

	)

17 
	gicode
[]

49 
	$maö
()

51 
sch¨
;

52 
i
, *
p
;

58 
updlock
 = 0;

59 
i
 = *
ka6
 + 
USIZE
;

60 
UISD
->
r
[0] = 077406;

62 
UISA
->
r
[0] = 
i
;

63 if(
	`fuibyã
(0) < 0)

65 
	`˛ór£g
(
i
);

66 
maxmem
++;

67 
	`m‰ì
(
c‹em≠
, 1, 
i
);

68 
i
++;

70 if(
˝uty≥
 == 70)

71 
i
=0; i<62; i=+2) {

72 
UBMAP
->
r
[
i
] = i<<12;

73 
UBMAP
->
r
[
i
+1] = 0;

75 
	`¥ötf
("mem = %l\n", 
maxmem
*5/16);

76 
maxmem
 = 
	`mö
(maxmem, 
MAXMEM
);

77 
	`m‰ì
(
sw≠m≠
, 
nsw≠
, 
sw∂o
);

83 
UISA
->
r
[7] = 
ka6
[1];

84 
UISD
->
r
[7] = 077406;

85 
lks
 = 
CLOCK1
;

86 if(
	`fuiw‹d
(
lks
) == -1) {

87 
lks
 = 
CLOCK2
;

88 if(
	`fuiw‹d
(
lks
) == -1)

89 
	`∑nic
("no clock");

96 
¥oc
[0].
p_addr
 = *
ka6
;

97 
¥oc
[0].
p_size
 = 
USIZE
;

98 
¥oc
[0].
p_°©
 = 
SRUN
;

99 
¥oc
[0].
p_Êag
 =| 
SLOAD
|
SSYS
;

100 
u
.
u_¥o˝
 = &
¥oc
[0];

106 *
lks
 = 0115;

107 
	`cöô
();

108 
	`böô
();

109 
	`iöô
();

110 
roŸdú
 = 
	`igë
(
roŸdev
, 
ROOTINO
);

111 
roŸdú
->
i_Êag
 =& ~
ILOCK
;

112 
u
.
u_cdú
 = 
	`igë
(
roŸdev
, 
ROOTINO
);

113 
u
.
u_cdú
->
i_Êag
 =& ~
ILOCK
;

121 if(
	`√w¥oc
()) {

122 
	`ex∑nd
(
USIZE
+1);

123 
	`e°abur
(0, 1, 0, 0);

124 
	`c›yout
(
icode
, 0,  icode);

131 
	`sched
();

132 
	}
}

140 
	$suªg
()

142 *
up
, *
Ω
, 
a
;

144 
a
 = 
u
.
u_¥o˝
->
p_addr
;

145 
up
 = &
u
.
u_uiß
[16];

146 
Ω
 = &
UISA
->
r
[16];

147 if(
˝uty≥
 == 40) {

148 
up
 =- 8;

149 
Ω
 =- 8;

151 
Ω
 > &
UISA
->
r
[0])

152 *--
Ω
 = *--
up
 + 
a
;

153 if((
up
=
u
.
u_¥o˝
->
p_ãxç
Ë!
NULL
)

154 
a
 =- 
up
->
x_ˇddr
;

155 
up
 = &
u
.
u_uisd
[16];

156 
Ω
 = &
UISD
->
r
[16];

157 if(
˝uty≥
 == 40) {

158 
up
 =- 8;

159 
Ω
 =- 8;

161 
Ω
 > &
UISD
->
r
[0]) {

162 *--
Ω
 = *--
up
;

163 if((*
Ω
 & 
WO
) == 0)

164 
Ω
[(
UISA
-
UISD
)/2] =- 
a
;

166 
	}
}

177 
	$e°abur
(
¡
, 
nd
, 
ns
, 
£p
)

179 
a
, *
≠
, *
dp
;

181 if(
£p
) {

182 if(
˝uty≥
 == 40)

183 
îr
;

184 if(
	`n£g
(
¡
Ë> 8 ||Ç£g(
nd
)+n£g(
ns
) > 8)

185 
îr
;

187 if(
	`n£g
(
¡
)+n£g(
nd
)+n£g(
ns
) > 8)

188 
îr
;

189 if(
¡
+
nd
+
ns
+
USIZE
 > 
maxmem
)

190 
îr
;

191 
a
 = 0;

192 
≠
 = &
u
.
u_uiß
[0];

193 
dp
 = &
u
.
u_uisd
[0];

194 
¡
 >= 128) {

195 *
dp
++ = (127<<8Ë| 
RO
;

196 *
≠
++ = 
a
;

197 
a
 =+ 128;

198 
¡
 =- 128;

200 if(
¡
) {

201 *
dp
++ = ((
¡
-1)<<8Ë| 
RO
;

202 *
≠
++ = 
a
;

204 if(
£p
)

205 
≠
 < &
u
.
u_uiß
[8]) {

206 *
≠
++ = 0;

207 *
dp
++ = 0;

209 
a
 = 
USIZE
;

210 
nd
 >= 128) {

211 *
dp
++ = (127<<8Ë| 
RW
;

212 *
≠
++ = 
a
;

213 
a
 =+ 128;

214 
nd
 =- 128;

216 if(
nd
) {

217 *
dp
++ = ((
nd
-1)<<8Ë| 
RW
;

218 *
≠
++ = 
a
;

219 
a
 =+ 
nd
;

221 
≠
 < &
u
.
u_uiß
[8]) {

222 *
dp
++ = 0;

223 *
≠
++ = 0;

225 if(
£p
)

226 
≠
 < &
u
.
u_uiß
[16]) {

227 *
dp
++ = 0;

228 *
≠
++ = 0;

230 
a
 =+ 
ns
;

231 
ns
 >= 128) {

232 
a
 =- 128;

233 
ns
 =- 128;

234 *--
dp
 = (127<<8Ë| 
RW
;

235 *--
≠
 = 
a
;

237 if(
ns
) {

238 *--
dp
 = ((128-
ns
)<<8Ë| 
RW
 | 
ED
;

239 *--
≠
 = 
a
-128;

241 if(!
£p
) {

242 
≠
 = &
u
.
u_uiß
[0];

243 
dp
 = &
u
.
u_uiß
[8];

244 
≠
 < &
u
.
u_uiß
[8])

245 *
dp
++ = *
≠
++;

246 
≠
 = &
u
.
u_uisd
[0];

247 
dp
 = &
u
.
u_uisd
[8];

248 
≠
 < &
u
.
u_uisd
[8])

249 *
dp
++ = *
≠
++;

251 
	`suªg
();

254 
îr
:

255 
u
.
u_îr‹
 = 
ENOMEM
;

257 
	}
}

262 
	$n£g
(
n
)

265 ((
n
+127)>>7);

266 
	}
}

	@ken/malloc.c

16 
	sm≠


18 *
	mm_size
;

19 *
	mm_addr
;

28 
	$mÆloc
(
mp
, 
size
)

29 
m≠
 *
mp
;

31 
a
;

32 
m≠
 *
bp
;

34 
bp
 = 
mp
; bp->
m_size
; bp++) {

35 i‡(
bp
->
m_size
 >
size
) {

36 
a
 = 
bp
->
m_addr
;

37 
bp
->
m_addr
 =+ 
size
;

38 i‡((
bp
->
m_size
 =- 
size
) == 0)

40 
bp
++;

41 (
bp
-1)->
m_addr
 = bp->m_addr;

42 } (
bp
-1)->
m_size
 = bp->m_size);

43 (
a
);

47 
	}
}

55 
	$m‰ì
(
mp
, 
size
, 
Ø
)

56 
m≠
 *
mp
;

58 
m≠
 *
bp
;

59 
t
;

60 
a
;

62 
a
 = 
Ø
;

63 
bp
 = 
mp
; bp->
m_addr
<=
a
 && bp->
m_size
!=0; bp++);

64 i‡(
bp
>
mp
 && (bp-1)->
m_addr
+(bp-1)->
m_size
 =
a
) {

65 (
bp
-1)->
m_size
 =+ 
size
;

66 i‡(
a
+
size
 =
bp
->
m_addr
) {

67 (
bp
-1)->
m_size
 =+ bp->m_size;

68 
bp
->
m_size
) {

69 
bp
++;

70 (
bp
-1)->
m_addr
 = bp->m_addr;

71 (
bp
-1)->
m_size
 = bp->m_size;

75 i‡(
a
+
size
 =
bp
->
m_addr
 && bp->
m_size
) {

76 
bp
->
m_addr
 =- 
size
;

77 
bp
->
m_size
 =+ 
size
;

78 } i‡(
size
) do {

79 
t
 = 
bp
->
m_addr
;

80 
bp
->
m_addr
 = 
a
;

81 
a
 = 
t
;

82 
t
 = 
bp
->
m_size
;

83 
bp
->
m_size
 = 
size
;

84 
bp
++;

85 } 
size
 = 
t
);

87 
	}
}

	@ken/nami.c

1 
#ö˛udê
	~"../∑øm.h
"

3 
	~"../öode.h
"

4 
	~"../u£r.h
"

5 
	~"../sy°m.h
"

6 
	~"../buf.h
"

19 
	$«mei
(
func
, 
Êag
)

20 (*
func
)();

22 
öode
 *
dp
;

23 
c
;

24 *
˝
;

25 
eo
, *
bp
;

32 
dp
 = 
u
.
u_cdú
;

33 if((
c
=(*
func
)()) == '/')

34 
dp
 = 
roŸdú
;

35 
	`igë
(
dp
->
i_dev
, dp->
i_numbî
);

36 
c
 == '/')

37 
c
 = (*
func
)();

38 if(
c
 ='\0' && 
Êag
 != 0) {

39 
u
.
u_îr‹
 = 
ENOENT
;

40 
out
;

43 
˛o›
:

49 if(
u
.
u_îr‹
)

50 
out
;

51 if(
c
 == '\0')

52 (
dp
);

60 if((
dp
->
i_mode
&
IFMT
Ë!
IFDIR
) {

61 
u
.
u_îr‹
 = 
ENOTDIR
;

62 
out
;

64 if(
	`ac˚ss
(
dp
, 
IEXEC
))

65 
out
;

72 
˝
 = &
u
.
u_dbuf
[0];

73 
c
!='/' && c!='\0' && 
u
.
u_îr‹
==0) {

74 if(
˝
 < &
u
.
u_dbuf
[
DIRSIZ
])

75 *
˝
++ = 
c
;

76 
c
 = (*
func
)();

78 
˝
 < &
u
.
u_dbuf
[
DIRSIZ
])

79 *
˝
++ = '\0';

80 
c
 == '/')

81 
c
 = (*
func
)();

82 if(
u
.
u_îr‹
)

83 
out
;

89 
u
.
u_off£t
[1] = 0;

90 
u
.
u_off£t
[0] = 0;

91 
u
.
u_£gÊg
 = 1;

92 
eo
 = 0;

93 
u
.
u_cou¡
 = 
	`ldiv
(
dp
->
i_size1
, 
DIRSIZ
+2);

94 
bp
 = 
NULL
;

96 
ño›
:

104 if(
u
.
u_cou¡
 == 0) {

105 if(
bp
 !
NULL
)

106 
	`bªl£
(
bp
);

107 if(
Êag
==1 && 
c
=='\0') {

108 if(
	`ac˚ss
(
dp
, 
IWRITE
))

109 
out
;

110 
u
.
u_pdú
 = 
dp
;

111 if(
eo
)

112 
u
.
u_off£t
[1] = 
eo
-
DIRSIZ
-2; 

113 
dp
->
i_Êag
 =| 
IUPD
;

114 (
NULL
);

116 
u
.
u_îr‹
 = 
ENOENT
;

117 
out
;

126 if((
u
.
u_off£t
[1]&0777) == 0) {

127 if(
bp
 !
NULL
)

128 
	`bªl£
(
bp
);

129 
bp
 = 
	`bªad
(
dp
->
i_dev
,

130 
	`bm≠
(
dp
, 
	`ldiv
(
u
.
u_off£t
[1], 512)));

141 
	`bc›y
(
bp
->
b_addr
+(
u
.
u_off£t
[1]&0777), &u.
u_dít
, (
DIRSIZ
+2)/2);

142 
u
.
u_off£t
[1] =+ 
DIRSIZ
+2;

143 
u
.
u_cou¡
--;

144 if(
u
.
u_dít
.
u_öo
 == 0) {

145 if(
eo
 == 0)

146 
eo
 = 
u
.
u_off£t
[1];

147 
ño›
;

149 
˝
 = &
u
.
u_dbuf
[0]; c∞< &u.u_dbuf[
DIRSIZ
]; cp++)

150 if(*
˝
 !˝[
u
.
u_dít
.
u_«me
 - u.
u_dbuf
])

151 
ño›
;

159 if(
bp
 !
NULL
)

160 
	`bªl£
(
bp
);

161 if(
Êag
==2 && 
c
=='\0') {

162 if(
	`ac˚ss
(
dp
, 
IWRITE
))

163 
out
;

164 (
dp
);

166 
bp
 = 
dp
->
i_dev
;

167 
	`ùut
(
dp
);

168 
dp
 = 
	`igë
(
bp
, 
u
.
u_dít
.
u_öo
);

169 if(
dp
 =
NULL
)

170 (
NULL
);

171 
˛o›
;

173 
out
:

174 
	`ùut
(
dp
);

175 (
NULL
);

176 
	}
}

182 
	$sch¨
()

185 (*
u
.
u_dúp
++ & 0377);

186 
	}
}

192 
	$uch¨
()

194 
c
;

196 
c
 = 
	`fubyã
(
u
.
u_dúp
++);

197 if(
c
 == -1)

198 
u
.
u_îr‹
 = 
EFAULT
;

199 (
c
);

200 
	}
}

	@ken/pipe.c

5 
	~"../∑øm.h
"

6 
	~"../sy°m.h
"

7 
	~"../u£r.h
"

8 
	~"../öode.h
"

9 
	~"../fûe.h
"

10 
	~"../ªg.h
"

20 
	#PIPSIZ
 4096

	)

28 
	$pùe
()

30 *
ù
, *
rf
, *
wf
;

31 
r
;

33 
ù
 = 
	`üŒoc
(
roŸdev
);

34 if(
ù
 =
NULL
)

36 
rf
 = 
	`ÁŒoc
();

37 if(
rf
 =
NULL
) {

38 
	`ùut
(
ù
);

41 
r
 = 
u
.
u_¨0
[
R0
];

42 
wf
 = 
	`ÁŒoc
();

43 if(
wf
 =
NULL
) {

44 
rf
->
f_cou¡
 = 0;

45 
u
.
u_ofûe
[
r
] = 
NULL
;

46 
	`ùut
(
ù
);

49 
u
.
u_¨0
[
R1
] = u.u_¨0[
R0
];

50 
u
.
u_¨0
[
R0
] = 
r
;

51 
wf
->
f_Êag
 = 
FWRITE
|
FPIPE
;

52 
wf
->
f_öode
 = 
ù
;

53 
rf
->
f_Êag
 = 
FREAD
|
FPIPE
;

54 
rf
->
f_öode
 = 
ù
;

55 
ù
->
i_cou¡
 = 2;

56 
ù
->
i_Êag
 = 
IACC
|
IUPD
;

57 
ù
->
i_mode
 = 
IALLOC
;

58 
	}
}

63 
	$ªadp
(
Â
)

64 *
Â
;

66 *
Ω
, *
ù
;

68 
Ω
 = 
Â
;

69 
ù
 = 
Ω
->
f_öode
;

71 
lo›
:

76 
	`∂ock
(
ù
);

83 if(
Ω
->
f_off£t
[1] =
ù
->
i_size1
) {

84 if(
Ω
->
f_off£t
[1] != 0) {

85 
Ω
->
f_off£t
[1] = 0;

86 
ù
->
i_size1
 = 0;

87 if(
ù
->
i_mode
&
IWRITE
) {

88 
ù
->
i_mode
 =& ~
IWRITE
;

89 
	`wakeup
(
ù
+1);

99 
	`¥ñe
(
ù
);

100 if(
ù
->
i_cou¡
 < 2)

102 
ù
->
i_mode
 =| 
IREAD
;

103 
	`¶ìp
(
ù
+2, 
PPIPE
);

104 
lo›
;

111 
u
.
u_off£t
[0] = 0;

112 
u
.
u_off£t
[1] = 
Ω
->
f_off£t
[1];

113 
	`ªadi
(
ù
);

114 
Ω
->
f_off£t
[1] = 
u
.
u_off£t
[1];

115 
	`¥ñe
(
ù
);

116 
	}
}

121 
	$wrôï
(
Â
)

123 *
Ω
, *
ù
, 
c
;

125 
Ω
 = 
Â
;

126 
ù
 = 
Ω
->
f_öode
;

127 
c
 = 
u
.
u_cou¡
;

129 
lo›
:

135 
	`∂ock
(
ù
);

136 if(
c
 == 0) {

137 
	`¥ñe
(
ù
);

138 
u
.
u_cou¡
 = 0;

148 if(
ù
->
i_cou¡
 < 2) {

149 
	`¥ñe
(
ù
);

150 
u
.
u_îr‹
 = 
EPIPE
;

151 
	`psig«l
(
u
.
u_¥o˝
, 
SIGPIPE
);

161 if(
ù
->
i_size1
 =
PIPSIZ
) {

162 
ù
->
i_mode
 =| 
IWRITE
;

163 
	`¥ñe
(
ù
);

164 
	`¶ìp
(
ù
+1, 
PPIPE
);

165 
lo›
;

173 
u
.
u_off£t
[0] = 0;

174 
u
.
u_off£t
[1] = 
ù
->
i_size1
;

175 
u
.
u_cou¡
 = 
	`mö
(
c
, 
PIPSIZ
-u.
u_off£t
[1]);

176 
c
 =- 
u
.
u_cou¡
;

177 
	`wrôei
(
ù
);

178 
	`¥ñe
(
ù
);

179 if(
ù
->
i_mode
&
IREAD
) {

180 
ù
->
i_mode
 =& ~
IREAD
;

181 
	`wakeup
(
ù
+2);

183 
lo›
;

184 
	}
}

191 
	$∂ock
(
ù
)

192 *
ù
;

194 *
Ω
;

196 
Ω
 = 
ù
;

197 
Ω
->
i_Êag
&
ILOCK
) {

198 
Ω
->
i_Êag
 =| 
IWANT
;

199 
	`¶ìp
(
Ω
, 
PPIPE
);

201 
Ω
->
i_Êag
 =| 
ILOCK
;

202 
	}
}

211 
	$¥ñe
(
ù
)

212 *
ù
;

214 *
Ω
;

216 
Ω
 = 
ù
;

217 
Ω
->
i_Êag
 =& ~
ILOCK
;

218 if(
Ω
->
i_Êag
&
IWANT
) {

219 
Ω
->
i_Êag
 =& ~
IWANT
;

220 
	`wakeup
(
Ω
);

222 
	}
}

	@ken/prf.c

5 
	~"../∑øm.h
"

6 
	~"../£g.h
"

7 
	~"../buf.h
"

8 
	~"../c⁄f.h
"

16 
	mr§
;

17 
	mrbr
;

18 
	mx§
;

19 
	mxbr
;

28 *
	g∑nic°r
;

40 
	$¥ötf
(
fmt
,
x1
,
x2
,
x3
,
x4
,
x5
,
x6
,
x7
,
x8
,
x9
,
xa
,
xb
,
xc
)

41 
fmt
[];

43 *
s
;

44 *
adx
, 
c
;

46 
adx
 = &
x1
;

47 
lo›
:

48 (
c
 = *
fmt
++) != '%') {

49 if(
c
 == '\0')

51 
	`putch¨
(
c
);

53 
c
 = *
fmt
++;

54 if(
c
 == 'd' || c == 'l' || c == 'o')

55 
	`¥öä
(*
adx
, 
c
=='o'? 8: 10);

56 if(
c
 == 's') {

57 
s
 = *
adx
;

58 
c
 = *
s
++)

59 
	`putch¨
(
c
);

61 
adx
++;

62 
lo›
;

63 
	}
}

68 
	$¥öä
(
n
, 
b
)

70 
a
;

72 if(
a
 = 
	`ldiv
(
n
, 
b
))

73 
	`¥öä
(
a
, 
b
);

74 
	`putch¨
(
	`Ãem
(
n
, 
b
) + '0');

75 
	}
}

84 
	$putch¨
(
c
)

86 
rc
, 
s
;

88 
rc
 = 
c
;

89 if(
SW
->
öãg
 == 0)

91 (
KL
->
x§
&0200) == 0)

93 if(
rc
 == 0)

95 
s
 = 
KL
->
x§
;

96 
KL
->
x§
 = 0;

97 
KL
->
xbr
 = 
rc
;

98 if(
rc
 == '\n') {

99 
	`putch¨
('\r');

100 
	`putch¨
(0177);

101 
	`putch¨
(0177);

103 
	`putch¨
(0);

104 
KL
->
x§
 = 
s
;

105 
	}
}

113 
	$∑nic
(
s
)

114 *
s
;

116 
∑nic°r
 = 
s
;

117 
	`upd©e
();

118 
	`¥ötf
("∑nic: %s\n", 
s
);

120 
	`idÀ
();

121 
	}
}

129 
	$¥dev
(
°r
, 
dev
)

132 
	`¥ötf
("%†⁄ dev %l/%l\n", 
°r
, 
dev
.
d_maj‹
, dev.
d_mö‹
);

133 
	}
}

142 
	$devîr‹
(
bp
, 
o1
, 
o2
)

143 *
bp
;

145 *
rbp
;

147 
rbp
 = 
bp
;

148 
	`¥dev
("îr", 
rbp
->
b_dev
);

149 
	`¥ötf
("bn%»î%ÿ%o\n", 
rbp
->
b_blkno
, 
o1
, 
o2
);

150 
	}
}

	@ken/rdwri.c

5 
	~"../∑øm.h
"

6 
	~"../öode.h
"

7 
	~"../u£r.h
"

8 
	~"../buf.h
"

9 
	~"../c⁄f.h
"

10 
	~"../sy°m.h
"

22 
	$ªadi
(
aù
)

23 
öode
 *
aù
;

25 *
bp
;

26 
lbn
, 
bn
, 
⁄
;

27 
dn
, 
n
;

28 
öode
 *
ù
;

30 
ù
 = 
aù
;

31 if(
u
.
u_cou¡
 == 0)

33 
ù
->
i_Êag
 =| 
IACC
;

34 if((
ù
->
i_mode
&
IFMT
Ë=
IFCHR
) {

35 (*
cdevsw
[
ù
->
i_addr
[0].
d_maj‹
].
d_ªad
)(ip->i_addr[0]);

40 
lbn
 = 
bn
 = 
	`lshi·
(
u
.
u_off£t
, -9);

41 
⁄
 = 
u
.
u_off£t
[1] & 0777;

42 
n
 = 
	`mö
(512-
⁄
, 
u
.
u_cou¡
);

43 if((
ù
->
i_mode
&
IFMT
Ë!
IFBLK
) {

44 
dn
 = 
	`dpcmp
(
ù
->
i_size0
&0377, ip->
i_size1
,

45 
u
.
u_off£t
[0], u.u_offset[1]);

46 if(
dn
 <= 0)

48 
n
 = 
	`mö
“, 
dn
);

49 i‡((
bn
 = 
	`bm≠
(
ù
, 
lbn
)) == 0)

51 
dn
 = 
ù
->
i_dev
;

53 
dn
 = 
ù
->
i_addr
[0];

54 
øblock
 = 
bn
+1;

56 i‡(
ù
->
i_œ°r
+1 =
lbn
)

57 
bp
 = 
	`bªada
(
dn
, 
bn
, 
øblock
);

59 
bp
 = 
	`bªad
(
dn
, 
bn
);

60 
ù
->
i_œ°r
 = 
lbn
;

61 
	`iomove
(
bp
, 
⁄
, 
n
, 
B_READ
);

62 
	`bªl£
(
bp
);

63 } 
u
.
u_îr‹
==0 && u.
u_cou¡
!=0);

64 
	}
}

76 
	$wrôei
(
aù
)

77 
öode
 *
aù
;

79 *
bp
;

80 
n
, 
⁄
;

81 
dn
, 
bn
;

82 
öode
 *
ù
;

84 
ù
 = 
aù
;

85 
ù
->
i_Êag
 =| 
IACC
|
IUPD
;

86 if((
ù
->
i_mode
&
IFMT
Ë=
IFCHR
) {

87 (*
cdevsw
[
ù
->
i_addr
[0].
d_maj‹
].
d_wrôe
)(ip->i_addr[0]);

90 i‡(
u
.
u_cou¡
 == 0)

94 
bn
 = 
	`lshi·
(
u
.
u_off£t
, -9);

95 
⁄
 = 
u
.
u_off£t
[1] & 0777;

96 
n
 = 
	`mö
(512-
⁄
, 
u
.
u_cou¡
);

97 if((
ù
->
i_mode
&
IFMT
Ë!
IFBLK
) {

98 i‡((
bn
 = 
	`bm≠
(
ù
, bn)) == 0)

100 
dn
 = 
ù
->
i_dev
;

102 
dn
 = 
ù
->
i_addr
[0];

103 if(
n
 == 512)

104 
bp
 = 
	`gëblk
(
dn
, 
bn
); 

105 
bp
 = 
	`bªad
(
dn
, 
bn
);

106 
	`iomove
(
bp
, 
⁄
, 
n
, 
B_WRITE
);

107 if(
u
.
u_îr‹
 != 0)

108 
	`bªl£
(
bp
); 

109 i‡((
u
.
u_off£t
[1]&0777)==0)

110 
	`bawrôe
(
bp
); 

111 
	`bdwrôe
(
bp
);

112 if(
	`dpcmp
(
ù
->
i_size0
&0377, ip->
i_size1
,

113 
u
.
u_off£t
[0], u.u_offset[1]) < 0 &&

114 (
ù
->
i_mode
&(
IFBLK
&
IFCHR
)) == 0) {

115 
ù
->
i_size0
 = 
u
.
u_off£t
[0];

116 
ù
->
i_size1
 = 
u
.
u_off£t
[1];

118 
ù
->
i_Êag
 =| 
IUPD
;

119 } 
u
.
u_îr‹
==0 && u.
u_cou¡
!=0);

120 
	}
}

126 
	$max
(
a
, 
b
)

127 *
a
, *
b
;

130 if(
a
 > 
b
)

131 (
a
);

132 (
b
);

133 
	}
}

139 
	$mö
(
a
, 
b
)

140 *
a
, *
b
;

143 if(
a
 < 
b
)

144 (
a
);

145 (
b
);

146 
	}
}

163 
	$iomove
(
bp
, 
o
, 
™
, 
Êag
)

164 
buf
 *
bp
;

166 *
˝
;

167 
n
, 
t
;

169 
n
 = 
™
;

170 
˝
 = 
bp
->
b_addr
 + 
o
;

171 if(
u
.
u_£gÊg
==0 && ((
n
 | 
˝
 | u.
u_ba£
)&01)==0) {

172 i‡(
Êag
==
B_WRITE
)

173 
˝
 = 
	`c›yö
(
u
.
u_ba£
, cp, 
n
);

175 
˝
 = 
	`c›yout
(˝, 
u
.
u_ba£
, 
n
);

176 i‡(
˝
) {

177 
u
.
u_îr‹
 = 
EFAULT
;

180 
u
.
u_ba£
 =+ 
n
;

181 
	`d∑dd
(
u
.
u_off£t
, 
n
);

182 
u
.
u_cou¡
 =- 
n
;

185 i‡(
Êag
==
B_WRITE
) {

186 
n
--) {

187 i‡((
t
 = 
	`˝ass
()) < 0)

189 *
˝
++ = 
t
;

192 
n
--)

193 if(
	`∑ssc
(*
˝
++) < 0)

195 
	}
}

	@ken/sig.c

5 
	~"../∑øm.h
"

6 
	~"../sy°m.h
"

7 
	~"../u£r.h
"

8 
	~"../¥oc.h
"

9 
	~"../öode.h
"

10 
	~"../ªg.h
"

15 
	#IPCPRI
 (-1)

	)

22 
	möè
[];

35 
	mù_lock
;

36 
	mù_ªq
;

37 
	mù_addr
;

38 
	mù_d©a
;

39 } 
	gùc
;

48 
	$sig«l
(
ç
, 
sig
)

50 
¥oc
 *
p
;

52 
p
 = &
¥oc
[0];Ö < &¥oc[
NPROC
];Ö++)

53 if(
p
->
p_âyp
 =
ç
)

54 
	`psig«l
(
p
, 
sig
);

55 
	}
}

61 
	$psig«l
(
p
, 
sig
)

62 *
p
;

64 *
Ω
;

66 if(
sig
 >
NSIG
)

68 
Ω
 = 
p
;

69 if(
Ω
->
p_sig
 !
SIGKIL
)

70 
Ω
->
p_sig
 = 
sig
;

71 if(
Ω
->
p_°©
 > 
PUSER
)

72 
Ω
->
p_°©
 = 
PUSER
;

73 if(
Ω
->
p_°©
 =
SWAIT
)

74 
	`£åun
(
Ω
);

75 
	}
}

88 
	$issig
()

90 
n
;

91 
¥oc
 *
p
;

93 
p
 = 
u
.
u_¥o˝
;

94 if(
n
 = 
p
->
p_sig
) {

95 i‡(
p
->
p_Êag
&
STRC
) {

96 
	`°›
();

97 i‡((
n
 = 
p
->
p_sig
) == 0)

100 if((
u
.
u_sig«l
[
n
]&1) == 0)

101 (
n
);

104 
	}
}

112 
	$°›
()

114 
¥oc
 *
µ
, *
˝
;

116 
lo›
:

117 
˝
 = 
u
.
u_¥o˝
;

118 if(
˝
->
p_µid
 != 1)

119 
µ
 = &
¥oc
[0];Ö∞< &¥oc[
NPROC
];Öp++)

120 i‡(
µ
->
p_pid
 =
˝
->
p_µid
) {

121 
	`wakeup
(
µ
);

122 
˝
->
p_°©
 = 
SSTOP
;

123 
	`swtch
();

124 i‡((
˝
->
p_Êag
&
STRC
)==0 || 
	`¥ocxmt
())

126 
lo›
;

128 
	`exô
();

129 
	}
}

138 
	$psig
()

140 
n
, 
p
;

141 *
Ω
;

143 
Ω
 = 
u
.
u_¥o˝
;

144 
n
 = 
Ω
->
p_sig
;

145 
Ω
->
p_sig
 = 0;

146 if((
p
=
u
.
u_sig«l
[
n
]) != 0) {

147 
u
.
u_îr‹
 = 0;

148 if(
n
 !
SIGINS
 &&Ç !
SIGTRC
)

149 
u
.
u_sig«l
[
n
] = 0;

150 
n
 = 
u
.
u_¨0
[
R6
] - 4;

151 
	`grow
(
n
);

152 
	`suw‹d
(
n
+2, 
u
.
u_¨0
[
RPS
]);

153 
	`suw‹d
(
n
, 
u
.
u_¨0
[
R7
]);

154 
u
.
u_¨0
[
R6
] = 
n
;

155 
u
.
u_¨0
[
RPS
] =& ~
TBIT
;

156 
u
.
u_¨0
[
R7
] = 
p
;

159 
n
) {

161 
SIGQIT
:

162 
SIGINS
:

163 
SIGTRC
:

164 
SIGIOT
:

165 
SIGEMT
:

166 
SIGFPT
:

167 
SIGBUS
:

168 
SIGSEG
:

169 
SIGSYS
:

170 
u
.
u_¨g
[0] = 
n
;

171 if(
	`c‹e
())

172 
n
 =+ 0200;

174 
u
.
u_¨g
[0] = (u.
u_¨0
[
R0
]<<8Ë| 
n
;

175 
	`exô
();

176 
	}
}

188 
	$c‹e
()

190 
s
, *
ù
;

191 
sch¨
;

193 
u
.
u_îr‹
 = 0;

194 
u
.
u_dúp
 = "core";

195 
ù
 = 
	`«mei
(&
sch¨
, 1);

196 if(
ù
 =
NULL
) {

197 if(
u
.
u_îr‹
)

199 
ù
 = 
	`maknode
(0666);

200 if(
ù
 =
NULL
)

203 if(!
	`ac˚ss
(
ù
, 
IWRITE
) &&

204 (
ù
->
i_mode
&
IFMT
) == 0 &&

205 
u
.
u_uid
 =u.
u_ruid
) {

206 
	`ôrunc
(
ù
);

207 
u
.
u_off£t
[0] = 0;

208 
u
.
u_off£t
[1] = 0;

209 
u
.
u_ba£
 = &u;

210 
u
.
u_cou¡
 = 
USIZE
*64;

211 
u
.
u_£gÊg
 = 1;

212 
	`wrôei
(
ù
);

213 
s
 = 
u
.
u_¥o˝
->
p_size
 - 
USIZE
;

214 
	`e°abur
(0, 
s
, 0, 0);

215 
u
.
u_ba£
 = 0;

216 
u
.
u_cou¡
 = 
s
*64;

217 
u
.
u_£gÊg
 = 0;

218 
	`wrôei
(
ù
);

220 
	`ùut
(
ù
);

221 (
u
.
u_îr‹
==0);

222 
	}
}

229 
	$grow
(
•
)

230 *
•
;

232 
a
, 
si
, 
i
;

234 if(
•
 >-
u
.
u_ssize
*64)

236 
si
 = 
	`ldiv
(-
•
, 64Ë- 
u
.
u_ssize
 + 
SINCR
;

237 if(
si
 <= 0)

239 if(
	`e°abur
(
u
.
u_tsize
, u.
u_dsize
, u.
u_ssize
+
si
, u.
u_£p
))

241 
	`ex∑nd
(
u
.
u_¥o˝
->
p_size
+
si
);

242 
a
 = 
u
.
u_¥o˝
->
p_addr
 + u.u_¥o˝->
p_size
;

243 
i
=
u
.
u_ssize
; i; i--) {

244 
a
--;

245 
	`c›y£g
(
a
-
si
,á);

247 
i
=
si
; i; i--)

248 
	`˛ór£g
(--
a
);

249 
u
.
u_ssize
 =+ 
si
;

251 
	}
}

256 
	$±ø˚
()

258 
¥oc
 *
p
;

260 i‡(
u
.
u_¨g
[2] <= 0) {

261 
u
.
u_¥o˝
->
p_Êag
 =| 
STRC
;

264 
p
=
¥oc
;Ö < &¥oc[
NPROC
];Ö++)

265 i‡(
p
->
p_°©
==
SSTOP


266 && 
p
->
p_pid
==
u
.
u_¨g
[0]

267 && 
p
->
p_µid
==
u
.
u_¥o˝
->
p_pid
)

268 
found
;

269 
u
.
u_îr‹
 = 
ESRCH
;

272 
found
:

273 
ùc
.
ù_lock
)

274 
	`¶ìp
(&
ùc
, 
IPCPRI
);

275 
ùc
.
ù_lock
 = 
p
->
p_pid
;

276 
ùc
.
ù_d©a
 = 
u
.
u_¨0
[
R0
];

277 
ùc
.
ù_addr
 = 
u
.
u_¨g
[1] & ~01;

278 
ùc
.
ù_ªq
 = 
u
.
u_¨g
[2];

279 
p
->
p_Êag
 =& ~
SWTED
;

280 
	`£åun
(
p
);

281 
ùc
.
ù_ªq
 > 0)

282 
	`¶ìp
(&
ùc
, 
IPCPRI
);

283 
u
.
u_¨0
[
R0
] = 
ùc
.
ù_d©a
;

284 i‡(
ùc
.
ù_ªq
 < 0)

285 
u
.
u_îr‹
 = 
EIO
;

286 
ùc
.
ù_lock
 = 0;

287 
	`wakeup
(&
ùc
);

288 
	}
}

295 
	$¥ocxmt
()

297 
i
;

298 *
p
;

300 i‡(
ùc
.
ù_lock
 !
u
.
u_¥o˝
->
p_pid
)

302 
i
 = 
ùc
.
ù_ªq
;

303 
ùc
.
ù_ªq
 = 0;

304 
	`wakeup
(&
ùc
);

305 
i
) {

309 i‡(
	`fuibyã
(
ùc
.
ù_addr
) == -1)

310 
îr‹
;

311 
ùc
.
ù_d©a
 = 
	`fuiw‹d
(ùc.
ù_addr
);

316 i‡(
	`fubyã
(
ùc
.
ù_addr
) == -1)

317 
îr‹
;

318 
ùc
.
ù_d©a
 = 
	`fuw‹d
(ùc.
ù_addr
);

323 
i
 = 
ùc
.
ù_addr
;

324 i‡(
i
<0 || i >(
USIZE
<<6))

325 
îr‹
;

326 
ùc
.
ù_d©a
 = 
u
.
öè
[
i
>>1];

331 i‡(
	`suiw‹d
(
ùc
.
ù_addr
, 0) < 0)

332 
îr‹
;

333 
	`suiw‹d
(
ùc
.
ù_addr
, ipc.
ù_d©a
);

338 i‡(
	`suw‹d
(
ùc
.
ù_addr
, 0) < 0)

339 
îr‹
;

340 
	`suw‹d
(
ùc
.
ù_addr
, ipc.
ù_d©a
);

345 
p
 = &
u
.
öè
[
ùc
.
ù_addr
>>1];

346 i‡(
p
 >
u
.
u_fßv
 &&Ö < &u.u_fsav[25])

347 
ok
;

348 
i
=0; i<9; i++)

349 i‡(
p
 =&
u
.
u_¨0
[
ªgloc
[
i
]])

350 
ok
;

351 
îr‹
;

352 
ok
:

353 i‡(
p
 =&
u
.
u_¨0
[
RPS
]) {

354 
ùc
.
ù_d©a
 =| 0170000;

355 
ùc
.
ù_d©a
 =& ~0340;

357 *
p
 = 
ùc
.
ù_d©a
;

362 
u
.
u_¥o˝
->
p_sig
 = 
ùc
.
ù_d©a
;

367 
	`exô
();

370 
îr‹
:

371 
ùc
.
ù_ªq
 = -1;

374 
	}
}

	@ken/slp.c

5 
	~"../∑øm.h
"

6 
	~"../u£r.h
"

7 
	~"../¥oc.h
"

8 
	~"../ãxt.h
"

9 
	~"../sy°m.h
"

10 
	~"../fûe.h
"

11 
	~"../öode.h
"

12 
	~"../buf.h
"

25 
	$¶ìp
(
ch™
, 
¥i
)

27 *
Ω
, 
s
;

29 
s
 = 
PS
->
öãg
;

30 
Ω
 = 
u
.
u_¥o˝
;

31 if(
¥i
 >= 0) {

32 if(
	`issig
())

33 
psig
;

34 
	`•l6
();

35 
Ω
->
p_wch™
 = 
ch™
;

36 
Ω
->
p_°©
 = 
SWAIT
;

37 
Ω
->
p_¥i
 = 
¥i
;

38 
	`•l0
();

39 if(
runö
 != 0) {

40 
runö
 = 0;

41 
	`wakeup
(&
runö
);

43 
	`swtch
();

44 if(
	`issig
())

45 
psig
;

47 
	`•l6
();

48 
Ω
->
p_wch™
 = 
ch™
;

49 
Ω
->
p_°©
 = 
SSLEEP
;

50 
Ω
->
p_¥i
 = 
¥i
;

51 
	`•l0
();

52 
	`swtch
();

54 
PS
->
öãg
 = 
s
;

64 
psig
:

65 
	`¨ëu
(
u
.
u_qßv
);

66 
	}
}

71 
	$wakeup
(
ch™
)

73 
¥oc
 *
p
;

74 
c
, 
i
;

76 
c
 = 
ch™
;

77 
p
 = &
¥oc
[0];

78 
i
 = 
NPROC
;

80 if(
p
->
p_wch™
 =
c
) {

81 
	`£åun
(
p
);

83 
p
++;

84 } --
i
);

85 
	}
}

91 
	$£åun
(
p
)

93 
¥oc
 *
Ω
;

95 
Ω
 = 
p
;

96 
Ω
->
p_wch™
 = 0;

97 
Ω
->
p_°©
 = 
SRUN
;

98 if(
Ω
->
p_¥i
 < 
cuΩri
)

99 
ruƒun
++;

100 if(
runout
 !0 && (
Ω
->
p_Êag
&
SLOAD
) == 0) {

101 
runout
 = 0;

102 
	`wakeup
(&
runout
);

104 
	}
}

112 
	$£çri
(
up
)

114 *
µ
, 
p
;

116 
µ
 = 
up
;

117 
p
 = (
µ
->
p_˝u
 & 0377)/16;

118 
p
 =+ 
PUSER
 + 
µ
->
p_ni˚
;

119 if(
p
 > 127)

120 
p
 = 127;

121 if(
p
 > 
cuΩri
)

122 
ruƒun
++;

123 
µ
->
p_¥i
 = 
p
;

124 
	}
}

144 
	$sched
()

146 
¥oc
 *
p1
;

147 
¥oc
 *
Ω
;

148 
a
, 
n
;

155 
lo›
;

157 
¶o›
:

158 
runö
++;

159 
	`¶ìp
(&
runö
, 
PSWP
);

161 
lo›
:

162 
	`•l6
();

163 
n
 = -1;

164 
Ω
 = &
¥oc
[0];Ñ∞< &¥oc[
NPROC
];Ñp++)

165 if(
Ω
->
p_°©
==
SRUN
 && (Ω->
p_Êag
&
SLOAD
)==0 &&

166 
Ω
->
p_time
 > 
n
) {

167 
p1
 = 
Ω
;

168 
n
 = 
Ω
->
p_time
;

170 if(
n
 == -1) {

171 
runout
++;

172 
	`¶ìp
(&
runout
, 
PSWP
);

173 
lo›
;

180 
	`•l0
();

181 
Ω
 = 
p1
;

182 
a
 = 
Ω
->
p_size
;

183 if((
Ω
Ùp->
p_ãxç
Ë!
NULL
)

184 if(
Ω
->
x_ccou¡
 == 0)

185 
a
 =+ 
Ω
->
x_size
;

186 if((
a
=
	`mÆloc
(
c‹em≠
,á)Ë!
NULL
)

187 
found2
;

194 
	`•l6
();

195 
Ω
 = &
¥oc
[0];Ñ∞< &¥oc[
NPROC
];Ñp++)

196 if((
Ω
->
p_Êag
&(
SSYS
|
SLOCK
|
SLOAD
))==SLOAD &&

197 (
Ω
->
p_°©
 =
SWAIT
 ||Ñp->p_°©==
SSTOP
))

198 
found1
;

207 if(
n
 < 3)

208 
¶o›
;

209 
n
 = -1;

210 
Ω
 = &
¥oc
[0];Ñ∞< &¥oc[
NPROC
];Ñp++)

211 if((
Ω
->
p_Êag
&(
SSYS
|
SLOCK
|
SLOAD
))==SLOAD &&

212 (
Ω
->
p_°©
==
SRUN
 ||Ñp->p_°©==
SSLEEP
) &&

213 
Ω
->
p_time
 > 
n
) {

214 
p1
 = 
Ω
;

215 
n
 = 
Ω
->
p_time
;

217 if(
n
 < 2)

218 
¶o›
;

219 
Ω
 = 
p1
;

225 
found1
:

226 
	`•l0
();

227 
Ω
->
p_Êag
 =& ~
SLOAD
;

228 
	`xsw≠
(
Ω
, 1, 0);

229 
lo›
;

235 
found2
:

236 if((
Ω
=
p1
->
p_ãxç
Ë!
NULL
) {

237 if(
Ω
->
x_ccou¡
 == 0) {

238 if(
	`sw≠
(
Ω
->
x_daddr
, 
a
,Ñp->
x_size
, 
B_READ
))

239 
sw≠î
;

240 
Ω
->
x_ˇddr
 = 
a
;

241 
a
 =+ 
Ω
->
x_size
;

243 
Ω
->
x_ccou¡
++;

245 
Ω
 = 
p1
;

246 if(
	`sw≠
(
Ω
->
p_addr
, 
a
,Ñp->
p_size
, 
B_READ
))

247 
sw≠î
;

248 
	`m‰ì
(
sw≠m≠
, (
Ω
->
p_size
+7)/8,Ñp->
p_addr
);

249 
Ω
->
p_addr
 = 
a
;

250 
Ω
->
p_Êag
 =| 
SLOAD
;

251 
Ω
->
p_time
 = 0;

252 
lo›
;

254 
sw≠î
:

255 
	`∑nic
("swapÉrror");

256 
	}
}

264 
	$swtch
()

266 
¥oc
 *
p
;

267 
i
, 
n
;

268 
¥oc
 *
Ω
;

270 if(
p
 =
NULL
)

271 
p
 = &
¥oc
[0];

275 
	`ßvu
(
u
.
u_rßv
);

279 
	`ªtu
(
¥oc
[0].
p_addr
);

281 
lo›
:

282 
ruƒun
 = 0;

283 
Ω
 = 
p
;

284 
p
 = 
NULL
;

285 
n
 = 128;

289 
i
 = 
NPROC
;

291 
Ω
++;

292 if(
Ω
 >&
¥oc
[
NPROC
])

293 
Ω
 = &
¥oc
[0];

294 if(
Ω
->
p_°©
==
SRUN
 && (Ω->
p_Êag
&
SLOAD
)!=0) {

295 if(
Ω
->
p_¥i
 < 
n
) {

296 
p
 = 
Ω
;

297 
n
 = 
Ω
->
p_¥i
;

300 } --
i
);

304 if(
p
 =
NULL
) {

305 
p
 = 
Ω
;

306 
	`idÀ
();

307 
lo›
;

309 
Ω
 = 
p
;

310 
cuΩri
 = 
n
;

315 
	`ªtu
(
Ω
->
p_addr
);

316 
	`suªg
();

327 if(
Ω
->
p_Êag
&
SSWAP
) {

328 
Ω
->
p_Êag
 =& ~
SSWAP
;

329 
	`¨ëu
(
u
.
u_sßv
);

336 
	}
}

351 
	$√w¥oc
()

353 
a1
, 
a2
;

354 
¥oc
 *
p
, *
up
;

355 
¥oc
 *
Ωp
;

356 *
rù
, 
n
;

358 
p
 = 
NULL
;

365 
ªåy
:

366 
mpid
++;

367 if(
mpid
 < 0) {

368 
mpid
 = 0;

369 
ªåy
;

371 
Ωp
 = &
¥oc
[0];Ñµ < &¥oc[
NPROC
];Ñpp++) {

372 if(
Ωp
->
p_°©
 =
NULL
 && 
p
==NULL)

373 
p
 = 
Ωp
;

374 i‡(
Ωp
->
p_pid
==
mpid
)

375 
ªåy
;

377 i‡((
Ωp
 = 
p
)==
NULL
)

378 
	`∑nic
("noÖrocs");

384 
rù
 = 
u
.
u_¥o˝
;

385 
up
 = 
rù
;

386 
Ωp
->
p_°©
 = 
SRUN
;

387 
Ωp
->
p_Êag
 = 
SLOAD
;

388 
Ωp
->
p_uid
 = 
rù
->p_uid;

389 
Ωp
->
p_âyp
 = 
rù
->p_ttyp;

390 
Ωp
->
p_ni˚
 = 
rù
->p_nice;

391 
Ωp
->
p_ãxç
 = 
rù
->p_textp;

392 
Ωp
->
p_pid
 = 
mpid
;

393 
Ωp
->
p_µid
 = 
rù
->
p_pid
;

394 
Ωp
->
p_time
 = 0;

401 
rù
 = &
u
.
u_ofûe
[0];Ñù < &u.u_ofûe[
NOFILE
];)

402 if((
Ωp
 = *
rù
++Ë!
NULL
)

403 
Ωp
->
f_cou¡
++;

404 if((
Ωp
=
up
->
p_ãxç
Ë!
NULL
) {

405 
Ωp
->
x_cou¡
++;

406 
Ωp
->
x_ccou¡
++;

408 
u
.
u_cdú
->
i_cou¡
++;

414 
	`ßvu
(
u
.
u_rßv
);

415 
Ωp
 = 
p
;

416 
u
.
u_¥o˝
 = 
Ωp
;

417 
rù
 = 
up
;

418 
n
 = 
rù
->
p_size
;

419 
a1
 = 
rù
->
p_addr
;

420 
Ωp
->
p_size
 = 
n
;

421 
a2
 = 
	`mÆloc
(
c‹em≠
, 
n
);

427 if(
a2
 =
NULL
) {

428 
rù
->
p_°©
 = 
SIDL
;

429 
Ωp
->
p_addr
 = 
a1
;

430 
	`ßvu
(
u
.
u_sßv
);

431 
	`xsw≠
(
Ωp
, 0, 0);

432 
Ωp
->
p_Êag
 =| 
SSWAP
;

433 
rù
->
p_°©
 = 
SRUN
;

438 
Ωp
->
p_addr
 = 
a2
;

439 
n
--)

440 
	`c›y£g
(
a1
++, 
a2
++);

442 
u
.
u_¥o˝
 = 
rù
;

444 
	}
}

462 
	$ex∑nd
(
√wsize
)

464 
i
, 
n
;

465 *
p
, 
a1
, 
a2
;

467 
p
 = 
u
.
u_¥o˝
;

468 
n
 = 
p
->
p_size
;

469 
p
->
p_size
 = 
√wsize
;

470 
a1
 = 
p
->
p_addr
;

471 if(
n
 >
√wsize
) {

472 
	`m‰ì
(
c‹em≠
, 
n
-
√wsize
, 
a1
+newsize);

475 
	`ßvu
(
u
.
u_rßv
);

476 
a2
 = 
	`mÆloc
(
c‹em≠
, 
√wsize
);

477 if(
a2
 =
NULL
) {

478 
	`ßvu
(
u
.
u_sßv
);

479 
	`xsw≠
(
p
, 1, 
n
);

480 
p
->
p_Êag
 =| 
SSWAP
;

481 
	`swtch
();

484 
p
->
p_addr
 = 
a2
;

485 
i
=0; i<
n
; i++)

486 
	`c›y£g
(
a1
+
i
, 
a2
++);

487 
	`m‰ì
(
c‹em≠
, 
n
, 
a1
);

488 
	`ªtu
(
p
->
p_addr
);

489 
	`suªg
();

490 
	}
}

	@ken/subr.c

5 
	~"../∑øm.h
"

6 
	~"../c⁄f.h
"

7 
	~"../öode.h
"

8 
	~"../u£r.h
"

9 
	~"../buf.h
"

10 
	~"../sy°m.h
"

20 
	$bm≠
(
ù
, 
bn
)

21 
öode
 *
ù
;

22 
bn
;

24 *
bp
, *
b≠
, 
nb
;

25 *
nbp
, 
d
, 
i
;

27 
d
 = 
ù
->
i_dev
;

28 if(
bn
 & ~077777) {

29 
u
.
u_îr‹
 = 
EFBIG
;

33 if((
ù
->
i_mode
&
ILARG
) == 0) {

39 if((
bn
 & ~7) != 0) {

45 i‡((
bp
 = 
	`Æloc
(
d
)Ë=
NULL
)

46 (
NULL
);

47 
b≠
 = 
bp
->
b_addr
;

48 
i
=0; i<8; i++) {

49 *
b≠
++ = 
ù
->
i_addr
[
i
];

50 
ù
->
i_addr
[
i
] = 0;

52 
ù
->
i_addr
[0] = 
bp
->
b_blkno
;

53 
	`bdwrôe
(
bp
);

54 
ù
->
i_mode
 =| 
ILARG
;

55 
œrge
;

57 
nb
 = 
ù
->
i_addr
[
bn
];

58 if(
nb
 =0 && (
bp
 = 
	`Æloc
(
d
)Ë!
NULL
) {

59 
	`bdwrôe
(
bp
);

60 
nb
 = 
bp
->
b_blkno
;

61 
ù
->
i_addr
[
bn
] = 
nb
;

62 
ù
->
i_Êag
 =| 
IUPD
;

64 
øblock
 = 0;

65 i‡(
bn
<7)

66 
øblock
 = 
ù
->
i_addr
[
bn
+1];

67 (
nb
);

74 
œrge
:

75 
i
 = 
bn
>>8;

76 if(
bn
 & 0174000)

77 
i
 = 7;

78 if((
nb
=
ù
->
i_addr
[
i
]) == 0) {

79 
ù
->
i_Êag
 =| 
IUPD
;

80 i‡((
bp
 = 
	`Æloc
(
d
)Ë=
NULL
)

81 (
NULL
);

82 
ù
->
i_addr
[
i
] = 
bp
->
b_blkno
;

84 
bp
 = 
	`bªad
(
d
, 
nb
);

85 
b≠
 = 
bp
->
b_addr
;

91 if(
i
 == 7) {

92 
i
 = ((
bn
>>8) & 0377) - 7;

93 if((
nb
=
b≠
[
i
]) == 0) {

94 if((
nbp
 = 
	`Æloc
(
d
)Ë=
NULL
) {

95 
	`bªl£
(
bp
);

96 (
NULL
);

98 
b≠
[
i
] = 
nbp
->
b_blkno
;

99 
	`bdwrôe
(
bp
);

101 
	`bªl£
(
bp
);

102 
nbp
 = 
	`bªad
(
d
, 
nb
);

104 
bp
 = 
nbp
;

105 
b≠
 = 
bp
->
b_addr
;

112 
i
 = 
bn
 & 0377;

113 if((
nb
=
b≠
[
i
]Ë=0 && (
nbp
 = 
	`Æloc
(
d
)Ë!
NULL
) {

114 
nb
 = 
nbp
->
b_blkno
;

115 
b≠
[
i
] = 
nb
;

116 
	`bdwrôe
(
nbp
);

117 
	`bdwrôe
(
bp
);

119 
	`bªl£
(
bp
);

120 
øblock
 = 0;

121 if(
i
 < 255)

122 
øblock
 = 
b≠
[
i
+1];

123 (
nb
);

124 
	}
}

132 
	$∑ssc
(
c
)

133 
c
;

136 if(
u
.
u_£gÊg
)

137 *
u
.
u_ba£
 = 
c
; 

138 if(
	`subyã
(
u
.
u_ba£
, 
c
) < 0) {

139 
u
.
u_îr‹
 = 
EFAULT
;

142 
u
.
u_cou¡
--;

143 if(++
u
.
u_off£t
[1] == 0)

144 
u
.
u_off£t
[0]++;

145 
u
.
u_ba£
++;

146 (
u
.
u_cou¡
 == 0? -1: 0);

147 
	}
}

156 
	$˝ass
()

158 
c
;

160 if(
u
.
u_cou¡
 == 0)

162 if(
u
.
u_£gÊg
)

163 
c
 = *
u
.
u_ba£
; 

164 if((
c
=
	`fubyã
(
u
.
u_ba£
)) < 0) {

165 
u
.
u_îr‹
 = 
EFAULT
;

168 
u
.
u_cou¡
--;

169 if(++
u
.
u_off£t
[1] == 0)

170 
u
.
u_off£t
[0]++;

171 
u
.
u_ba£
++;

172 (
c
&0377);

173 
	}
}

179 
	$nodev
()

182 
u
.
u_îr‹
 = 
ENODEV
;

183 
	}
}

189 
	$nuŒdev
()

191 
	}
}

196 
	$bc›y
(
‰om
, 
to
, 
cou¡
)

197 *
‰om
, *
to
;

199 *
a
, *
b
, 
c
;

201 
a
 = 
‰om
;

202 
b
 = 
to
;

203 
c
 = 
cou¡
;

205 *
b
++ = *
a
++;

206 --
c
);

207 
	}
}

	@ken/sys1.c

5 
	~"../∑øm.h
"

6 
	~"../sy°m.h
"

7 
	~"../u£r.h
"

8 
	~"../¥oc.h
"

9 
	~"../buf.h
"

10 
	~"../ªg.h
"

11 
	~"../öode.h
"

22 
	#EXPRI
 -1

	)

24 
	$exec
()

26 
≠
, 
«
, 
nc
, *
bp
;

27 
ts
, 
ds
, 
£p
;

28 
c
, *
ù
;

29 *
˝
;

30 
uch¨
;

38 
ù
 = 
	`«mei
(&
uch¨
, 0);

39 if(
ù
 =
NULL
)

41 
exe˙t
 >
NEXEC
)

42 
	`¶ìp
(&
exe˙t
, 
EXPRI
);

43 
exe˙t
++;

44 
bp
 = 
	`gëblk
(
NODEV
);

45 if(
	`ac˚ss
(
ù
, 
IEXEC
Ë|| (ù->
i_mode
&
IFMT
)!=0)

46 
bad
;

53 
˝
 = 
bp
->
b_addr
;

54 
«
 = 0;

55 
nc
 = 0;

56 
≠
 = 
	`fuw‹d
(
u
.
u_¨g
[1])) {

57 
«
++;

58 if(
≠
 == -1)

59 
bad
;

60 
u
.
u_¨g
[1] =+ 2;

62 
c
 = 
	`fubyã
(
≠
++);

63 if(
c
 == -1)

64 
bad
;

65 *
˝
++ = 
c
;

66 
nc
++;

67 if(
nc
 > 510) {

68 
u
.
u_îr‹
 = 
E2BIG
;

69 
bad
;

71 if(
c
 == 0)

75 if((
nc
&1) != 0) {

76 *
˝
++ = 0;

77 
nc
++;

90 
u
.
u_ba£
 = &u.
u_¨g
[0];

91 
u
.
u_cou¡
 = 8;

92 
u
.
u_off£t
[1] = 0;

93 
u
.
u_off£t
[0] = 0;

94 
u
.
u_£gÊg
 = 1;

95 
	`ªadi
(
ù
);

96 
u
.
u_£gÊg
 = 0;

97 if(
u
.
u_îr‹
)

98 
bad
;

99 
£p
 = 0;

100 if(
u
.
u_¨g
[0] == 0407) {

101 
u
.
u_¨g
[2] =+ u.u_arg[1];

102 
u
.
u_¨g
[1] = 0;

104 if(
u
.
u_¨g
[0] == 0411)

105 
£p
++; 

106 if(
u
.
u_¨g
[0] != 0410) {

107 
u
.
u_îr‹
 = 
ENOEXEC
;

108 
bad
;

110 if(
u
.
u_¨g
[1]!=0 && (
ù
->
i_Êag
&
ITEXT
)==0 && ip->
i_cou¡
!=1) {

111 
u
.
u_îr‹
 = 
ETXTBSY
;

112 
bad
;

121 
ts
 = ((
u
.
u_¨g
[1]+63)>>6) & 01777;

122 
ds
 = ((
u
.
u_¨g
[2]+u.u_arg[3]+63)>>6) & 01777;

123 if(
	`e°abur
(
ts
, 
ds
, 
SSIZE
, 
£p
))

124 
bad
;

132 
u
.
u_¥of
[3] = 0;

133 
	`x‰ì
();

134 
	`ex∑nd
(
USIZE
);

135 
	`xÆloc
(
ù
);

136 
c
 = 
USIZE
+
ds
+
SSIZE
;

137 
	`ex∑nd
(
c
);

138 --
c
 >
USIZE
)

139 
	`˛ór£g
(
u
.
u_¥o˝
->
p_addr
+
c
);

145 
	`e°abur
(0, 
ds
, 0, 0);

146 
u
.
u_ba£
 = 0;

147 
u
.
u_off£t
[1] = 020+u.
u_¨g
[1];

148 
u
.
u_cou¡
 = u.
u_¨g
[2];

149 
	`ªadi
(
ù
);

155 
u
.
u_tsize
 = 
ts
;

156 
u
.
u_dsize
 = 
ds
;

157 
u
.
u_ssize
 = 
SSIZE
;

158 
u
.
u_£p
 = 
£p
;

159 
	`e°abur
(
u
.
u_tsize
, u.
u_dsize
, u.
u_ssize
, u.
u_£p
);

160 
˝
 = 
bp
->
b_addr
;

161 
≠
 = -
nc
 - 
«
*2 - 4;

162 
u
.
u_¨0
[
R6
] = 
≠
;

163 
	`suw‹d
(
≠
, 
«
);

164 
c
 = -
nc
;

165 
«
--) {

166 
	`suw‹d
(
≠
=+2, 
c
);

168 
	`subyã
(
c
++, *
˝
);

169 *
˝
++);

171 
	`suw‹d
(
≠
+2, -1);

177 i‡((
u
.
u_¥o˝
->
p_Êag
&
STRC
)==0) {

178 if(
ù
->
i_mode
&
ISUID
)

179 if(
u
.
u_uid
 != 0) {

180 
u
.
u_uid
 = 
ù
->
i_uid
;

181 
u
.
u_¥o˝
->
p_uid
 = 
ù
->
i_uid
;

183 if(
ù
->
i_mode
&
ISGID
)

184 
u
.
u_gid
 = 
ù
->
i_gid
;

191 
c
 = 
ù
;

192 
ù
 = &
u
.
u_sig«l
[0]; i∞< &u.u_sig«l[
NSIG
]; ip++)

193 if((*
ù
 & 1) == 0)

194 *
ù
 = 0;

195 
˝
 = &
ªgloc
[0]; cp < &regloc[6];)

196 
u
.
u_¨0
[*
˝
++] = 0;

197 
u
.
u_¨0
[
R7
] = 0;

198 
ù
 = &
u
.
u_fßv
[0]; ip < &u.u_fsav[25];)

199 *
ù
++ = 0;

200 
ù
 = 
c
;

202 
bad
:

203 
	`ùut
(
ù
);

204 
	`bªl£
(
bp
);

205 if(
exe˙t
 >
NEXEC
)

206 
	`wakeup
(&
exe˙t
);

207 
exe˙t
--;

208 
	}
}

214 
	$ªxô
()

217 
u
.
u_¨g
[0] = u.
u_¨0
[
R0
] << 8;

218 
	`exô
();

219 
	}
}

228 
	$exô
()

230 *
q
, 
a
;

231 
¥oc
 *
p
;

233 
u
.
u_¥o˝
->
p_Êag
 =& ~
STRC
;

234 
q
 = &
u
.
u_sig«l
[0]; q < &u.u_sig«l[
NSIG
];)

235 *
q
++ = 1;

236 
q
 = &
u
.
u_ofûe
[0]; q < &u.u_ofûe[
NOFILE
]; q++)

237 if(
a
 = *
q
) {

238 *
q
 = 
NULL
;

239 
	`˛o£f
(
a
);

241 
	`ùut
(
u
.
u_cdú
);

242 
	`x‰ì
();

243 
a
 = 
	`mÆloc
(
sw≠m≠
, 1);

244 if(
a
 =
NULL
)

245 
	`∑nic
("out of swap");

246 
p
 = 
	`gëblk
(
sw≠dev
, 
a
);

247 
	`bc›y
(&
u
, 
p
->
b_addr
, 256);

248 
	`bwrôe
(
p
);

249 
q
 = 
u
.
u_¥o˝
;

250 
	`m‰ì
(
c‹em≠
, 
q
->
p_size
, q->
p_addr
);

251 
q
->
p_addr
 = 
a
;

252 
q
->
p_°©
 = 
SZOMB
;

254 
lo›
:

255 
p
 = &
¥oc
[0];Ö < &¥oc[
NPROC
];Ö++)

256 if(
q
->
p_µid
 =
p
->
p_pid
) {

257 
	`wakeup
(&
¥oc
[1]);

258 
	`wakeup
(
p
);

259 
p
 = &
¥oc
[0];Ö < &¥oc[
NPROC
];Ö++)

260 if(
q
->
p_pid
 =
p
->
p_µid
) {

261 
p
->
p_µid
 = 1;

262 i‡(
p
->
p_°©
 =
SSTOP
)

263 
	`£åun
(
p
);

265 
	`swtch
();

268 
q
->
p_µid
 = 1;

269 
lo›
;

270 
	}
}

279 
	$waô
()

281 
f
, *
bp
;

282 
¥oc
 *
p
;

284 
f
 = 0;

286 
lo›
:

287 
p
 = &
¥oc
[0];Ö < &¥oc[
NPROC
];Ö++)

288 if(
p
->
p_µid
 =
u
.
u_¥o˝
->
p_pid
) {

289 
f
++;

290 if(
p
->
p_°©
 =
SZOMB
) {

291 
u
.
u_¨0
[
R0
] = 
p
->
p_pid
;

292 
bp
 = 
	`bªad
(
sw≠dev
, 
f
=
p
->
p_addr
);

293 
	`m‰ì
(
sw≠m≠
, 1, 
f
);

294 
p
->
p_°©
 = 
NULL
;

295 
p
->
p_pid
 = 0;

296 
p
->
p_µid
 = 0;

297 
p
->
p_sig
 = 0;

298 
p
->
p_âyp
 = 0;

299 
p
->
p_Êag
 = 0;

300 
p
 = 
bp
->
b_addr
;

301 
u
.
u_c°ime
[0] =+ 
p
->u_cstime[0];

302 
	`d∑dd
(
u
.
u_c°ime
, 
p
->u_cstime[1]);

303 
	`d∑dd
(
u
.
u_c°ime
, 
p
->
u_°ime
);

304 
u
.
u_cutime
[0] =+ 
p
->u_cutime[0];

305 
	`d∑dd
(
u
.
u_cutime
, 
p
->u_cutime[1]);

306 
	`d∑dd
(
u
.
u_cutime
, 
p
->
u_utime
);

307 
u
.
u_¨0
[
R1
] = 
p
->
u_¨g
[0];

308 
	`bªl£
(
bp
);

311 if(
p
->
p_°©
 =
SSTOP
) {

312 if((
p
->
p_Êag
&
SWTED
) == 0) {

313 
p
->
p_Êag
 =| 
SWTED
;

314 
u
.
u_¨0
[
R0
] = 
p
->
p_pid
;

315 
u
.
u_¨0
[
R1
] = (
p
->
p_sig
<<8) | 0177;

318 
p
->
p_Êag
 =& ~(
STRC
|
SWTED
);

319 
	`£åun
(
p
);

322 if(
f
) {

323 
	`¶ìp
(
u
.
u_¥o˝
, 
PWAIT
);

324 
lo›
;

326 
u
.
u_îr‹
 = 
ECHILD
;

327 
	}
}

332 
	$f‹k
()

334 
¥oc
 *
p1
, *
p2
;

336 
p1
 = 
u
.
u_¥o˝
;

337 
p2
 = &
¥oc
[0];Ö2 < &¥oc[
NPROC
];Ö2++)

338 if(
p2
->
p_°©
 =
NULL
)

339 
found
;

340 
u
.
u_îr‹
 = 
EAGAIN
;

341 
out
;

343 
found
:

344 if(
	`√w¥oc
()) {

345 
u
.
u_¨0
[
R0
] = 
p1
->
p_pid
;

346 
u
.
u_c°ime
[0] = 0;

347 
u
.
u_c°ime
[1] = 0;

348 
u
.
u_°ime
 = 0;

349 
u
.
u_cutime
[0] = 0;

350 
u
.
u_cutime
[1] = 0;

351 
u
.
u_utime
 = 0;

354 
u
.
u_¨0
[
R0
] = 
p2
->
p_pid
;

356 
out
:

357 
u
.
u_¨0
[
R7
] =+ 2;

358 
	}
}

364 
	$sbªak
()

366 
a
, 
n
, 
d
;

367 
i
;

375 
n
 = (((
u
.
u_¨g
[0]+63)>>6) & 01777);

376 if(!
u
.
u_£p
)

377 
n
 =- 
	`n£g
(
u
.
u_tsize
) * 128;

378 if(
n
 < 0)

379 
n
 = 0;

380 
d
 = 
n
 - 
u
.
u_dsize
;

381 
n
 =+ 
USIZE
+
u
.
u_ssize
;

382 if(
	`e°abur
(
u
.
u_tsize
, u.
u_dsize
+
d
, u.
u_ssize
, u.
u_£p
))

384 
u
.
u_dsize
 =+ 
d
;

385 if(
d
 > 0)

386 
biggî
;

387 
a
 = 
u
.
u_¥o˝
->
p_addr
 + 
n
 - u.
u_ssize
;

388 
i
 = 
n
;

389 
n
 = 
u
.
u_ssize
;

390 
n
--) {

391 
	`c›y£g
(
a
-
d
,á);

392 
a
++;

394 
	`ex∑nd
(
i
);

397 
biggî
:

398 
	`ex∑nd
(
n
);

399 
a
 = 
u
.
u_¥o˝
->
p_addr
 + 
n
;

400 
n
 = 
u
.
u_ssize
;

401 
n
--) {

402 
a
--;

403 
	`c›y£g
(
a
-
d
,á);

405 
d
--)

406 
	`˛ór£g
(--
a
);

407 
	}
}

	@ken/sys2.c

1 
#ö˛udê
	~"../∑øm.h
"

3 
	~"../sy°m.h
"

4 
	~"../u£r.h
"

5 
	~"../ªg.h
"

6 
	~"../fûe.h
"

7 
	~"../öode.h
"

12 
	$ªad
()

14 
	`rdwr
(
FREAD
);

15 
	}
}

20 
	$wrôe
()

22 
	`rdwr
(
FWRITE
);

23 
	}
}

30 
	$rdwr
(
mode
)

32 *
Â
, 
m
;

34 
m
 = 
mode
;

35 
Â
 = 
	`gëf
(
u
.
u_¨0
[
R0
]);

36 if(
Â
 =
NULL
)

38 if((
Â
->
f_Êag
&
m
) == 0) {

39 
u
.
u_îr‹
 = 
EBADF
;

42 
u
.
u_ba£
 = u.
u_¨g
[0];

43 
u
.
u_cou¡
 = u.
u_¨g
[1];

44 
u
.
u_£gÊg
 = 0;

45 if(
Â
->
f_Êag
&
FPIPE
) {

46 if(
m
==
FREAD
)

47 
	`ªadp
(
Â
); 

48 
	`wrôï
(
Â
);

50 
u
.
u_off£t
[1] = 
Â
->
f_off£t
[1];

51 
u
.
u_off£t
[0] = 
Â
->
f_off£t
[0];

52 if(
m
==
FREAD
)

53 
	`ªadi
(
Â
->
f_öode
); 

54 
	`wrôei
(
Â
->
f_öode
);

55 
	`d∑dd
(
Â
->
f_off£t
, 
u
.
u_¨g
[1]-u.
u_cou¡
);

57 
u
.
u_¨0
[
R0
] = u.
u_¨g
[1]-u.
u_cou¡
;

58 
	}
}

63 
	$›í
()

65 *
ù
;

66 
uch¨
;

68 
ù
 = 
	`«mei
(&
uch¨
, 0);

69 if(
ù
 =
NULL
)

71 
u
.
u_¨g
[1]++;

72 
	`›í1
(
ù
, 
u
.
u_¨g
[1], 0);

73 
	}
}

78 
	$¸ót
()

80 *
ù
;

81 
uch¨
;

83 
ù
 = 
	`«mei
(&
uch¨
, 1);

84 if(
ù
 =
NULL
) {

85 if(
u
.
u_îr‹
)

87 
ù
 = 
	`maknode
(
u
.
u_¨g
[1]&07777&(~
ISVTX
));

88 i‡(
ù
==
NULL
)

90 
	`›í1
(
ù
, 
FWRITE
, 2);

92 
	`›í1
(
ù
, 
FWRITE
, 1);

93 
	}
}

100 
	$›í1
(
ù
, 
mode
, 
åf
)

101 *
ù
;

103 
fûe
 *
Â
;

104 *
rù
, 
m
;

105 
i
;

107 
rù
 = 
ù
;

108 
m
 = 
mode
;

109 if(
åf
 != 2) {

110 if(
m
&
FREAD
)

111 
	`ac˚ss
(
rù
, 
IREAD
);

112 if(
m
&
FWRITE
) {

113 
	`ac˚ss
(
rù
, 
IWRITE
);

114 if((
rù
->
i_mode
&
IFMT
Ë=
IFDIR
)

115 
u
.
u_îr‹
 = 
EISDIR
;

118 if(
u
.
u_îr‹
)

119 
out
;

120 if(
åf
)

121 
	`ôrunc
(
rù
);

122 
	`¥ñe
(
rù
);

123 i‡((
Â
 = 
	`ÁŒoc
()Ë=
NULL
)

124 
out
;

125 
Â
->
f_Êag
 = 
m
&(
FREAD
|
FWRITE
);

126 
Â
->
f_öode
 = 
rù
;

127 
i
 = 
u
.
u_¨0
[
R0
];

128 
	`›íi
(
rù
, 
m
&
FWRITE
);

129 if(
u
.
u_îr‹
 == 0)

131 
u
.
u_ofûe
[
i
] = 
NULL
;

132 
Â
->
f_cou¡
--;

134 
out
:

135 
	`ùut
(
rù
);

136 
	}
}

141 
	$˛o£
()

143 *
Â
;

145 
Â
 = 
	`gëf
(
u
.
u_¨0
[
R0
]);

146 if(
Â
 =
NULL
)

148 
u
.
u_ofûe
[u.
u_¨0
[
R0
]] = 
NULL
;

149 
	`˛o£f
(
Â
);

150 
	}
}

155 
	$£ek
()

157 
n
[2];

158 *
Â
, 
t
;

160 
Â
 = 
	`gëf
(
u
.
u_¨0
[
R0
]);

161 if(
Â
 =
NULL
)

163 if(
Â
->
f_Êag
&
FPIPE
) {

164 
u
.
u_îr‹
 = 
ESPIPE
;

167 
t
 = 
u
.
u_¨g
[1];

168 if(
t
 > 2) {

169 
n
[1] = 
u
.
u_¨g
[0]<<9;

170 
n
[0] = 
u
.
u_¨g
[0]>>7;

171 if(
t
 == 3)

172 
n
[0] =& 0777;

174 
n
[1] = 
u
.
u_¨g
[0];

175 
n
[0] = 0;

176 if(
t
!=0 && 
n
[1]<0)

177 
n
[0] = -1;

179 
t
) {

183 
n
[0] =+ 
Â
->
f_off£t
[0];

184 
	`d∑dd
(
n
, 
Â
->
f_off£t
[1]);

188 
n
[0] =+ 
Â
->
f_öode
->
i_size0
&0377;

189 
	`d∑dd
(
n
, 
Â
->
f_öode
->
i_size1
);

195 
Â
->
f_off£t
[1] = 
n
[1];

196 
Â
->
f_off£t
[0] = 
n
[0];

197 
	}
}

202 
	$lök
()

204 *
ù
, *
xp
;

205 
uch¨
;

207 
ù
 = 
	`«mei
(&
uch¨
, 0);

208 if(
ù
 =
NULL
)

210 if(
ù
->
i_∆ök
 >= 127) {

211 
u
.
u_îr‹
 = 
EMLINK
;

212 
out
;

214 if((
ù
->
i_mode
&
IFMT
)==
IFDIR
 && !
	`su£r
())

215 
out
;

219 
ù
->
i_Êag
 =& ~
ILOCK
;

220 
u
.
u_dúp
 = u.
u_¨g
[1];

221 
xp
 = 
	`«mei
(&
uch¨
, 1);

222 if(
xp
 !
NULL
) {

223 
u
.
u_îr‹
 = 
EEXIST
;

224 
	`ùut
(
xp
);

226 if(
u
.
u_îr‹
)

227 
out
;

228 if(
u
.
u_pdú
->
i_dev
 !
ù
->i_dev) {

229 
	`ùut
(
u
.
u_pdú
);

230 
u
.
u_îr‹
 = 
EXDEV
;

231 
out
;

233 
	`wdú
(
ù
);

234 
ù
->
i_∆ök
++;

235 
ù
->
i_Êag
 =| 
IUPD
;

237 
out
:

238 
	`ùut
(
ù
);

239 
	}
}

244 
	$mknod
()

246 *
ù
;

247 
uch¨
;

249 if(
	`su£r
()) {

250 
ù
 = 
	`«mei
(&
uch¨
, 1);

251 if(
ù
 !
NULL
) {

252 
u
.
u_îr‹
 = 
EEXIST
;

253 
out
;

256 if(
u
.
u_îr‹
)

258 
ù
 = 
	`maknode
(
u
.
u_¨g
[1]);

259 i‡(
ù
==
NULL
)

261 
ù
->
i_addr
[0] = 
u
.
u_¨g
[2];

263 
out
:

264 
	`ùut
(
ù
);

265 
	}
}

271 
	$s¶ï
()

273 *
d
[2];

275 
	`•l7
();

276 
d
[0] = 
time
[0];

277 
d
[1] = 
time
[1];

278 
	`d∑dd
(
d
, 
u
.
u_¨0
[
R0
]);

280 
	`dpcmp
(
d
[0], d[1], 
time
[0],Åime[1]) > 0) {

281 if(
	`dpcmp
(
tout
[0],Åout[1], 
time
[0],Åime[1]) <= 0 ||

282 
	`dpcmp
(
tout
[0],Åout[1], 
d
[0], d[1]) > 0) {

283 
tout
[0] = 
d
[0];

284 
tout
[1] = 
d
[1];

286 
	`¶ìp
(
tout
, 
PSLEP
);

288 
	`•l0
();

289 
	}
}

	@ken/sys3.c

5 
	~"../∑øm.h
"

6 
	~"../sy°m.h
"

7 
	~"../ªg.h
"

8 
	~"../buf.h
"

9 
	~"../fûsys.h
"

10 
	~"../u£r.h
"

11 
	~"../öode.h
"

12 
	~"../fûe.h
"

13 
	~"../c⁄f.h
"

18 
	$f°©
()

20 *
Â
;

22 
Â
 = 
	`gëf
(
u
.
u_¨0
[
R0
]);

23 if(
Â
 =
NULL
)

25 
	`°©1
(
Â
->
f_öode
, 
u
.
u_¨g
[0]);

26 
	}
}

31 
	$°©
()

33 
ù
;

34 
uch¨
;

36 
ù
 = 
	`«mei
(&
uch¨
, 0);

37 if(
ù
 =
NULL
)

39 
	`°©1
(
ù
, 
u
.
u_¨g
[1]);

40 
	`ùut
(
ù
);

41 
	}
}

47 
	$°©1
(
ù
, 
ub
)

48 *
ù
;

50 
i
, *
bp
, *
˝
;

52 
	`iupd©
(
ù
, 
time
);

53 
bp
 = 
	`bªad
(
ù
->
i_dev
, 
	`ldiv
(ù->
i_numbî
+31, 16));

54 
˝
 = 
bp
->
b_addr
 + 32*
	`Ãem
(
ù
->
i_numbî
+31, 16) + 24;

55 
ù
 = &(ù->
i_dev
);

56 
i
=0; i<14; i++) {

57 
	`suw‹d
(
ub
, *
ù
++);

58 
ub
 =+ 2;

60 
i
=0; i<4; i++) {

61 
	`suw‹d
(
ub
, *
˝
++);

62 
ub
 =+ 2;

64 
	`bªl£
(
bp
);

65 
	}
}

70 
	$dup
()

72 
i
, *
Â
;

74 
Â
 = 
	`gëf
(
u
.
u_¨0
[
R0
]);

75 if(
Â
 =
NULL
)

77 i‡((
i
 = 
	`uÁŒoc
()) < 0)

79 
u
.
u_ofûe
[
i
] = 
Â
;

80 
Â
->
f_cou¡
++;

81 
	}
}

86 
	$smou¡
()

88 
d
;

89 *
ù
;

90 
mou¡
 *
mp
, *
smp
;

91 
uch¨
;

93 
d
 = 
	`gëmdev
();

94 if(
u
.
u_îr‹
)

96 
u
.
u_dúp
 = u.
u_¨g
[1];

97 
ù
 = 
	`«mei
(&
uch¨
, 0);

98 if(
ù
 =
NULL
)

100 if(
ù
->
i_cou¡
!=1 || (ù->
i_mode
&(
IFBLK
&
IFCHR
))!=0)

101 
out
;

102 
smp
 = 
NULL
;

103 
mp
 = &
mou¡
[0]; m∞< &mou¡[
NMOUNT
]; mp++) {

104 if(
mp
->
m_buÂ
 !
NULL
) {

105 if(
d
 =
mp
->
m_dev
)

106 
out
;

108 if(
smp
 =
NULL
)

109 
smp
 = 
mp
;

111 if(
smp
 =
NULL
)

112 
out
;

113 (*
bdevsw
[
d
.
d_maj‹
].
d_›í
)(d, !
u
.
u_¨g
[2]);

114 if(
u
.
u_îr‹
)

115 
out
;

116 
mp
 = 
	`bªad
(
d
, 1);

117 if(
u
.
u_îr‹
) {

118 
	`bªl£
(
mp
);

119 
out1
;

121 
smp
->
m_öodp
 = 
ù
;

122 
smp
->
m_dev
 = 
d
;

123 
smp
->
m_buÂ
 = 
	`gëblk
(
NODEV
);

124 
	`bc›y
(
mp
->
b_addr
, 
smp
->
m_buÂ
->b_addr, 256);

125 
smp
 = smp->
m_buÂ
->
b_addr
;

126 
smp
->
s_ûock
 = 0;

127 
smp
->
s_Êock
 = 0;

128 
smp
->
s_r⁄ly
 = 
u
.
u_¨g
[2] & 1;

129 
	`bªl£
(
mp
);

130 
ù
->
i_Êag
 =| 
IMOUNT
;

131 
	`¥ñe
(
ù
);

134 
out
:

135 
u
.
u_îr‹
 = 
EBUSY
;

136 
out1
:

137 
	`ùut
(
ù
);

138 
	}
}

143 
	$sumou¡
()

145 
d
;

146 
öode
 *
ù
;

147 
mou¡
 *
mp
;

149 
	`upd©e
();

150 
d
 = 
	`gëmdev
();

151 if(
u
.
u_îr‹
)

153 
mp
 = &
mou¡
[0]; m∞< &mou¡[
NMOUNT
]; mp++)

154 if(
mp
->
m_buÂ
!=
NULL
 && 
d
==mp->
m_dev
)

155 
found
;

156 
u
.
u_îr‹
 = 
EINVAL
;

159 
found
:

160 
ù
 = &
öode
[0]; i∞< &öode[
NINODE
]; ip++)

161 if(
ù
->
i_numbî
!=0 && 
d
==ù->
i_dev
) {

162 
u
.
u_îr‹
 = 
EBUSY
;

165 (*
bdevsw
[
d
.
d_maj‹
].
d_˛o£
)(d, 0);

166 
ù
 = 
mp
->
m_öodp
;

167 
ù
->
i_Êag
 =& ~
IMOUNT
;

168 
	`ùut
(
ù
);

169 
ù
 = 
mp
->
m_buÂ
;

170 
mp
->
m_buÂ
 = 
NULL
;

171 
	`bªl£
(
ù
);

172 
	}
}

179 
	$gëmdev
()

181 
d
, *
ù
;

182 
uch¨
;

184 
ù
 = 
	`«mei
(&
uch¨
, 0);

185 if(
ù
 =
NULL
)

187 if((
ù
->
i_mode
&
IFMT
Ë!
IFBLK
)

188 
u
.
u_îr‹
 = 
ENOTBLK
;

189 
d
 = 
ù
->
i_addr
[0];

190 if(
ù
->
i_addr
[0].
d_maj‹
 >
nblkdev
)

191 
u
.
u_îr‹
 = 
ENXIO
;

192 
	`ùut
(
ù
);

193 (
d
);

194 
	}
}

	@ken/sys4.c

9 
	~"../∑øm.h
"

10 
	~"../u£r.h
"

11 
	~"../ªg.h
"

12 
	~"../öode.h
"

13 
	~"../sy°m.h
"

14 
	~"../¥oc.h
"

16 
	$gëswô
()

19 
u
.
u_¨0
[
R0
] = 
SW
->
öãg
;

20 
	}
}

22 
	$gtime
()

25 
u
.
u_¨0
[
R0
] = 
time
[0];

26 
u
.
u_¨0
[
R1
] = 
time
[1];

27 
	}
}

29 
	$°ime
()

32 if(
	`su£r
()) {

33 
time
[0] = 
u
.
u_¨0
[
R0
];

34 
time
[1] = 
u
.
u_¨0
[
R1
];

35 
	`wakeup
(
tout
);

37 
	}
}

39 
	$£tuid
()

41 
uid
;

43 
uid
 = 
u
.
u_¨0
[
R0
].
lobyã
;

44 if(
u
.
u_ruid
 =
uid
.
lobyã
 || 
	`su£r
()) {

45 
u
.
u_uid
 = 
uid
;

46 
u
.
u_¥o˝
->
p_uid
 = 
uid
;

47 
u
.
u_ruid
 = 
uid
;

49 
	}
}

51 
	$gëuid
()

54 
u
.
u_¨0
[
R0
].
lobyã
 = u.
u_ruid
;

55 
u
.
u_¨0
[
R0
].
hibyã
 = u.
u_uid
;

56 
	}
}

58 
	$£tgid
()

60 
gid
;

62 
gid
 = 
u
.
u_¨0
[
R0
].
lobyã
;

63 if(
u
.
u_rgid
 =
gid
.
lobyã
 || 
	`su£r
()) {

64 
u
.
u_gid
 = 
gid
;

65 
u
.
u_rgid
 = 
gid
;

67 
	}
}

69 
	$gëgid
()

72 
u
.
u_¨0
[
R0
].
lobyã
 = u.
u_rgid
;

73 
u
.
u_¨0
[
R0
].
hibyã
 = u.
u_gid
;

74 
	}
}

76 
	$gëpid
()

78 
u
.
u_¨0
[
R0
] = u.
u_¥o˝
->
p_pid
;

79 
	}
}

81 
	$sync
()

84 
	`upd©e
();

85 
	}
}

87 
	$ni˚
()

89 
n
;

91 
n
 = 
u
.
u_¨0
[
R0
];

92 if(
n
 > 20)

93 
n
 = 20;

94 if(
n
 < 0 && !
	`su£r
())

95 
n
 = 0;

96 
u
.
u_¥o˝
->
p_ni˚
 = 
n
;

97 
	}
}

103 
	$u∆ök
()

105 *
ù
, *
µ
;

106 
uch¨
;

108 
µ
 = 
	`«mei
(&
uch¨
, 2);

109 if(
µ
 =
NULL
)

111 
	`¥ñe
(
µ
);

112 
ù
 = 
	`igë
(
µ
->
i_dev
, 
u
.
u_dít
.
u_öo
);

113 if(
ù
 =
NULL
)

114 
	`∑nic
("unlink -- iget");

115 if((
ù
->
i_mode
&
IFMT
)==
IFDIR
 && !
	`su£r
())

116 
out
;

117 
u
.
u_off£t
[1] =- 
DIRSIZ
+2;

118 
u
.
u_ba£
 = &u.
u_dít
;

119 
u
.
u_cou¡
 = 
DIRSIZ
+2;

120 
u
.
u_dít
.
u_öo
 = 0;

121 
	`wrôei
(
µ
);

122 
ù
->
i_∆ök
--;

123 
ù
->
i_Êag
 =| 
IUPD
;

125 
out
:

126 
	`ùut
(
µ
);

127 
	`ùut
(
ù
);

128 
	}
}

130 
	$chdú
()

132 *
ù
;

133 
uch¨
;

135 
ù
 = 
	`«mei
(&
uch¨
, 0);

136 if(
ù
 =
NULL
)

138 if((
ù
->
i_mode
&
IFMT
Ë!
IFDIR
) {

139 
u
.
u_îr‹
 = 
ENOTDIR
;

140 
bad
:

141 
	`ùut
(
ù
);

144 if(
	`ac˚ss
(
ù
, 
IEXEC
))

145 
bad
;

146 
	`ùut
(
u
.
u_cdú
);

147 
u
.
u_cdú
 = 
ù
;

148 
	`¥ñe
(
ù
);

149 
	}
}

151 
	$chmod
()

153 *
ù
;

155 i‡((
ù
 = 
	`ow√r
()Ë=
NULL
)

157 
ù
->
i_mode
 =& ~07777;

158 i‡(
u
.
u_uid
)

159 
u
.
u_¨g
[1] =& ~
ISVTX
;

160 
ù
->
i_mode
 =| 
u
.
u_¨g
[1]&07777;

161 
ù
->
i_Êag
 =| 
IUPD
;

162 
	`ùut
(
ù
);

163 
	}
}

165 
	$chown
()

167 *
ù
;

169 i‡(!
	`su£r
(Ë|| (
ù
 = 
	`ow√r
()Ë=
NULL
)

171 
ù
->
i_uid
 = 
u
.
u_¨g
[1].
lobyã
;

172 
ù
->
i_gid
 = 
u
.
u_¨g
[1].
hibyã
;

173 
ù
->
i_Êag
 =| 
IUPD
;

174 
	`ùut
(
ù
);

175 
	}
}

202 
	$ssig
()

204 
a
;

206 
a
 = 
u
.
u_¨g
[0];

207 if(
a
<=0 ||á>=
NSIG
 ||á ==
SIGKIL
) {

208 
u
.
u_îr‹
 = 
EINVAL
;

211 
u
.
u_¨0
[
R0
] = u.
u_sig«l
[
a
];

212 
u
.
u_sig«l
[
a
] = u.
u_¨g
[1];

213 if(
u
.
u_¥o˝
->
p_sig
 =
a
)

214 
u
.
u_¥o˝
->
p_sig
 = 0;

215 
	}
}

217 
	$kûl
()

219 
¥oc
 *
p
, *
q
;

220 
a
;

221 
f
;

223 
f
 = 0;

224 
a
 = 
u
.
u_¨0
[
R0
];

225 
q
 = 
u
.
u_¥o˝
;

226 
p
 = &
¥oc
[0];Ö < &¥oc[
NPROC
];Ö++) {

227 if(
p
 =
q
)

229 if(
a
 !0 && 
p
->
p_pid
 !=á)

231 if(
a
 =0 && (
p
->
p_âyp
 !
q
->p_ây∞||Ö <&
¥oc
[1]))

233 if(
u
.
u_uid
 !0 && u.u_uid !
p
->
p_uid
)

235 
f
++;

236 
	`psig«l
(
p
, 
u
.
u_¨g
[0]);

238 if(
f
 == 0)

239 
u
.
u_îr‹
 = 
ESRCH
;

240 
	}
}

242 
	$times
()

244 *
p
;

246 
p
 = &
u
.
u_utime
;Ö < &u.u_utime+6;) {

247 
	`suw‹d
(
u
.
u_¨g
[0], *
p
++);

248 
u
.
u_¨g
[0] =+ 2;

250 
	}
}

252 
	$¥ofû
()

255 
u
.
u_¥of
[0] = u.
u_¨g
[0] & ~1;

256 
u
.
u_¥of
[1] = u.
u_¨g
[1];

257 
u
.
u_¥of
[2] = u.
u_¨g
[2];

258 
u
.
u_¥of
[3] = (u.
u_¨g
[3]>>1) & 077777;

259 
	}
}

	@ken/sysent.c

11 
	gsy£¡
[]

13 0, &
	gnuŒsys
,

14 0, &
	gªxô
,

15 0, &
	gf‹k
,

16 2, &
	gªad
,

17 2, &
	gwrôe
,

18 2, &
	g›í
,

19 0, &
	g˛o£
,

20 0, &
	gwaô
,

21 2, &
	g¸ót
,

22 2, &
	glök
,

23 1, &
	gu∆ök
,

24 2, &
	gexec
,

25 1, &
	gchdú
,

26 0, &
	ggtime
,

27 3, &
	gmknod
,

28 2, &
	gchmod
,

29 2, &
	gchown
,

30 1, &
	gsbªak
,

31 2, &
	g°©
,

32 2, &
	g£ek
,

33 0, &
	ggëpid
,

34 3, &
	gsmou¡
,

35 1, &
	gsumou¡
,

36 0, &
	g£tuid
,

37 0, &
	ggëuid
,

38 0, &
	g°ime
,

39 3, &
	g±ø˚
,

40 0, &
	gnosys
,

41 1, &
	gf°©
,

42 0, &
	gnosys
,

43 1, &
	gnuŒsys
,

44 1, &
	g°ty
,

45 1, &
	ggây
,

46 0, &
	gnosys
,

47 0, &
	gni˚
,

48 0, &
	gs¶ï
,

49 0, &
	gsync
,

50 1, &
	gkûl
,

51 0, &
	ggëswô
,

52 0, &
	gnosys
,

53 0, &
	gnosys
,

54 0, &
	gdup
,

55 0, &
	gpùe
,

56 1, &
	gtimes
,

57 4, &
	g¥ofû
,

58 0, &
	gnosys
,

59 0, &
	g£tgid
,

60 0, &
	ggëgid
,

61 2, &
	gssig
,

62 0, &
	gnosys
,

63 0, &
	gnosys
,

64 0, &
	gnosys
,

65 0, &
	gnosys
,

66 0, &
	gnosys
,

67 0, &
	gnosys
,

68 0, &
	gnosys
,

69 0, &
	gnosys
,

70 0, &
	gnosys
,

71 0, &
	gnosys
,

72 0, &
	gnosys
,

73 0, &
	gnosys
,

74 0, &
	gnosys
,

75 0, &
	gnosys
,

76 0, &
	gnosys


	@ken/text.c

5 
	~"../∑øm.h
"

6 
	~"../sy°m.h
"

7 
	~"../u£r.h
"

8 
	~"../¥oc.h
"

9 
	~"../ãxt.h
"

10 
	~"../öode.h
"

23 
	$xsw≠
(
p
, 
ff
, 
os
)

24 *
p
;

26 *
Ω
, 
a
;

28 
Ω
 = 
p
;

29 if(
os
 == 0)

30 
os
 = 
Ω
->
p_size
;

31 
a
 = 
	`mÆloc
(
sw≠m≠
, (
Ω
->
p_size
+7)/8);

32 if(
a
 =
NULL
)

33 
	`∑nic
("out of swap space");

34 
	`xccdec
(
Ω
->
p_ãxç
);

35 
Ω
->
p_Êag
 =| 
SLOCK
;

36 if(
	`sw≠
(
a
, 
Ω
->
p_addr
, 
os
, 0))

37 
	`∑nic
("swapÉrror");

38 if(
ff
)

39 
	`m‰ì
(
c‹em≠
, 
os
, 
Ω
->
p_addr
);

40 
Ω
->
p_addr
 = 
a
;

41 
Ω
->
p_Êag
 =& ~(
SLOAD
|
SLOCK
);

42 
Ω
->
p_time
 = 0;

43 if(
runout
) {

44 
runout
 = 0;

45 
	`wakeup
(&
runout
);

47 
	}
}

53 
	$x‰ì
()

55 *
xp
, *
ù
;

57 if((
xp
=
u
.
u_¥o˝
->
p_ãxç
Ë!
NULL
) {

58 
u
.
u_¥o˝
->
p_ãxç
 = 
NULL
;

59 
	`xccdec
(
xp
);

60 if(--
xp
->
x_cou¡
 == 0) {

61 
ù
 = 
xp
->
x_ùå
;

62 if((
ù
->
i_mode
&
ISVTX
) == 0) {

63 
xp
->
x_ùå
 = 
NULL
;

64 
	`m‰ì
(
sw≠m≠
, (
xp
->
x_size
+7)/8, xp->
x_daddr
);

65 
ù
->
i_Êag
 =& ~
ITEXT
;

66 
	`ùut
(
ù
);

70 
	}
}

88 
	$xÆloc
(
ù
)

89 *
ù
;

91 
ãxt
 *
xp
;

92 *
Ω
, 
ts
;

94 if(
u
.
u_¨g
[1] == 0)

96 
Ω
 = 
NULL
;

97 
xp
 = &
ãxt
[0]; x∞< &ãxt[
NTEXT
]; xp++)

98 if(
xp
->
x_ùå
 =
NULL
) {

99 if(
Ω
 =
NULL
)

100 
Ω
 = 
xp
;

102 if(
xp
->
x_ùå
 =
ù
) {

103 
xp
->
x_cou¡
++;

104 
u
.
u_¥o˝
->
p_ãxç
 = 
xp
;

105 
out
;

107 if((
xp
=
Ω
Ë=
NULL
)

108 
	`∑nic
("out ofÅext");

109 
xp
->
x_cou¡
 = 1;

110 
xp
->
x_ccou¡
 = 0;

111 
xp
->
x_ùå
 = 
ù
;

112 
ts
 = ((
u
.
u_¨g
[1]+63)>>6) & 01777;

113 
xp
->
x_size
 = 
ts
;

114 if((
xp
->
x_daddr
 = 
	`mÆloc
(
sw≠m≠
, (
ts
+7)/8)Ë=
NULL
)

115 
	`∑nic
("out of swap space");

116 
	`ex∑nd
(
USIZE
+
ts
);

117 
	`e°abur
(0, 
ts
, 0, 0);

118 
u
.
u_cou¡
 = u.
u_¨g
[1];

119 
u
.
u_off£t
[1] = 020;

120 
u
.
u_ba£
 = 0;

121 
	`ªadi
(
ù
);

122 
Ω
 = 
u
.
u_¥o˝
;

123 
Ω
->
p_Êag
 =| 
SLOCK
;

124 
	`sw≠
(
xp
->
x_daddr
, 
Ω
->
p_addr
+
USIZE
, 
ts
, 0);

125 
Ω
->
p_Êag
 =& ~
SLOCK
;

126 
Ω
->
p_ãxç
 = 
xp
;

127 
Ω
 = 
ù
;

128 
Ω
->
i_Êag
 =| 
ITEXT
;

129 
Ω
->
i_cou¡
++;

130 
	`ex∑nd
(
USIZE
);

132 
out
:

133 if(
xp
->
x_ccou¡
 == 0) {

134 
	`ßvu
(
u
.
u_rßv
);

135 
	`ßvu
(
u
.
u_sßv
);

136 
	`xsw≠
(
u
.
u_¥o˝
, 1, 0);

137 
u
.
u_¥o˝
->
p_Êag
 =| 
SSWAP
;

138 
	`swtch
();

141 
xp
->
x_ccou¡
++;

142 
	}
}

148 
	$xccdec
(
xp
)

149 *
xp
;

151 *
Ω
;

153 if((
Ω
=
xp
)!=
NULL
 &&Ñp->
x_ccou¡
!=0)

154 if(--
Ω
->
x_ccou¡
 == 0)

155 
	`m‰ì
(
c‹em≠
, 
Ω
->
x_size
,Ñp->
x_ˇddr
);

156 
	}
}

	@ken/trap.c

1 
#ö˛udê
	~"../∑øm.h
"

3 
	~"../sy°m.h
"

4 
	~"../u£r.h
"

5 
	~"../¥oc.h
"

6 
	~"../ªg.h
"

7 
	~"../£g.h
"

9 
	#EBIT
 1

	)

10 
	#UMODE
 0170000

	)

11 
	#SETD
 0170011

	)

12 
	#SYS
 0104400

	)

13 
	#USER
 020

	)

18 
	ssy£¡
 {

19 
	mcou¡
;

20 (*
	mˇŒ
)();

21 } 
	gsy£¡
[64];

27 
	gªgloc
[9]

29 
	gR0
, 
	gR1
, 
	gR2
, 
	gR3
, 
	gR4
, 
	gR5
, 
	gR6
, 
	gR7
, 
	gRPS


42 
	$å≠
(
dev
, 
•
, 
r1
, 
≈s
, 
r0
, 
pc
, 
ps
)

44 
i
, 
a
;

45 
sy£¡
 *
ˇŒp
;

47 
	`ßvÂ
();

48 i‡((
ps
&
UMODE
) == UMODE)

49 
dev
 =| 
USER
;

50 
u
.
u_¨0
 = &
r0
;

51 
dev
) {

65 
	`¥ötf
("ka6 = %o\n", *
ka6
);

66 
	`¥ötf
("≠†%o\n", &
ps
);

67 
	`¥ötf
("å≠Åy≥ %o\n", 
dev
);

68 
	`∑nic
("trap");

70 0+
USER
:

71 
i
 = 
SIGBUS
;

82 1+
USER
:

83 if(
	`fuiw‹d
(
pc
-2Ë=
SETD
 && 
u
.
u_sig«l
[
SIGINS
] == 0)

84 
out
;

85 
i
 = 
SIGINS
;

88 2+
USER
:

89 
i
 = 
SIGTRC
;

92 3+
USER
:

93 
i
 = 
SIGIOT
;

96 5+
USER
:

97 
i
 = 
SIGEMT
;

100 6+
USER
:

101 
u
.
u_îr‹
 = 0;

102 
ps
 =& ~
EBIT
;

103 
ˇŒp
 = &
sy£¡
[
	`fuiw‹d
(
pc
-2)&077];

104 i‡(
ˇŒp
 =
sy£¡
) {

105 
a
 = 
	`fuiw‹d
(
pc
);

106 
pc
 =+ 2;

107 
i
 = 
	`fuw‹d
(
a
);

108 i‡((
i
 & ~077Ë!
SYS
)

109 
i
 = 077;

110 
ˇŒp
 = &
sy£¡
[
i
&077];

111 
i
=0; i<
ˇŒp
->
cou¡
; i++)

112 
u
.
u_¨g
[
i
] = 
	`fuw‹d
(
a
 =+ 2);

114 
i
=0; i<
ˇŒp
->
cou¡
; i++) {

115 
u
.
u_¨g
[
i
] = 
	`fuiw‹d
(
pc
);

116 
pc
 =+ 2;

119 
u
.
u_dúp
 = u.
u_¨g
[0];

120 
	`å≠1
(
ˇŒp
->
ˇŒ
);

121 if(
u
.
u_ötÊg
)

122 
u
.
u_îr‹
 = 
EINTR
;

123 if(
u
.
u_îr‹
 < 100) {

124 if(
u
.
u_îr‹
) {

125 
ps
 =| 
EBIT
;

126 
r0
 = 
u
.
u_îr‹
;

128 
out
;

130 
i
 = 
SIGSYS
;

142 
	`psig«l
(
u
.
u_¥o˝
, 
SIGFPT
);

145 8+
USER
:

146 
i
 = 
SIGFPT
;

159 9+
USER
:

160 
a
 = 
•
;

161 if(
	`backup
(
u
.
u_¨0
) == 0)

162 if(
	`grow
(
a
))

163 
out
;

164 
i
 = 
SIGSEG
;

167 
	`psig«l
(
u
.
u_¥o˝
, 
i
);

169 
out
:

170 if(
	`issig
())

171 
	`psig
();

172 
	`£çri
(
u
.
u_¥o˝
);

173 
	}
}

189 
	$å≠1
(
f
)

190 (*
f
)();

193 
u
.
u_ötÊg
 = 1;

194 
	`ßvu
(
u
.
u_qßv
);

195 (*
f
)();

196 
u
.
u_ötÊg
 = 0;

197 
	}
}

202 
	$nosys
()

204 
u
.
u_îr‹
 = 100;

205 
	}
}

210 
	$nuŒsys
()

212 
	}
}

	@param.h

5 
	#NBUF
 15

	)

6 
	#NINODE
 100

	)

7 
	#NFILE
 100

	)

8 
	#NMOUNT
 5

	)

9 
	#NEXEC
 3

	)

10 
	#MAXMEM
 (64*32Ë

	)

11 
	#SSIZE
 20

	)

12 
	#SINCR
 20

	)

13 
	#NOFILE
 15

	)

14 
	#CANBSIZ
 256

	)

15 
	#CMAPSIZ
 100

	)

16 
	#SMAPSIZ
 100

	)

17 
	#NCALL
 20

	)

18 
	#NPROC
 50

	)

19 
	#NTEXT
 40

	)

20 
	#NCLIST
 100

	)

21 
	#HZ
 60

	)

29 
	#PSWP
 -100

	)

30 
	#PINOD
 -90

	)

31 
	#PRIBIO
 -50

	)

32 
	#PPIPE
 1

	)

33 
	#PWAIT
 40

	)

34 
	#PSLEP
 90

	)

35 
	#PUSER
 100

	)

42 
	#NSIG
 20

	)

43 
	#SIGHUP
 1

	)

44 
	#SIGINT
 2

	)

45 
	#SIGQIT
 3

	)

46 
	#SIGINS
 4

	)

47 
	#SIGTRC
 5

	)

48 
	#SIGIOT
 6

	)

49 
	#SIGEMT
 7

	)

50 
	#SIGFPT
 8

	)

51 
	#SIGKIL
 9

	)

52 
	#SIGBUS
 10

	)

53 
	#SIGSEG
 11

	)

54 
	#SIGSYS
 12

	)

55 
	#SIGPIPE
 13

	)

62 
	#USIZE
 16

	)

63 
	#NULL
 0

	)

64 
	#NODEV
 (-1)

	)

65 
	#ROOTINO
 1

	)

66 
	#DIRSIZ
 14

	)

74 
	mlobyã
;

75 
	mhibyã
;

83 
	möãg
;

89 
	#PS
 0177776

	)

90 
	#KL
 0177560

	)

91 
	#SW
 0177570

	)

	@proc.h

9 
	s¥oc


11 
	mp_°©
;

12 
	mp_Êag
;

13 
	mp_¥i
;

14 
	mp_sig
;

15 
	mp_uid
;

16 
	mp_time
;

17 
	mp_˝u
;

18 
	mp_ni˚
;

19 
	mp_âyp
;

20 
	mp_pid
;

21 
	mp_µid
;

22 
	mp_addr
;

23 
	mp_size
;

24 
	mp_wch™
;

25 *
	mp_ãxç
;

26 } 
	g¥oc
[
NPROC
];

29 
	#SSLEEP
 1

	)

30 
	#SWAIT
 2

	)

31 
	#SRUN
 3

	)

32 
	#SIDL
 4

	)

33 
	#SZOMB
 5

	)

34 
	#SSTOP
 6

	)

37 
	#SLOAD
 01

	)

38 
	#SSYS
 02

	)

39 
	#SLOCK
 04

	)

40 
	#SSWAP
 010

	)

41 
	#STRC
 020

	)

42 
	#SWTED
 040

	)

	@reg.h

6 
	#R0
 (0)

	)

7 
	#R1
 (-2)

	)

8 
	#R2
 (-9)

	)

9 
	#R3
 (-8)

	)

10 
	#R4
 (-7)

	)

11 
	#R5
 (-6)

	)

12 
	#R6
 (-3)

	)

13 
	#R7
 (1)

	)

14 
	#RPS
 (2)

	)

16 
	#TBIT
 020

	)

	@seg.h

5 
	#UISD
 0177600

	)

6 
	#UISA
 0177640

	)

7 
	#UDSA
 0177660

	)

8 
	#RO
 02

	)

9 
	#WO
 04

	)

10 
	#RW
 06

	)

11 
	#ED
 010

	)

19 
	mr
[];

21 *
	gka6
;

26 
	#UBMAP
 0170200

	)

	@systm.h

6 
	gˇn⁄b
[
CANBSIZ
];

7 
	gc‹em≠
[
CMAPSIZ
];

8 
	gsw≠m≠
[
SMAPSIZ
];

9 *
	groŸdú
;

10 
	g˝uty≥
;

11 
	gexe˙t
;

12 
	glbﬁt
;

13 
	gtime
[2];

14 
	gtout
[2];

24 
	sˇŒo


26 
	mc_time
;

27 
	mc_¨g
;

28 (*
	mc_func
)();

29 } 
	gˇŒout
[
NCALL
];

35 
	smou¡


37 
	mm_dev
;

38 *
	mm_buÂ
;

39 *
	mm_öodp
;

40 } 
	gmou¡
[
NMOUNT
];

41 
	gmpid
;

42 
	grunö
;

43 
	grunout
;

44 
	gruƒun
;

45 
	gcuΩri
;

46 
	gmaxmem
;

47 *
	glks
;

48 
	groŸdev
;

49 
	gsw≠dev
;

50 
	gsw∂o
;

51 
	gnsw≠
;

52 
	gupdlock
;

53 
	gøblock
;

54 
	gªgloc
[];

	@text.h

7 
	sãxt


9 
	mx_daddr
;

10 
	mx_ˇddr
;

11 
	mx_size
;

12 *
	mx_ùå
;

13 
	mx_cou¡
;

14 
	mx_ccou¡
;

15 } 
	gãxt
[
NTEXT
];

	@tty.h

9 
	s˛i°


11 
	mc_cc
;

12 
	mc_cf
;

13 
	mc_˛
;

26 
	sây


28 
˛i°
 
	mt_øwq
;

29 
˛i°
 
	mt_ˇnq
;

30 
˛i°
 
	mt_outq
;

31 
	mt_Êags
;

32 *
	mt_addr
;

33 
	mt_dñ˘
;

34 
	mt_cﬁ
;

35 
	mt_îa£
;

36 
	mt_kûl
;

37 
	mt_°©e
;

38 
	mt_ch¨
;

39 
	mt_•ìds
;

40 
	mt_dev
;

43 
	g∑πab
[];

45 
	#TTIPRI
 10

	)

46 
	#TTOPRI
 20

	)

48 
	#CERASE
 '#'

	)

49 
	#CEOT
 004

	)

50 
	#CKILL
 '@'

	)

51 
	#CQUIT
 034

	)

52 
	#CINTR
 0177

	)

55 
	#TTHIWAT
 50

	)

56 
	#TTLOWAT
 30

	)

57 
	#TTYHOG
 256

	)

60 
	#HUPCL
 01

	)

61 
	#XTABS
 02

	)

62 
	#LCASE
 04

	)

63 
	#ECHO
 010

	)

64 
	#CRMOD
 020

	)

65 
	#RAW
 040

	)

66 
	#ODDP
 0100

	)

67 
	#EVENP
 0200

	)

68 
	#NLDELAY
 001400

	)

69 
	#TBDELAY
 006000

	)

70 
	#CRDELAY
 030000

	)

71 
	#VTDELAY
 040000

	)

74 
	#DONE
 0200

	)

75 
	#IENABLE
 0100

	)

78 
	#TIMEOUT
 01

	)

79 
	#WOPEN
 02

	)

80 
	#ISOPEN
 04

	)

81 
	#SSTART
 010

	)

82 
	#CARR_ON
 020

	)

83 
	#BUSY
 040

	)

84 
	#ASLEEP
 0100

	)

	@user.h

14 
	su£r


16 
	mu_rßv
[2];

17 
	mu_fßv
[25];

19 
	mu_£gÊg
;

20 
	mu_îr‹
;

21 
	mu_uid
;

22 
	mu_gid
;

23 
	mu_ruid
;

24 
	mu_rgid
;

25 
	mu_¥o˝
;

26 *
	mu_ba£
;

27 *
	mu_cou¡
;

28 *
	mu_off£t
[2];

29 *
	mu_cdú
;

30 
	mu_dbuf
[
DIRSIZ
];

31 *
	mu_dúp
;

33 
	mu_öo
;

34 
	mu_«me
[
DIRSIZ
];

35 } 
	mu_dít
;

36 *
	mu_pdú
;

37 
	mu_uiß
[16];

38 
	mu_uisd
[16];

39 
	mu_ofûe
[
NOFILE
];

40 
	mu_¨g
[5];

41 
	mu_tsize
;

42 
	mu_dsize
;

43 
	mu_ssize
;

44 
	mu_£p
;

45 
	mu_qßv
[2];

46 
	mu_sßv
[2];

47 
	mu_sig«l
[
NSIG
];

48 
	mu_utime
;

49 
	mu_°ime
;

50 
	mu_cutime
[2];

51 
	mu_c°ime
[2];

52 *
	mu_¨0
;

53 
	mu_¥of
[4];

54 
	mu_ötÊg
;

59 } 
	gu
;

62 
	#EFAULT
 106

	)

63 
	#EPERM
 1

	)

64 
	#ENOENT
 2

	)

65 
	#ESRCH
 3

	)

66 
	#EINTR
 4

	)

67 
	#EIO
 5

	)

68 
	#ENXIO
 6

	)

69 
	#E2BIG
 7

	)

70 
	#ENOEXEC
 8

	)

71 
	#EBADF
 9

	)

72 
	#ECHILD
 10

	)

73 
	#EAGAIN
 11

	)

74 
	#ENOMEM
 12

	)

75 
	#EACCES
 13

	)

76 
	#ENOTBLK
 15

	)

77 
	#EBUSY
 16

	)

78 
	#EEXIST
 17

	)

79 
	#EXDEV
 18

	)

80 
	#ENODEV
 19

	)

81 
	#ENOTDIR
 20

	)

82 
	#EISDIR
 21

	)

83 
	#EINVAL
 22

	)

84 
	#ENFILE
 23

	)

85 
	#EMFILE
 24

	)

86 
	#ENOTTY
 25

	)

87 
	#ETXTBSY
 26

	)

88 
	#EFBIG
 27

	)

89 
	#ENOSPC
 28

	)

90 
	#ESPIPE
 29

	)

91 
	#EROFS
 30

	)

92 
	#EMLINK
 31

	)

93 
	#EPIPE
 32

	)

	@
1
.
1
/usr/include
61
588
buf.h
conf.h
conf/mkconf.c
conf/sysfix.c
dmr/bio.c
dmr/cat.c
dmr/dc.c
dmr/dh.c
dmr/dhdm.c
dmr/dhfdm.c
dmr/dn.c
dmr/dp.c
dmr/hp.c
dmr/hs.c
dmr/ht.c
dmr/kl.c
dmr/lp.c
dmr/mem.c
dmr/partab.c
dmr/pc.c
dmr/rf.c
dmr/rk.c
dmr/rp.c
dmr/sys.c
dmr/tc.c
dmr/tm.c
dmr/tty.c
dmr/vs.c
dmr/vt.c
file.h
filsys.h
ino.h
inode.h
ken/alloc.c
ken/clock.c
ken/fio.c
ken/iget.c
ken/main.c
ken/malloc.c
ken/nami.c
ken/pipe.c
ken/prf.c
ken/rdwri.c
ken/sig.c
ken/slp.c
ken/subr.c
ken/sys1.c
ken/sys2.c
ken/sys3.c
ken/sys4.c
ken/sysent.c
ken/text.c
ken/trap.c
param.h
proc.h
reg.h
seg.h
systm.h
text.h
tty.h
user.h
